# This makefile is to be available (as a symlink) at the root of a native US-Web
# installation (hence typically in the 'us_web-native' root directory), whereas
# it is defined in us_web/conf/GNUmakefile-for-native-root.


.PHONY: all update rebuild clean build


CEYLAN_REPOSITORIES := myriad leec wooper traces
US_REPOSITORIES := us_common us_web

OUR_REPOSITORIES := $(CEYLAN_REPOSITORIES) $(US_REPOSITORIES)

# Preferred in-order:
ALL_REPOSITORIES := $(CEYLAN_REPOSITORIES) cowboy $(US_REPOSITORIES)


all: pull rebuild


# Updates all repositories involved:
pull:
	@echo "  Updating (pulling) sources from all repositories involved"
	@for r in $(ALL_REPOSITORIES); do ( echo " - pulling $$r" ; cd $$r && git pull ) || exit 5 ; done


# Note that, after a sync done through the 'sync-us-web' target, on the server,
# for a module X, X.erl and X.beam are likely to bear the same timestamp, so a
# mere 'build' may not attempt to recreate the transferred X.beam, whereas it
# might be obsolete from the start, compared to the X.erl.
#
# So 'rebuild' is a safer target than 'build', and BEAM files shall not be
# rsync'ed. However, as the target tree is generally owned by a different user
# then the user performing, on the client side, the rsync, the timestamps of the
# rsync'ed files are not updated anymore (as otherwise that operation is bound
# to fail) and thus shall not be relied upon.
#
# As a consequence, prefer rebuilding to building, or ensure to rsync'ed BEAM
#  files that are up-to-date (which the sync targets try to do).
#
rebuild: clean build


# We do not clean/build cowboy anymore as a version thereof is not supposed to
# change.

# (unset is for Cowboy, if even included, as it is potentially troubled by an
# unrelated define)
#
clean:
	@echo "  Cleaning all our (Ceylan and US) repositories involved"
	@for r in $(OUR_REPOSITORIES) $(); do ( unset SP ; echo " - cleaning $$r" ; cd $$r && $(MAKE) -s clean ) || exit 10 ; done


# (unset is for Cowboy, if even included, as it is potentially troubled by an
# unrelated define)
#
build:
	@echo "  Building (if necessary) all our (Ceylan and US) repositories involved"
	@for r in $(OUR_REPOSITORIES); do ( unset SP ; echo " - building $$r" ; cd $$r && $(MAKE) -s all ) || exit 15 ; done