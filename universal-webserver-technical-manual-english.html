<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.16: http://docutils.sourceforge.net/" />
<title>Welcome to the Universal Webserver documentation</title>
<meta content="Universal Webserver" name="keywords" />
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="us-web.css" type="text/css" />
<link href="us-web-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document">


<span class="target" id="top"></span><p><span class="raw-html"><a name="universal-webserver_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Universal Webserver documentation</em> <a href="http://us-web.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/us-web/index.html">browse mirror</a> <a href="universal-webserver-technical-manual-english.pdf">get PDF</a> <a href="#universal-webserver_top">go to top</a> <a href="#universal-webserver_bottom">go to bottom</a> <a href="mailto:about(dash)universal-webserver(at)esperide(dot)com?subject=[Universal%20Webserver]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="us-web-title.png" width="70%"></img></center></span>
</p>
<div class="section" id="technical-manual-of-the-universal-webserver">
<h1><a class="toc-backref" href="#id54">Technical Manual of the <tt class="docutils literal">Universal Webserver</tt></a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body"><p class="first">Copyright (C) 2019-2020 Olivier Boudeville</p>
</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><p class="first">about (dash) universal-webserver (at) esperide (dot) com</p>
</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body"><p class="first">Saturday, May 2, 2020</p>
</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body"><p class="first">Saturday, October 24, 2020</p>
</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body"><p class="first">Work in progress</p>
</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body"><p class="first">0.0.10</p>
</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body"><p class="first">Users and maintainers of the <tt class="docutils literal">Universal Webserver</tt>.</p>
</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body"><p class="first">The <a class="reference external" href="http://us-web.esperide.org/">Universal Webserver</a>, part of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">Universal Server</a> umbrella project, provides a multi-domain, multi-virtualhost webserver integrating various web-related services.</p>
<p>We present here a short overview of these services, to introduce them to newcomers.</p>
<p class="last">The next level of information is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">source files</a>, which are intensely commented and generally straightforward.</p>
</td>
</tr>
</tbody>
</table>
<p></p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#technical-manual-of-the-universal-webserver" id="id54">Technical Manual of the <tt class="docutils literal">Universal Webserver</tt></a><ul>
<li><a class="reference internal" href="#overview" id="id55">Overview</a></li>
<li><a class="reference internal" href="#easy-testing-of-us-web" id="id56">Easy Testing of US-Web</a></li>
<li><a class="reference internal" href="#layer-stack" id="id57">Layer Stack</a></li>
<li><a class="reference internal" href="#server-deployment" id="id58">Server Deployment</a></li>
<li><a class="reference internal" href="#configuring-the-universal-webserver" id="id59">Configuring the Universal-Webserver</a><ul>
<li><a class="reference internal" href="#in-a-development-setting" id="id60">In a Development Setting</a></li>
<li><a class="reference internal" href="#in-a-production-setting" id="id61">In a Production Setting</a></li>
<li><a class="reference internal" href="#configuration-files" id="id62">Configuration Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-the-universal-webserver" id="id63">Running the Universal-Webserver</a><ul>
<li><a class="reference internal" href="#stopping-any-prior-instance-first" id="id64">Stopping any prior instance first</a></li>
<li><a class="reference internal" href="#launching-the-us-web-server" id="id65">Launching the US-Web Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-the-us-web-server" id="id66">Monitoring the US-Web Server</a><ul>
<li><a class="reference internal" href="#local-monitoring" id="id67">Local Monitoring</a></li>
<li><a class="reference internal" href="#remote-monitoring" id="id68">Remote Monitoring</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extra-features" id="id69">Extra Features</a><ul>
<li><a class="reference internal" href="#auto-generated-meta-website" id="id70">Auto-generated Meta Website</a></li>
<li><a class="reference internal" href="#icon-favicon-management" id="id71">Icon (favicon) Management</a></li>
<li><a class="reference internal" href="#css-management" id="id72">CSS Management</a></li>
<li><a class="reference internal" href="#error-404-management" id="id73">Error 404 Management</a></li>
<li><a class="reference internal" href="#site-customisation" id="id74">Site Customisation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-recommendations" id="id75">Usage Recommendations</a></li>
<li><a class="reference internal" href="#licence" id="id76">Licence</a></li>
<li><a class="reference internal" href="#current-stable-version-download" id="id77">Current Stable Version &amp; Download</a><ul>
<li><a class="reference internal" href="#using-cutting-edge-git" id="id78">Using Cutting-Edge GIT</a></li>
<li><a class="reference internal" href="#otp-considerations" id="id79">OTP Considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting" id="id80">Troubleshooting</a></li>
<li><a class="reference internal" href="#hints" id="id81">Hints</a><ul>
<li><a class="reference internal" href="#development-vs-production-mode" id="id82">Development vs Production Mode</a></li>
<li><a class="reference internal" href="#development-hints" id="id83">Development Hints</a></li>
<li><a class="reference internal" href="#configuration-hints" id="id84">Configuration Hints</a></li>
<li><a class="reference internal" href="#execution-hints" id="id85">Execution Hints</a></li>
<li><a class="reference internal" href="#monitoring-hints" id="id86">Monitoring Hints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#standard-log-generation-analysis" id="id87">Standard Log Generation &amp; Analysis</a><ul>
<li><a class="reference internal" href="#web-analytics-software-choice-of-tool" id="id88">Web Analytics Software: Choice of Tool</a></li>
<li><a class="reference internal" href="#log-format" id="id89">Log Format</a></li>
<li><a class="reference internal" href="#awstats-management" id="id90">Awstats Management</a></li>
<li><a class="reference internal" href="#geolocation-with-awstats" id="id91">Geolocation with Awstats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#managing-public-key-certificates" id="id92">Managing Public-Key Certificates</a><ul>
<li><a class="reference internal" href="#x-509-certificates" id="id93">X.509 Certificates</a></li>
<li><a class="reference internal" href="#let-s-encrypt" id="id94">Let's Encrypt</a></li>
<li><a class="reference internal" href="#us-web-mode-of-operation" id="id95">US-Web Mode of Operation</a></li>
<li><a class="reference internal" href="#settings" id="id96">Settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#planned-enhancements" id="id97">Planned Enhancements</a></li>
<li><a class="reference internal" href="#about-nitrogen-future-support" id="id98">About Nitrogen (future) Support</a></li>
<li><a class="reference internal" href="#support" id="id99">Support</a></li>
<li><a class="reference internal" href="#please-react" id="id100">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="id101">Ending Word</a></li>
</ul>
</li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id55">Overview</a></h2>
<p>We present here a short overview of the services offered by the <em>Universal Webserver</em>, to introduce them to newcomers.</p>
<p>The goal of <strong>US-Web</strong> is to provide an integrated, extensible web framework in order:</p>
<ul class="simple">
<li>to better operate websites based on <a class="reference external" href="https://en.wikipedia.org/wiki/Virtual_hosting">virtual hosting</a>, so that a networked computer can serve as many websites corresponding to as many domains as wanted; this involves reading and interpreting vhost and other configuration information, handling properly 404 errors, producing access logs that are adequate for web analytics, rotating all logs, using/generating/renewing certificates, etc.</li>
<li>to link to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">Universal Server</a> optionally (i.e. if available, knowing both should be able to run in the absence of the other), in order to offer a web front-end for it</li>
</ul>
<p>Beyond this document, the next level of information about US-Web is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">source files</a>, which are intensely commented and generally straightforward.</p>
</div>
<div class="section" id="easy-testing-of-us-web">
<h2><a class="toc-backref" href="#id56">Easy Testing of US-Web</a></h2>
<p>Provided that no server already runs at TCP port #8080, just downloading the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/get-us-web-from-sources.sh">get-us-web-from-sources.sh</a> script and running it with no specific parameter should suffice.</p>
<p>It should clone, build and run a test server, that should be available at <a class="reference external" href="`http://localhost:8080">http://localhost:8080</a>.</p>
</div>
<div class="section" id="layer-stack">
<h2><a class="toc-backref" href="#id57">Layer Stack</a></h2>
<p>From the highest level to the lowest, as summarised <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">here</a>, a (free software) stack involving the Universal Webserver usually comprises:</p>
<ul class="simple">
<li>the <em>Universal Webserver</em> services themselves (i.e. this <a class="reference external" href="http://us-web.esperide.org/">US-Web</a> layer)</li>
<li><a class="reference external" href="https://github.com/ninenines/cowboy">Cowboy</a> (for a small, fast and modern web framework)</li>
<li>[optional] <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang/">LEEC</a> (for the management of Let's Encrypt certificates)</li>
<li>[optional] <a class="reference external" href="http://www.awstats.org/">Awstats</a> (for the analysis of access log files)</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a> (for US base facilities)</li>
<li><a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> (for advanced runtime traces)</li>
<li><a class="reference external" href="http://wooper.esperide.org">Ceylan-WOOPER</a> (for OOP)</li>
<li><a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> (as a general-purpose Erlang toolbox)</li>
<li><a class="reference external" href="http://erlang.org">Erlang/OTP</a> (for the compiler and runtime)</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Linux">GNU/Linux</a> (for a suitable, reliable operating system of course)</li>
</ul>
<p>The shorthand for the <tt class="docutils literal">Universal Webserver</tt> (a.k.a. <tt class="docutils literal"><span class="pre">US-Web</span></tt>) is <tt class="docutils literal">uw</tt>.</p>
<p></p>
</div>
<div class="section" id="server-deployment">
<h2><a class="toc-backref" href="#id58">Server Deployment</a></h2>
<p>For that, the <tt class="docutils literal">prod</tt> profile defined in the context of <tt class="docutils literal">rebar3</tt> shall be used.</p>
<p>Currently we prefer re-using the (supposedly already installed) local Erlang environment on the server (to be shared across multiple services), so by default ERTS is <em>not</em> included in a US-Web release.</p>
<p>Sources are not included either, as we prefer re-rolling a release to editing and compiling code directly on a server.</p>
<p>To generate from scratch such a (mostly) standalone release, one may use:</p>
<pre class="literal-block">
$ make release-prod
</pre>
<p>It should generate a tarball such as <tt class="docutils literal"><span class="pre">us_web-x.y.z.tar.gz</span></tt></p>
<p>The <tt class="docutils literal"><span class="pre">export-release</span></tt> make target allows in the same movement to lightly update a pre-existing release and also to transfer it to any target server, designated by setting the <tt class="docutils literal">WEB_SRV</tt> (make or environment) variable to the FQDN of this server.</p>
<p>So we recommend running:</p>
<pre class="literal-block">
$ make export-release
 Generating rebar3 us_web.app file
 Compiling us_web from XXX/us_web
 ===&gt; Verifying dependencies...
 ===&gt; Compiling myriad
 Hiding unsupported sources
 Populating the include symlinks
 [...]
</pre>
<p>We recommend installing a release in <tt class="docutils literal"><span class="pre">REL_BASE_ROOT=/opt/universal-server</span></tt>:</p>
<pre class="literal-block">
$ mv /tmp/us_web-x.y.z.tar.gz ${REL_BASE_ROOT}
$ cd ${REL_BASE_ROOT}
$ tar xvf us_web-x.y.z.tar.gz
</pre>
<p>Then various steps are necessary in order to have a functional release running satisfactorily.</p>
<p>We automated the full deployment process of US-Web on a server for that: once the release has been transferred to that server (possibly thanks to the aforementioned <tt class="docutils literal"><span class="pre">export-release</span></tt> target, possibly to the <tt class="docutils literal">/tmp</tt> directory of that server), one may rely on our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-release.sh">deploy-us-web-release.sh</a> script. One may also just take inspiration from it in order to devise one's deployment scheme.</p>
<p>Let's say from now on that the UNIX name chosen for the US user is <tt class="docutils literal"><span class="pre">us-user</span></tt>, the one of the US-web user is <tt class="docutils literal"><span class="pre">us-web-user</span></tt> and the US group (containing both users, and possibly only them) is <tt class="docutils literal"><span class="pre">us-group</span></tt> (one should keep in mind that <tt class="docutils literal"><span class="pre">US-Web</span></tt> is a specialization of the <tt class="docutils literal">US</tt> framework).</p>
<p>Using that script boils down to running, as root:</p>
<pre class="literal-block">
$ /tmp/deploy-us-web-release.sh
Detected US-Web version: 'x.y.z'.
Trying to stop gracefully any prior release in us_web-x.y.z.
Removing already-existing us_web-x.y.z.
US-Web release ready in '/opt/universal-server/us_web-x.y.z/bin/us_web'.
Changing, from '/opt/universal-server/us_web-x.y.z', the owner of release
files to 'us-web-user' and their group to 'us-group'.
(no auto-launch enabled)
</pre>
<p>Note that the goal of that deployment phase is to start from a clean state, and as such it will try to stop any already running US-Web instance (for all possible versions thereof).</p>
<p>Then US-Web is fully <em>deployed</em>. Once properly <em>configured</em>, it will be able to be <em>launched</em> for good.</p>
<p>Some related information are specified below.</p>
</div>
</div>
<div class="section" id="configuring-the-universal-webserver">
<h2><a class="toc-backref" href="#id59">Configuring the Universal-Webserver</a></h2>
<p>As explained in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/start-us-web.sh">start-us-web.sh</a> and in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USWebConfigServer.erl">class_USWebConfigServer.erl</a>, the US configuration files will be searched through various locations.</p>
<p>The main, overall US configuration file, <tt class="docutils literal">us.config</tt>, is found based on a series of directories that are gone through in an orderly manner; the first directory to host such a file becomes <em>the</em> (single) US configuration directory.</p>
<p>The other US-related configuration files (ex: any <tt class="docutils literal"><span class="pre">us-web.config</span></tt>) are referenced directly from the main one (<tt class="docutils literal">us.config</tt>), designated there through specific keys (ex: <tt class="docutils literal">us_web_config_filename</tt>); they may be either absolutely defined, or relatively to the aforementioned US configuration directory.</p>
<p>Let's name <tt class="docutils literal">US_CFG_ROOT</tt> the actual directory in which they all lie; it is typically either <tt class="docutils literal"><span class="pre">~/.config/universal-server/</span></tt> (in development mode), or <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server/</span></tt> (in production mode).</p>
<p>Note that, as these files might contain sensitive information (ex: Erlang cookies), they shall be duly protected. Indeed, in terms of permissions, we should have <tt class="docutils literal">640</tt>, supposing that the <tt class="docutils literal">us.config</tt> designates, in its <tt class="docutils literal">us_web_config_filename</tt> entry, <tt class="docutils literal"><span class="pre">foobar-us-web-for-production.config</span></tt> as the name of the US-Web configuration file <a class="footnote-reference" href="#id4" id="id3">[1]</a>:</p>
<pre class="literal-block">
-rw-r----- 1 us-user     us-group [...] us.config
-rw-r----- 1 us-web-user us-group [...] foobar-us-web-for-production.config
</pre>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>They shall be in the same <tt class="docutils literal">US_CFG_ROOT</tt> directory (discussed below), and may be symbolic links.</td></tr>
</tbody>
</table>
<p>Finally, if being able to rely on multiple, different US configuration directories is necessary in order to be able to launch multiple US-Web instances (these configurations can then register the managers involved - typically the US-Web Configuration server - under different names), currently a single node can be used as, by default, such a node is named <tt class="docutils literal">us_web</tt> (two instances would then clash at this level).</p>
<div class="section" id="in-a-development-setting">
<h3><a class="toc-backref" href="#id60">In a Development Setting</a></h3>
<p>The US main configuration file, <tt class="docutils literal">us.config</tt>, is in a directory (<tt class="docutils literal">US_CFG_ROOT</tt>) that is <tt class="docutils literal"><span class="pre">~/.config/universal-server/</span></tt> here. This US-level configuration file will reference (through its <tt class="docutils literal">us_web_config_filename</tt> entry) a US-Web counterpart configuration file, probably in the same directory.</p>
<p>The US-Web configuration file may define a <tt class="docutils literal">us_web_app_base_dir</tt> entry. If not, this application directory will then be found thanks to the <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> environment variable (if defined, typically through one's <tt class="docutils literal"><span class="pre">~/.bashrc</span></tt>); otherwise, as a last resort, an attempt to guess it will be done.</p>
<p>The US webserver may be then run thanks to <tt class="docutils literal">make debug</tt>, from the relevant <tt class="docutils literal">us_web</tt> directory (typically the root of a GIT clone located in the user's directory).</p>
<p>In such a development context, in <tt class="docutils literal">us_web/conf/sys.config</tt>, we recommend to leave the batch mode disabled (just let the default <tt class="docutils literal">{is_batch,false}</tt>), so that a direct, graphical trace supervision is enabled (provided that a relevant trace supervisor is available, see <a class="reference external" href="http://traces.esperide.org/#trace-supervision-browsing">Ceylan-Traces</a> for that).</p>
</div>
<div class="section" id="in-a-production-setting">
<h3><a class="toc-backref" href="#id61">In a Production Setting</a></h3>
<p>The start/stop management scripts will be run initially as root (possibly through <tt class="docutils literal">systemd</tt>) and must access the <tt class="docutils literal">us.config</tt> file. Then, once run, <tt class="docutils literal">us_web</tt> will most probably switch to a dedicated user (see the <tt class="docutils literal">us_web_username</tt> entry in the US-Web configuration file), who will need in turn to be able to read the <tt class="docutils literal">us.config</tt> file and any related one (ex: for US-Web, here supposed to be named <tt class="docutils literal"><span class="pre">foobar-us-web-for-production.config</span></tt>).</p>
<p>As a result, a relevant configuration directory (denoted <tt class="docutils literal">US_CFG_ROOT</tt> in this document), in that shared setting, is the standard <tt class="docutils literal">/etc/xdg</tt> one, resulting in the <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt> directory to be used.</p>
<p>As mentioned, care must be taken so that <tt class="docutils literal">root</tt> and also the US and US-Web users can read the content of that directory - at least the US and US-Web configuration files in it - and that the other users cannot.</p>
<p>For that, a dedicated <tt class="docutils literal"><span class="pre">us-group</span></tt> group can be created, and any web user (ex: <tt class="docutils literal"><span class="pre">us-web-user</span></tt>) shall belong to that group. For example:</p>
<pre class="literal-block">
$ id us-web-user
uid=1002(us-web-user) gid=1002(us-web-user) groups=1002(us-web-user),
 1007(us-group)
</pre>
<p>Then, in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>, for the US and US-Web configuration files:</p>
<pre class="literal-block">
$ chown us-user us.config
$ chown us-web-user foobar-us-web-for-production.config

$ us_files=&quot;us.config foobar-us-web-for-production.config&quot;
$ chgrp us-group ${us_files}
$ chmod 640 ${us_files}

$ chgrp us-group /etc/xdg/universal-server
$ chmod 700 /etc/xdg/universal-server
</pre>
<p>We recommend directly setting the <tt class="docutils literal">us_web_app_base_dir</tt> configuration entry to the relevant, absolute path.</p>
<p>Let's name here <tt class="docutils literal">US_WEB_REL_ROOT</tt> the root of the US-Web release of interest (ex: corresponding to <tt class="docutils literal"><span class="pre">${REL_BASE_ROOT}/us_web-latest/</span></tt>) and <tt class="docutils literal">US_WEB_APP_ROOT</tt> the root of the corresponding US-Web application (ex: corresponding to <tt class="docutils literal"><span class="pre">${US_WEB_REL_ROOT}/lib/us_web-latest/</span></tt>).</p>
<p>A <tt class="docutils literal">systemd</tt> service shall be declared for US-Web, in <tt class="docutils literal">/etc/systemd/system</tt>; creating there, as root, a symbolic link to <tt class="docutils literal"><span class="pre">${US_WEB_APP_ROOT}/priv/conf/us-web.service</span></tt> will suffice.</p>
<p>This service requires <tt class="docutils literal"><span class="pre">start-us-web.sh</span></tt> and <tt class="docutils literal"><span class="pre">stop-us-web.sh</span></tt>. Adding for user convenience <tt class="docutils literal"><span class="pre">get-us-web-status.sh</span></tt>, they should all be symlinked that way, still as root:</p>
<pre class="literal-block">
$ cd /usr/local/bin
$ for f in start-us-web.sh stop-us-web.sh get-us-web-status.sh; \
  do ln -s ${US_WEB_APP_ROOT}/priv/bin/$f ; done
</pre>
<p>The log base directory (see the <tt class="docutils literal">log_base_directory</tt> entry) shall be created and writable; for example:</p>
<pre class="literal-block">
$ LOG_DIR=/var/log/universal-server
$ mkdir -p ${LOG_DIR}
$ chown us-user ${LOG_DIR}
$ chgrp us-group ${LOG_DIR}
$ chmod 770 ${LOG_DIR}
</pre>
<p>In such a production context, in <tt class="docutils literal">sys.config</tt> (typically located in <tt class="docutils literal"><span class="pre">${US_WEB_REL_ROOT}/releases/latest-release</span></tt>), we recommend to enable batch mode (just set <tt class="docutils literal">{is_batch,true}</tt>), so that by default no direct, graphical trace supervision is triggered (a server usually does not have a X server anyway).</p>
<p>Instead the traces may then be supervised and browsed remotely (at any time, and any number of times), from a graphical client (provided that a relevant trace supervisor is available locally, see <a class="reference external" href="http://traces.esperide.org/#trace-supervision-browsing">Ceylan-Traces</a> for that), by running the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/monitor-us-web.sh">monitor-us-web.sh</a> script.</p>
<p>For that the relevant settings (notably which server host shall be targeted, with what cookie) shall be stored in that client, in a <tt class="docutils literal"><span class="pre">us-monitor.config</span></tt> file that is typically located in the <tt class="docutils literal"><span class="pre">~/.config/universal-server</span></tt> directory.</p>
</div>
<div class="section" id="configuration-files">
<h3><a class="toc-backref" href="#id62">Configuration Files</a></h3>
<p>A <tt class="docutils literal">us.config</tt> file referencing a suitable US-Web configuration file will be needed; most of the behaviour of the US-Web server is determined by this last configuration file.</p>
<p>As the US-related configuration files are heavily commented, proceeding based on examples in the simplest approach <a class="footnote-reference" href="#id8" id="id7">[2]</a>.</p>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td>The second best approach being to have directly a look at the code reading them, see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USConfigServer.erl">class_USConfigServer.erl</a> for us.config and <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USWebConfigServer.erl">class_USWebConfigServer.erl</a> for its US-Web counterpart.</td></tr>
</tbody>
</table>
<p>Refer for that at this (US) <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">us.config example</a> and at this <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">US-Web counterpart example</a>.</p>
</div>
</div>
<div class="section" id="running-the-universal-webserver">
<h2><a class="toc-backref" href="#id63">Running the Universal-Webserver</a></h2>
<p>Note that the Erlang versions used to produce the release (typically in a development computer) and run it (typically in a production server) must match (we prefer using <em>exactly</em> the same version).</p>
<p>Supposing a vhost to be served by US-Web is <tt class="docutils literal">baz.foobar.org</tt>, to avoid being confused by your browser, a better way is to test whether a US-Web instance is already running thanks to <tt class="docutils literal">wget</tt> or <tt class="docutils literal">links</tt>:</p>
<pre class="literal-block">
$ wget http://baz.foobar.org -O -
</pre>
<p>This will display the fetched content directly on the console (not creating a file).</p>
<p>Indeed, when testing a website, fully-fledged browsers such as Firefox may be quite misleading as they may attempt to hide issues, and tend to cache a lot of information (not actually reloading the current page), even if the user held Shift and clicked on &quot;Reload&quot;. Do not trust browsers!</p>
<p>One may disable temporarily the cache by opening the developer toolbox (<tt class="docutils literal">Ctrl+Shift+I</tt> or <tt class="docutils literal">Cmd+Opt+I</tt> on Mac), clicking on the settings button (near the top right), scrolling down to the <tt class="docutils literal">Advanced settings</tt> (on the bottom right), checking the option <tt class="docutils literal">Disable Cache (when toolbox is open)</tt> and refreshing the page. <tt class="docutils literal">wget</tt> may still be a better, simpler, more reliable solution.</p>
<div class="section" id="stopping-any-prior-instance-first">
<h3><a class="toc-backref" href="#id64">Stopping any prior instance first</a></h3>
<p>From now on, we will suppose the current directory is <tt class="docutils literal">US_WEB_APP_ROOT</tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">stop-us-web.sh</span></tt> script can be used for stopping a US-Web release, typically simply as:</p>
<pre class="literal-block">
$ priv/bin/stop-us-web.sh
</pre>
<p>In development mode, still from the root of US-Web, one might use <tt class="docutils literal">make <span class="pre">stop-brutal</span></tt> to operate regardless of dynamically-changed cookies, while in a production setting one would go preferably for:</p>
<pre class="literal-block">
$ systemctl stop us-web.service
</pre>
</div>
<div class="section" id="launching-the-us-web-server">
<h3><a class="toc-backref" href="#id65">Launching the US-Web Server</a></h3>
<p>In development mode, from the root of US-Web, one may use <tt class="docutils literal">make debug</tt>, while, in production mode, the US-Web server can be launched either with its dedicated script <tt class="docutils literal"><span class="pre">start-us-web.sh</span></tt> or, even better, directly through:</p>
<pre class="literal-block">
$ systemctl start us-web.service
</pre>
</div>
</div>
<div class="section" id="monitoring-the-us-web-server">
<h2><a class="toc-backref" href="#id66">Monitoring the US-Web Server</a></h2>
<div class="section" id="local-monitoring">
<h3><a class="toc-backref" href="#id67">Local Monitoring</a></h3>
<p>Here operations will be done directly on the server.</p>
<div class="section" id="overall-local-inquiry">
<h4>Overall Local Inquiry</h4>
<p>The <tt class="docutils literal"><span class="pre">get-us-web-status.sh</span></tt> script (still in <tt class="docutils literal">priv/bin</tt>, as all US-Web shell scripts) may then be used to investigate any problem in a streamlined, integrated way.</p>
<p>Alternate (yet often less convenient) solutions are to run <tt class="docutils literal">systemctl status <span class="pre">us-web.service</span></tt> or, often with better results, <tt class="docutils literal">journalctl <span class="pre">-xe</span> <span class="pre">--unit</span> <span class="pre">us-web.service</span> <span class="pre">--no-pager</span></tt> to get some insights.</p>
</div>
<div class="section" id="general-logs">
<h4>General Logs</h4>
<p>A deeper level of detail can be obtained by inspecting the <em>general</em> logs (as opposed to the <em>webserver</em> ones, discussed in next section), which regroup the VM-level, technical ones and/or the applicative ones.</p>
<p><strong>VM logs</strong> are written in the <tt class="docutils literal"><span class="pre">${REL_BASE_ROOT}/log</span></tt> directory (ex: <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-latest/log</span></tt>), which is created when the release is started first. Generally, <tt class="docutils literal">run_erl.log</tt> (if launched as a daemon) will not help much, whereas the latest Erlang log file (<tt class="docutils literal">ls <span class="pre">-lrt</span> erlang.log.*</tt>) is likely to contain relevant information.</p>
<p>As for our higher-level, <strong>applicative traces</strong>, they are stored in the the <tt class="docutils literal">us_web.traces</tt> file, in the directory defined in the <tt class="docutils literal">us_web_log_dir</tt> entry of the US-Web configuration file. This last file is specified in turn in the relevant <tt class="docutils literal">us.config</tt> configuration file (see the <tt class="docutils literal">us_web_config_filename</tt> key for that), which, in development mode, is itself typically found in <tt class="docutils literal"><span class="pre">~/.config/universal-server</span></tt> while, in production mode, is likely located in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>.</p>
<p>In practice, this trace file is generally found:</p>
<ul class="simple">
<li>in development mode, if testing, in <tt class="docutils literal"><span class="pre">priv/for-testing/log</span></tt>, relatively to the base directory specified in <tt class="docutils literal">us_app_base_dir</tt></li>
<li>in production mode, generally in <tt class="docutils literal"><span class="pre">/var/log/universal-server</span></tt> of <tt class="docutils literal"><span class="pre">/opt/universal-server</span></tt></li>
</ul>
<p>This path is updated at runtime once the US-Web configuration file is read; so typically it is renamed from <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z/traces_via_otp.traces</span></tt> to <tt class="docutils literal"><span class="pre">/var/log/universal-server/us_web.traces</span></tt>.</p>
</div>
<div class="section" id="webserver-logs">
<h4>Webserver Logs</h4>
<p>These logs, which are maybe less useful for troubleshooting, designate access and error logs, per virtual host (ex: for a virtual host <tt class="docutils literal">VH</tt>, <tt class="docutils literal"><span class="pre">access-for-VH.log</span></tt> and <tt class="docutils literal"><span class="pre">error-for-VH.log</span></tt>). Their previous versions are archived in timestamped, compressed files (ex: <tt class="docutils literal"><span class="pre">error-for-VH.Y-M-D-at-H-M-S.xz</span></tt>).</p>
<p>These files will be written in the directory designated by the <tt class="docutils literal">us_web_log_dir</tt> entry of the US-Web configuration file. Refer to the previous section to locate this file.</p>
</div>
</div>
<div class="section" id="remote-monitoring">
<h3><a class="toc-backref" href="#id68">Remote Monitoring</a></h3>
<p>Here the state of a US-Web instance will be inspected remotely, with no shell connection to its server.</p>
<p>First of all, is this US-Web instance available? Check with:</p>
<pre class="literal-block">
$ wget http://baz.foobar.org -O -
</pre>
<p>As for the applicative traces, they may be monitored remotely as well, thanks to the <tt class="docutils literal"><span class="pre">monitor-us-web.sh</span></tt> script.</p>
</div>
</div>
<div class="section" id="extra-features">
<h2><a class="toc-backref" href="#id69">Extra Features</a></h2>
<div class="section" id="auto-generated-meta-website">
<h3><a class="toc-backref" href="#id70">Auto-generated Meta Website</a></h3>
<p>If requested, at server start-up, a &quot;meta&quot; website - i.e. a website sharing information about all other websites being hosted by that server - can be generated and made available through a dedicated virtual host and web root.</p>
<p>For that, in the US-Web configuration file, among the user-specified <tt class="docutils literal">routes</tt>, one may add the following element in the list of virtual host entries associated to a given domain (ex: <tt class="docutils literal">foobar.org</tt>):</p>
<pre class="literal-block">
{&quot;mymeta&quot;, &quot;My-meta-generated&quot;, meta}
</pre>
<p>This will generate a suitable website in the <tt class="docutils literal"><span class="pre">My-meta-generated</span></tt> subdirectory of the default web root (as, here, the specified directory is not an absolute one), and this website will be available as <tt class="docutils literal">mymeta.foobar.org</tt> (of course both <tt class="docutils literal">mymeta</tt> and <tt class="docutils literal"><span class="pre">My-meta-generated</span></tt> are examples; these names can be freely chosen).</p>
<p>Currently no specific access control to this website is enforced (thus by default anyone knowing or able to guess its virtual hostname can access it).</p>
</div>
<div class="section" id="icon-favicon-management">
<h3><a class="toc-backref" href="#id71">Icon (favicon) Management</a></h3>
<p>This designates the little image that is displayed by browsers on the top of the tab of the website being visited.</p>
<p>A default icon file can be defined, it is notably used in order to generate better-looking 404 pages.</p>
<p>To do so, the <tt class="docutils literal">icon_path</tt> key in the US-Web handler state shall be set to the path of such file (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal"><span class="pre">common/default-icon.png</span></tt> exists (ex: obtained thanks to this kind of <a class="reference external" href="https://favicon.io/favicon-generator/">generator</a>), it is automatically registered in <tt class="docutils literal">icon_path</tt>.</p>
</div>
<div class="section" id="css-management">
<h3><a class="toc-backref" href="#id72">CSS Management</a></h3>
<p>A default CSS file can be defined, notably in order to generate better-looking 404 pages.</p>
<p>To do so, the <tt class="docutils literal">css_path</tt> key in the US-Web handler state shall be set to the path of such file (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal">common/default.css</tt> exists, it is automatically registered in <tt class="docutils literal">css_path</tt>.</p>
</div>
<div class="section" id="error-404-management">
<h3><a class="toc-backref" href="#id73">Error 404 Management</a></h3>
<p>Should some requested web page not be found:</p>
<ul class="simple">
<li>a suitable 404 page is automatically generated by the US-Web server, and returned to the caller</li>
<li>the error is appropriately logged</li>
</ul>
<p>A 404 image can be optionally displayed instead of the &quot;0&quot; of &quot;404&quot;. To do so, the <tt class="docutils literal">image_404</tt> key in the US-Web handler state shall be set to the path of such image (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal">images/404.png</tt> file exists, it is automatically registered in <tt class="docutils literal">image_404</tt>.</p>
</div>
<div class="section" id="site-customisation">
<h3><a class="toc-backref" href="#id74">Site Customisation</a></h3>
<p>As a summary of the sections above, if there is a file (regular or symbolic link), from the content root of a hosted static website, in:</p>
<ul class="simple">
<li><tt class="docutils literal">common/default.css</tt>, then this CSS will be used for all generated pages for that website (ex: the one for errors such as 404 ones)</li>
<li><tt class="docutils literal"><span class="pre">images/default-icon.png</span></tt>, then this image will be used as an icon (the small image put on browser tabs next to their labels) for all generated pages</li>
<li><tt class="docutils literal">images/404.png</tt>, then this image will be used for the &quot;0&quot; in the main &quot;404&quot; label of the page denoting a content not found</li>
</ul>
<p>Each content root is expected to contain at least a (proper) <tt class="docutils literal">index.html</tt> file (possibly as a symbolic link).</p>
</div>
</div>
<div class="section" id="usage-recommendations">
<h2><a class="toc-backref" href="#id75">Usage Recommendations</a></h2>
<p>In terms of security, we would advise:</p>
<ul class="simple">
<li>to stick to the <strong>latest stable version</strong> of all software involved (including US-Web and all its stack, Erlang, and the operating system itself)</li>
<li>to apply a streamlined, reproducible <strong>deployment process</strong>, preferably based on our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-release.sh">deploy-us-web-release.sh</a> script</li>
<li>to rely on dedicated, <strong>different, low-privileged users and groups</strong> for US and US-Web, which both rely on <tt class="docutils literal">authbind</tt>; refer to our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/start-us-web.sh">start-us-web.sh</a> script for that; see also the <tt class="docutils literal">us_username</tt> key of US-Common's <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">us.config</a>, and the <tt class="docutils literal">us_web_username</tt> key of the US-Web configuration file that it refers to</li>
<li>still in <tt class="docutils literal">us.config</tt>, to set:<ul>
<li>a strong-enough Erlang <strong>cookie</strong>: set the <tt class="docutils literal">vm_cookie</tt> key to a well-chosen value, possibly a random one deriving from an output of <tt class="docutils literal">uuidgen</tt></li>
<li>possibly a <strong>limited TCP port range</strong> (see the <tt class="docutils literal">tcp_port_range</tt> key)</li>
<li>the <strong>execution context</strong> to <tt class="docutils literal">production</tt> (see the <tt class="docutils literal">execution_context</tt> key)</li>
</ul>
</li>
<li>to use also the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/stop-us-web.sh">stop-us-web.sh</a> counterpart script, and to have them triggered through <tt class="docutils literal">systemd</tt>; we provide a corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/conf/us-web.service">us-web.service</a> <strong>unit file</strong> for that, typically to be placed in <tt class="docutils literal">/etc/systemd/system</tt> and whose <tt class="docutils literal">ExecStart/ExecStop</tt> paths shall preferably be symlinks pointing to the latest deployed US-Web release (ex: <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-latest</span></tt>)</li>
<li>to ensure that a <strong>firewall</strong> blocks everything from the Internet by default, including the EPMD port(s) (i.e. both the default Erlang one and any non-standard one specified through the <tt class="docutils literal">epmd_port</tt> key defined in <tt class="docutils literal">us.config</tt>); one may get inspiration from our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script for that</li>
<li>no need to advertise specifically a virtual host in your DNS; for example, so that a <tt class="docutils literal">baz.foobar.org</tt> is available, only <tt class="docutils literal">foobar.org</tt> has to be declared in the DNS records (even a <tt class="docutils literal">*.foobar.org</tt> wildcard is not necessary) for the corresponding website to be available; as a result, unless the full name of that virtual host is disclosed or a (typically brute-force) guessing succeeds, that virtual host will remain private by default (useful as a first level of protection, notably for any meta website)</li>
<li>to <strong>monitor regularly</strong> both:<ul>
<li>the US-Web server itself (see our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/monitor-us-web.sh">monitor-us-web.sh</a> script for that, relying on the trace supervisor provided by the <a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> layer)</li>
<li>the remote, browser-based, accesses made to the hosted websites, typically by enabling the US-Web &quot;meta&quot; feature, generating and updating automatically a dedicated website displaying in one page all hosted websites and linking to their web analysis report; refer to the <tt class="docutils literal">log_analysis</tt> key of the US-Web configuration file (ex: see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">us-web-for-tests.config</a> as an example thereof)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="licence">
<span id="free-software"></span><h2><a class="toc-backref" href="#id76">Licence</a></h2>
<p>The <tt class="docutils literal">Universal Webserver</tt> is licensed by its author (Olivier Boudeville) under the <a class="reference external" href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU Affero General Public License</a> as published by the Free Software Foundation, either version 3 of this license, or (at your option) any later version.</p>
<p>This allows the use of the Universal Webserver code in a wide a variety of software projects, while still maintaining copyleft on this code, ensuring improvements are shared.</p>
<p>We hope indeed that enhancements will be back-contributed (ex: thanks to merge requests), so that everyone will be able to benefit from them.</p>
</div>
<div class="section" id="current-stable-version-download">
<h2><a class="toc-backref" href="#id77">Current Stable Version &amp; Download</a></h2>
<p>As mentioned, the single, direct prerequisites of the <a class="reference external" href="https://github.com/Olivier-Boudeville/UniversalWebserver">Universal Webserver</a> are:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ninenines/cowboy">Cowboy</a> (version 2.8 or above)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang/">LEEC</a> as an optional, runtime-only dependency</li>
<li><a class="reference external" href="http://www.awstats.org/">Awstats</a> as an optional, runtime-only dependency (version 7.8 or above)</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a></li>
</ul>
<p>The latter relies on <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces">Ceylan-Traces</a>, which implies in turn <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-WOOPER">Ceylan-WOOPER</a>, then <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceylan-Myriad</a> and <a class="reference external" href="http://erlang.org">Erlang</a>.</p>
<p>We prefer using GNU/Linux, sticking to the latest stable release of Erlang, and building it from sources, thanks to GNU <tt class="docutils literal">make</tt>. We recommend indeed obtaining Erlang thanks to a manual installation; refer to the corresponding <a class="reference external" href="http://myriad.esperide.org#prerequisites">Myriad prerequisite section</a>  for more precise guidelines.</p>
<p>The build of the US-Web server is driven by <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, which can be obtained by following our <a class="reference external" href="http://myriad.esperide.org/#getting-rebar3">guidelines</a>.</p>
<p id="getting-awstats">If a tool for web analysis is needed (typically if enabling a meta website), this tool must be installed beforehand. Currently US-Web supports Awstats, which can be obtained thanks to your distribution of choice (ex for Arch Linux: <tt class="docutils literal">pacman <span class="pre">-S</span> awstats</tt> <a class="footnote-reference" href="#id23" id="id22">[3]</a>) .</p>
<table class="docutils footnote" frame="void" id="id23" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id22">[3]</a></td><td>To avoid a future reading access error, execute after installation: <tt class="docutils literal">chmod <span class="pre">-R</span> +r /usr/share/webapps/awstats/icon</tt>.</td></tr>
</tbody>
</table>
<p>If wanting to be able to operate on the source code of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan">Ceylan</a> and/or <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">US</a> dependencies, you may define appropriate symbolic links in a <tt class="docutils literal">_checkouts</tt> directory created at the root one's <tt class="docutils literal"><span class="pre">US-Web</span></tt> clone, these links pointing to relevant GIT repositories (see the <tt class="docutils literal"><span class="pre">create-us-web-checkout</span></tt> make target for that).</p>
<div class="section" id="using-cutting-edge-git">
<h3><a class="toc-backref" href="#id78">Using Cutting-Edge GIT</a></h3>
<p>This is the installation method that we use and recommend; the Universal Webserver <tt class="docutils literal">master</tt> branch is meant to stick to the latest stable version: we try to ensure that this main line always stays functional (sorry for the pun). Evolutions are to take place in feature branches and to be merged only when ready.</p>
<p>Once Erlang (see <a class="reference external" href="http://myriad.esperide.org/index.html#getting-erlang">here</a>), rebar3 (see <a class="reference external" href="http://myriad.esperide.org/index.html#getting-rebar3">here</a>) and possibly LEEC (see <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang#building">here</a>) or Awstats (see <a class="reference external" href="#getting-awstats">here</a>) are available, it should be just a matter of executing our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/tree/master/priv/bin/get-us-web-from-sources.sh">get-us-web-from-sources.sh</a> script for downloading and building all dependencies at once, and run a test server (use its <tt class="docutils literal"><span class="pre">--help</span></tt> option for more information).</p>
<p>For example:</p>
<pre class="code bash literal-block">
$ <span class="nb">cd</span> /tmp
$ wget https://raw.githubusercontent.com/Olivier-Boudeville/us-web/master/priv/bin/get-us-web-from-sources.sh
$ sh ./get-us-web-from-sources.sh --checkout
Switching to checkout mode.

 Installing US-Web in /tmp...

 Cloning into <span class="s1">'us_web'</span>...
 <span class="o">[</span>...<span class="o">]</span>
 <span class="o">===</span>&gt; Compiling us_web
 Starting the us_web release <span class="o">(</span>EPMD port: <span class="m">4526</span><span class="o">)</span>:
 <span class="o">[</span>...<span class="o">]</span>
 US-Web launched, please point a browser to http://localhost:8080 to
  check <span class="nb">test</span> sites.

$ firefox http://localhost:8080 <span class="p">&amp;</span>
</pre>
<p>One shall then see a text-only page such as:</p>
<pre class="literal-block">
This is static website D. This is the one you should see if pointing
to the default virtual host corresponding to the local host. This
shows that the US-Web server is up and running.
</pre>
<p>Understanding the role of the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">main US configuration file</a> and of the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">US-Web configuration file</a> for this test should be fairly straightforward.</p>
<p>Based on that, devising one's version of them should allow to have one's US-Web server running at the cost of very little efforts.</p>
<p><span class="raw-html"><a name="otp"></a></span></p>
</div>
<div class="section" id="otp-considerations">
<span id="otp-build"></span><h3><a class="toc-backref" href="#id79">OTP Considerations</a></h3>
<p>As discussed in these sections of <a class="reference external" href="http://myriad.esperide.org/myriad.html#otp">Myriad</a>, <a class="reference external" href="http://wooper.esperide.org/index.html#otp">WOOPER</a>, <a class="reference external" href="http://traces.esperide.org/index.html#otp">Traces</a> and <a class="reference external" href="http://us-common.esperide.org/index.html#otp">US-Common</a>, the Universal Webserver <em>OTP application</em> is generated out of the build tree, ready to result directly in an <em>(OTP) release</em>. For that we rely on <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, <a class="reference external" href="https://github.com/erlware/relx">relx</a> and (possibly) <a class="reference external" href="https://hex.pm/">hex</a>.</p>
<p>Then we benefit from a standalone, complete Universal Webserver able to host as many virtual hosts on as many number of domains as needed.</p>
<p>As for Myriad, WOOPER, Traces, LEEC and US-Common, most versions of the Universal Webserver will be also published as <a class="reference external" href="https://hex.pm/packages/us_web">Hex packages</a>.</p>
<p>For more details, one may have a look at <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/conf/rebar.config.template">rebar.config.template</a>, the general rebar configuration file used when generating the Universal Webserver OTP application and release (implying the automatic management of all its dependencies).</p>
</div>
</div>
<div class="section" id="troubleshooting">
<h2><a class="toc-backref" href="#id80">Troubleshooting</a></h2>
<p>If having deployed a release (typically by running <tt class="docutils literal"><span class="pre">deploy-us-web-release.sh</span></tt>) and <tt class="docutils literal">systemctl restart <span class="pre">us-web.service</span></tt> failed, start by executing:</p>
<pre class="literal-block">
$ systemctl status us-web.service
</pre>
<p>It should return some appropriate information.</p>
<p>Most common sources of failures are:</p>
<ul class="simple">
<li>there is <strong>already a program listening at the target TCP port</strong> (typically port 80) designated for US-Web; one may check for example with <tt class="docutils literal">lsof <span class="pre">-i:80</span></tt>, otherwise with <tt class="docutils literal">netstat <span class="pre">-ltpn</span> | grep ':80'</tt>; of course use the same for TCP port <tt class="docutils literal">443</tt> if having enable <tt class="docutils literal">https</tt> on its standard port</li>
<li>check that no firewall is in the way (ex: thanks to <tt class="docutils literal">iptables <span class="pre">-nL</span> | gr ':80'</tt>)</li>
<li>there may be a <strong>prior, lingering US-Web</strong> installation that is still running in the background; one may check for example with <tt class="docutils literal">ps <span class="pre">-edf</span> | grep us_web</tt></li>
<li>the <strong>EPMD daemon</strong> of interest (possibly running on a non-standard TCP port) may wrongly believe that a prior US-Web is running, and thus prevent a new one to be launched; simple solution: <tt class="docutils literal">killall epmd</tt></li>
<li>check your <tt class="docutils literal">authbind</tt> local configuration (refer to <a class="reference external" href="#authbind">this section</a>)</li>
</ul>
<p>If the problem remains, time to perform some investigation, refer to the <a class="reference internal" href="#local-monitoring">Local Monitoring</a> section.</p>
</div>
<div class="section" id="hints">
<h2><a class="toc-backref" href="#id81">Hints</a></h2>
<p>Various keys (ex: <tt class="docutils literal">us_app_base_dir</tt>) may be defined in the US configuration files (ex: in a <tt class="docutils literal">{us_app_base_dir, &quot;/opt/some_dir&quot;}</tt> entry), from which other elements may derive (ex: paths). To denote the value associated to a key, we surround in this documentation the key with <tt class="docutils literal">&#64;</tt> characters (this is just a reading convention).</p>
<p>For example <tt class="docutils literal"><span class="pre">&#64;us_app_base_dir&#64;/hello.txt</span></tt> would correspond here to <tt class="docutils literal">/opt/some_dir/hello.txt</tt>.</p>
<div class="section" id="development-vs-production-mode">
<h3><a class="toc-backref" href="#id82">Development vs Production Mode</a></h3>
<p>Should a mismatch be detected between the compile-time execution target and the runtime, user-configured, execution context, a warning will be issued in the traces.</p>
<p>When building a fresh release thanks to <tt class="docutils literal">make <span class="pre">release-dev</span></tt>, the corresponding action (<tt class="docutils literal">rebar3 release</tt>) will build that release with the base settings, hence in development mode (so not &quot;as prod&quot; - i.e. not with the <tt class="docutils literal">prod</tt> profile, hence not selecting our <tt class="docutils literal">production</tt> execution target).</p>
<p>Note that all dependencies (thus of course including Myriad, WOOPER, Traces and LEEC) are built by rebar3 with their <tt class="docutils literal">prod</tt> settings. As a result, relying on <tt class="docutils literal">basic_utils:get_execution_target/0</tt> will only tell us about <tt class="docutils literal">Myriad</tt> settings (thus always built in production mode), not about any other layer (including <tt class="docutils literal"><span class="pre">US-Web</span></tt>). A US-Web trace allows to check all relevant modes, notably that, in production, the production settings apply indeed.</p>
</div>
<div class="section" id="development-hints">
<h3><a class="toc-backref" href="#id83">Development Hints</a></h3>
<div class="section" id="operating-directly-from-within-the-rebar-build-tree">
<h4>Operating directly from within the rebar build tree</h4>
<p>(not recommended in a development phase)</p>
<p>If having modified and recompiled a Ceylan prerequisite (ex: WOOPER), then, before generating the release, run from its root (ex: <tt class="docutils literal">us_web/_build/default/lib/wooper</tt>):</p>
<pre class="literal-block">
$ make rebar3-copy-beams REBAR_BUILD_DIR=../../
</pre>
<p>Or, simply run <tt class="docutils literal">make <span class="pre">rebar3-compile</span> <span class="pre">REBAR_BUILD_DIR=../../</span></tt> (and no need to run <tt class="docutils literal">make release</tt> afterwards).</p>
</div>
<div class="section" id="operating-from-checkouts-build-trees">
<h4>Operating from <tt class="docutils literal">_checkouts</tt> build trees</h4>
<p>(recommended in a development phase, as a lot more flexible/unified than the previous method)</p>
<p>Create a <tt class="docutils literal">us_web/_ckeckouts</tt> directory containing symbolic links to repositories of dependencies (ex: <tt class="docutils literal">myriad</tt>) that may be updated locally; or, preferably, execute the <tt class="docutils literal"><span class="pre">create-us-web-checkout</span></tt> make target to automate and streamline this step.</p>
</div>
</div>
<div class="section" id="configuration-hints">
<h3><a class="toc-backref" href="#id84">Configuration Hints</a></h3>
<div class="section" id="batch-mode">
<h4>Batch Mode</h4>
<p>One can update <tt class="docutils literal">us_web/conf/sys.config</tt> in order to toggle batch mode (ex: to enable/disable a graphical trace supervision) after build time.</p>
<p>It deals with the configuration of the <tt class="docutils literal">Traces</tt> application, so it comes very early at start-up (at application boot, hence before US-Web specific settings can be read, so this option would be difficult to put in the US configuration files).</p>
</div>
<div class="section" id="location-of-applications">
<h4>Location of Applications</h4>
<p>The location of the US-Web application is bound to differ depending on the context of use (development/production deployments, host-wise, etc.), whereas it is needed to be known at the very least by its start/stop scripts.</p>
<p>So its path must be specified (most preferably as an absolute directory) in the US-Web configuration file. However, at least for test configuration files, relying on an absolute directory would not be satisfactory, as the user may install the US-Web framework at any place and testing should not require a manual configuration update.</p>
<p>As a result, should an application location (ex: US-Web) not be specified in the configuration, it will be looked-up in the shell environment (using the <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> variable) for that and, should this variable not be set, as a last-resort an attempt to guess that location will be done.</p>
</div>
<div class="section" id="web-related-hints">
<h4>Web-related hints</h4>
<ul class="simple">
<li>most paths (ex: <tt class="docutils literal">default_web_root</tt>, in the US-Web configuration) can be defined as <strong>relative</strong> ones (mostly useful for embedded tests; otherwise absolute paths shall be preferred); in this case they will be relative to the runtime current directory, typically <tt class="docutils literal"><span class="pre">[...]/us_web/_build/default/rel/us_web/</span></tt> in development mode</li>
<li>the <tt class="docutils literal">default_domain_catch_all</tt> atom allows to designate any <strong>domain-level host</strong> (ex: <tt class="docutils literal">foobar.org</tt>) that did not match previous host rules</li>
<li>in the context of a given host (ex: <tt class="docutils literal">foobar.org</tt>), the <tt class="docutils literal">default_vhost_catch_all</tt> atom allows to designate any of its <strong>virtual hosts</strong> (ex: <tt class="docutils literal">bar</tt>, to be understood as <tt class="docutils literal">bar.foobar.org</tt>) that did not match previous path rules</li>
<li>refer to <tt class="docutils literal"><span class="pre">us_web/priv/for-testing</span></tt> for an example setup and configuration files</li>
<li>the web roots shall be owned by the user running US-Web (ex: <tt class="docutils literal">chown <span class="pre">-R</span> <span class="pre">us-web-user:us-group</span> /opt/www</tt>)</li>
</ul>
</div>
</div>
<div class="section" id="execution-hints">
<h3><a class="toc-backref" href="#id85">Execution Hints</a></h3>
<ul>
<li><p class="first">the current working directory of a US-Web instance deployed thanks to <tt class="docutils literal"><span class="pre">deploy-us-web-release.sh</span></tt> is <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z</span></tt></p>
</li>
<li><p class="first">if unable to connect, the firewall (ex: <tt class="docutils literal">iptables <span class="pre">-L</span></tt>) might be the culprit! Note that the whole US framework tends to rely on a specific TCP range (ex: <tt class="docutils literal"><span class="pre">50000-55000</span></tt>) for inter-VM communications; for HTTP, TCP port 80 is expected to be opened, and this is TCP port 443 for HTTPS (see also our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script)</p>
</li>
<li><p class="first">to debug (once batch mode has been enabled/disabled), one may use the <tt class="docutils literal">debug</tt> make target, from the tree root</p>
</li>
<li><p class="first">to test server-side errors, one may create, in a web root, a directory that cannot be traversed (ex: <tt class="docutils literal">chmod 000 <span class="pre">my-dir</span></tt>) and direct one's browser to a content supposedly located in this directory <a class="footnote-reference" href="#id33" id="id32">[4]</a>; note that, if requesting instead that faulty directory itself (not an element within), then (whether or not a trailing <tt class="docutils literal">/</tt> is specified), an error 403 (<tt class="docutils literal">ERROR 403: Forbidden</tt>) is returned instead (corresponds to the <tt class="docutils literal">case A</tt> in the corresponding sources)</p>
</li>
<li><p class="first">to test host matching (ex: for a <tt class="docutils literal">baz</tt> virtual host), including the default catch-all even on a computer having no specific public DNS entries, one may simply add in <tt class="docutils literal">/etc/hosts</tt> entries like:</p>
<pre class="literal-block">
127.0.0.1 foobar-test.net baz.foobar-test.net other.foobar-test.net
</pre>
</li>
</ul>
<table class="docutils footnote" frame="void" id="id33" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id32">[4]</a></td><td>See <tt class="docutils literal"><span class="pre">priv/for-testing/test-static-website-A/to-test-for-errors</span></tt>, which was created precisely for that. Note that its permissions have been restored to sensible values, as otherwise that directory was blocking the OTP release generation.</td></tr>
</tbody>
</table>
<ul>
<li><p class="first">log rotation results in timestamped, compressed files such as <tt class="docutils literal"><span class="pre">access-for-bar.localhost.log.2019-12-31-at-22h-03m-35s.xz</span></tt>; note that the timestamp corresponds to the moment at which the rotation took place (hence not the time range of these logs; more an upper bound thereof)</p>
</li>
<li><p class="first">to test whether a combination of EPMD port and cookie is legit, one may use for example:</p>
<pre class="literal-block">
$ ERL_EPMD_PORT=44000 /usr/local/lib/erlang/erts-x.y/bin/erl_call -name us_web&#64;baz.foobar.org -R -c 'MyCookie' -timeout 60 -a 'erlang is_alive'
</pre>
</li>
</ul>
<p>You then expect <tt class="docutils literal">true</tt> to be returned - not:</p>
<pre class="literal-block">
erl_call: failed to connect to node us_web&#64;baz.foobar.org
</pre>
</div>
<div class="section" id="monitoring-hints">
<h3><a class="toc-backref" href="#id86">Monitoring Hints</a></h3>
<div class="section" id="in-terms-of-unix-processes">
<h4>In terms of (UNIX) Processes</h4>
<p>A running US-Web server will not be found by looking up <tt class="docutils literal">beam</tt> or <tt class="docutils literal">beam.smp</tt> through <tt class="docutils literal">ps</tt>; as an OTP release, it relies first on the <tt class="docutils literal">run_erl</tt> launcher, like shown, based on <tt class="docutils literal">ps <span class="pre">-edf</span></tt>, in:</p>
<pre class="literal-block">
UID         PID    PPID  C STIME TTY TIME     CMD
us-web-user 767067    1  0 Feb15 ?   00:00:00 /usr/local/lib/erlang/erts-x.y/bin/run_erl
  -daemon /tmp/erl_pipes/us_web&#64;MY_FQDN/ /opt/universal-server/us_web-US_WEB_VERSION/log
  exec &quot;/opt/universal-server/us_web-US_WEB_VERSION/bin/us_web&quot; &quot;console&quot; ''
  --relx-disable-hooks
</pre>
<p>This can be interpreted as:</p>
<ul class="simple">
<li>not running as root, but as a dedicated, weakly privileged user</li>
<li>its parent process (PPID) is the first overall process (as a daemon)</li>
<li>STIME is the time when the process started</li>
<li>no associated TTY (runs detached in the background)</li>
</ul>
<p>This launcher created the main, central, <tt class="docutils literal">us_web</tt> (UNIX) process, parent of all the VM worker (system) threads.</p>
<p><tt class="docutils literal">pstree <span class="pre">-u</span></tt> (or <tt class="docutils literal">ps <span class="pre">-e</span> <span class="pre">--forest</span></tt>) tells us about the underlying process hierarchy:</p>
<pre class="literal-block">
[...]
  |-run_erl(us-web-user)---beam.smp---erl_child_setup---inet_gethost---inet_gethost
  |                             |-158*[{beam.smp}]
[...]
</pre>
<p>The 158 threads must correspond to:</p>
<ul class="simple">
<li>128 async ones (<tt class="docutils literal"><span class="pre">-A</span> 128</tt>)</li>
<li>30 &quot;normal&quot; threads (on a computer having a single CPU with 8 cores with Hyperthreading, hence 16 logical cores)</li>
</ul>
<p>Using <tt class="docutils literal">htop</tt>, one can see that the <tt class="docutils literal">run_erl</tt> process spawned a <tt class="docutils literal">us_web</tt> one (namely <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-US_WEB_VERSION/bin/us_web</span></tt>) that is far larger in (VIRT) memory (ex: 5214MB, instead of 5832KB for the former).</p>
<p><tt class="docutils literal">us_web</tt> in turn created the numerous threads.</p>
<p><tt class="docutils literal">RSS/RSZ</tt> (<em>Resident Set Size</em>) is a far better metric than <tt class="docutils literal">VIRT/VSZ</tt> (<em>Virtual Memory Size</em>); indeed <tt class="docutils literal">VIRT = RSS + SWP</tt> and:</p>
<ul class="simple">
<li><tt class="docutils literal">RSS</tt> shows how much memory is allocated to that process and is in RAM; it does not include memory that is swapped out; it includes memory from shared libraries (as long as the pages from those libraries are actually in memory), and all stack and heap memory used</li>
<li><tt class="docutils literal">VIRT</tt> includes all memory that the process can access, including memory that is swapped out, memory that is allocated but not used, and memory that is from shared libraries</li>
</ul>
<p>Knowing that, with <tt class="docutils literal">ps</tt>, one may add <tt class="docutils literal"><span class="pre">-L</span></tt> to display thread information and <tt class="docutils literal"><span class="pre">-f</span></tt> to have full-format listing, a base command to monitor the US-Web processes is: <tt class="docutils literal">ps <span class="pre">-eww</span> <span class="pre">-o</span> rss,pid,args | grep us_web</tt>, with:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">-e</span></tt>: select all processes</li>
<li><tt class="docutils literal"><span class="pre">-w</span></tt> (once or twice): request wide output</li>
<li><tt class="docutils literal"><span class="pre">-o</span> rss,pid,args</tt>: display RSS memory used (in kilobytes), PID and full command line</li>
</ul>
<p>(apparently there is no direct way of displaying human-readable sizes)</p>
<p>See also our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/list-processes-by-size.sh">list-processes-by-size.sh</a> script; typical use:</p>
<pre class="literal-block">
$ list-processes-by-size.sh
   Listing running processes by decreasing resident size in RAM (total size in KiB):
 RSS  PID      COMMAND
[...]
1204  1695242  /usr/local/lib/erlang/erts-11/bin/run_erl -daemon /tmp/erl_pipes/us_web&#64;somehost.foobar.org/ /opt/universal-server/us_web-x.y.z/log exec &quot;/opt/universal-server/us_web-x.y.z/bin/us_web&quot; &quot;console&quot; ''  --relx-disable-hooks
67776 1695243 /opt/universal-server/us_web-x.y.z/bin/us_web -A 128 -- -root /opt/universal-server/us_web-x.y.z -progname opt/universal-server/us_web-x.y.z/bin/us_web -- -home /home/us-web-user -epmd_port 4526 -- -boot /opt/universal-server/us_web-x.y.z/releases/x.y.z/start -mode embedded -boot_var ERTS_LIB_DIR /usr/local/lib/erlang/lib -config /opt/universal-server/us_web-x.y.z/releases/x.y.z/sys.config -name us_web -setcookie us_web_initial_cookie -- -- console --relx-disable-hooks --
[...]
</pre>
<p>This confirms that, even if higher VIRT sizes can be reported (ex: 5214M, hence roughly 5GB), the RSS size may be 67776 (KB, hence 66 MB), i.e. very little, and does not vary much.</p>
<p>Indeed, in terms of RSS use (for a few domains, each with a few low-traffic websites, if that matters), we found:</p>
<ul class="simple">
<li>at start-up: only about 67MB</li>
<li>after 5 days: just 68 MB</li>
<li>after 24 days: 76 MB</li>
<li>after 55 days: 80-88 MB</li>
</ul>
<p>A more recent server instance is using, after more than 70 days, 60 MB of RSS memory.</p>
</div>
<div class="section" id="trace-monitoring">
<h4>Trace Monitoring</h4>
<p>Use the <tt class="docutils literal"><span class="pre">us_web/priv/bin/monitor-us-web.sh</span></tt> script in order to monitor the traces of an already running, possibly remote, US-Web instance.</p>
<p>Note that the monitored US-Web instance will be by default the one specified in any <tt class="docutils literal"><span class="pre">us-monitor.config</span></tt> file located in the US configuration directory.</p>
<p>One may specify on the command-line another configuration file if needed, such as <tt class="docutils literal"><span class="pre">us-monitor-for-development.config</span></tt>.</p>
</div>
<div class="section" id="node-test-connection">
<h4>Node Test &amp; Connection</h4>
<p>If desperate enough, one may also run, possibly from another host, and based on the settings to be found in the configuration files:</p>
<pre class="literal-block">
$ ERL_EPMD_PORT=XXXX erl -name tester -setcookie CCCC -kernel inet_dist_listen_min MIN inet_dist_listen_max MAX

1&gt; net_adm:ping('us_web&#64;foobar.org').
pong
</pre>
<p>Then one may switch to the <em>Job control mode</em> (JCL) by pressing <tt class="docutils literal"><span class="pre">Ctrl-G</span></tt> then <tt class="docutils literal">r</tt> to start a remote job on the US-Web node.</p>
</div>
</div>
</div>
<div class="section" id="standard-log-generation-analysis">
<h2><a class="toc-backref" href="#id87">Standard Log Generation &amp; Analysis</a></h2>
<p>The objective in this section is to have US-Web generate access logs like the standard webservers do, so that standard tools able to produce log analyses can be used afterwards. They may generate HTML pages, which can in turn be appropriately hosted directly by the US-Web framework itself.</p>
<p>US-Web (rather than a <tt class="docutils literal">crontab</tt>) takes control of log writing, for full control onto the start, stop and rotation behaviours.</p>
<p>For write efficiency, It is done by an (Erlang) process specific to a given virtual host (see <tt class="docutils literal">class_USWebLogger</tt>), and a task ring is used for synchronicity and load balancing with regard to log report generation.</p>
<p>For each virtual host (ex: <tt class="docutils literal">baz.foobar.org</tt>), following log files shall be generated:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt></li>
<li><tt class="docutils literal"><span class="pre">error-for-baz.foobar.org.log</span></tt></li>
</ul>
<p>They are to be stored by default in the <tt class="docutils literal">/var/log</tt> directory, which can be overridden in the US-Web configuration file thanks to the <tt class="docutils literal">us_web_log_dir</tt> key.</p>
<p>At the Cowboy level, logging could be done as a <a class="reference external" href="https://ninenines.eu/docs/en/cowboy/2.7/guide/middlewares/">middleware</a>, yet we preferred to perform it directly in the handler (typically the static one, <tt class="docutils literal">us_web_static</tt>), presumably for a better control.</p>
<p>Once access logs are produced, a specific tool is to generate reports out of them, as discussed in the next section.</p>
<div class="section" id="web-analytics-software-choice-of-tool">
<h3><a class="toc-backref" href="#id88">Web Analytics Software: Choice of Tool</a></h3>
<p>The desired properties for such a tool are mainly: available as free software, trustable, standard, actively and well-maintained, running locally (as opposed to remote services such as Google Analytics), standalone, not resource-demanding, controllable, generating a local analysis (static) website, based only on basic webserver logs (not on a dedicated database, not on markers to be added to all webpages such as 1-pixel images), virtual-host compliant.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/List_of_web_analytics_software">Various tools</a> can be considered, including (best spotted candidates, by increasing level of interest):</p>
<ul class="simple">
<li><a class="reference external" href="http://www.webalizer.org/">The Webalizer</a>: simple reports only, not maintained since 2013?</li>
<li><a class="reference external" href="http://www.openwebanalytics.com/">OWA</a>: for professional, store-like business</li>
<li><a class="reference external" href="https://matomo.org/log-analytics/">Matomo</a>: <a class="reference external" href="https://en.wikipedia.org/wiki/Matomo_(software)">interesting</a>, yet a bit too complete / integrated; requires a dedicated database</li>
<li><a class="reference external" href="https://goaccess.io/GoAccess">GoAccess</a>: a good candidate, almost no dependency, actively maintained, beautiful reports, supports GeoLite2, but more real-time oriented (more like a web monitor) and with less in-depth metrics</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/AWStats">AWStats</a>: old yet still maintained, real community-based open-source software, very complete, probably the most relevant in the list, whose code is apparently now maintained <a class="reference external" href="https://github.com/eldy/awstats">here</a></li>
</ul>
<p>So we finally retained <a class="reference external" href="https://awstats.sourceforge.io/">AWStats</a>.</p>
</div>
<div class="section" id="log-format">
<h3><a class="toc-backref" href="#id89">Log Format</a></h3>
<p>The most suitable log format that we spotted (see <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_faq.html#PERSONALIZEDLOG">[1]</a> and <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_config.html#LogFormat">[2]</a> for more information) is named &quot;<em>NCSA combined with several virtualhostname sharing same log file</em>&quot;.</p>
<p>Its correct definition is exactly:</p>
<pre class="literal-block">
LogFormat=&quot;%virtualname %host %other %logname %time2 %methodurl %code %bytesd %refererquot %uaquot&quot;
</pre>
<p>For example:</p>
<pre class="literal-block">
virtualserver1 62.161.78.73 - - 2020-02-02 01:59:02 &quot;GET /page.html HTTP/1.1&quot; \
200 1234 &quot;http://www.from.com/from.htm&quot; &quot;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&quot;
</pre>
<p>This format is better than the &quot;Apache combined logs&quot; (combined, not common) log format, as containing the virtual host (important); note that for this second format, precisely named &quot;<em>Apache or Lotus Notes/Domino native combined log format (NCSA combined/XLF/ELF log format)</em>&quot; would be defined as:</p>
<pre class="literal-block">
LogFormat=&quot;%host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot
</pre>
<p>For example:</p>
<pre class="literal-block">
62.161.78.73 - - [dd/mmm/yyyy:hh:mm:ss +0x00] &quot;GET /page.html HTTP/1.1&quot; \
200 1234 &quot;http://www.from.com/from.htm&quot; &quot;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&quot;
</pre>
<p>Field descriptions for this last format: <a class="reference external" href="https://en.wikipedia.org/wiki/Common_Log_Format">[1]</a>, <a class="reference external" href="https://httpd.apache.org/docs/current/logs.html#accesslog">[2]</a>, <a class="reference external" href="http://fileformats.archiveteam.org/wiki/Combined_Log_Format">[3]</a>, <a class="reference external" href="https://stackoverflow.com/questions/9234699/understanding-apaches-access-log">[4]</a>.</p>
<p>See also regarding Awstats log formats: <a class="reference external" href="https://www.internetofficer.com/awstats/log-format/">[1]</a>, <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_faq.html#LOGFORMAT">[2]</a>, <a class="reference external" href="https://wiki.archlinux.org/index.php/AWStats">[3]</a>.</p>
<p>In all these cases, the log separator is a single space (hence <tt class="docutils literal">LogSeparator=&quot; &quot;</tt>).</p>
</div>
<div class="section" id="awstats-management">
<h3><a class="toc-backref" href="#id90">Awstats Management</a></h3>
<div class="section" id="awstats-installation">
<h4>Awstats Installation</h4>
<p>On Arch Linux, one should follow <a class="reference external" href="https://wiki.archlinux.org/index.php/AWStats">these guidelines</a> (example for version 7.8):</p>
<pre class="literal-block">
$ pacman -Sy --needed awstats
</pre>
<p>Awstats will then be installed in <tt class="docutils literal">/usr/share</tt>, including the <tt class="docutils literal"><span class="pre">/usr/share/webapps/awstats/cgi-bin/awstats.pl</span></tt> script and the <tt class="docutils literal">/usr/share/webapps/awstats/icon/</tt> directory.</p>
<p>Some permission fixes (to be done as root) might be needed first:</p>
<pre class="literal-block">
$ chmod +r /usr/share/webapps/awstats/icon/os/*
</pre>
</div>
<div class="section" id="awstats-configuration">
<h4>Awstats Configuration</h4>
<p>Log analysis will be triggered periodically by the US-Web server rather than on-demand via CGI Perl scripts, and its result, i.e. the web pages generated from the access logs, will be available in the meta website (ex: <tt class="docutils literal">mymeta.foobar.org</tt>; refer to <a class="reference internal" href="#auto-generated-meta-website">Auto-generated Meta Website</a> for more information).</p>
<p>More precisely, and as already mentioned, in the US-Web log directory (see <tt class="docutils literal">us_web_log_dir</tt>), dedicated access and error log files will be generated for each known virtual host. For example the accesses to a <tt class="docutils literal">baz.foobar.org</tt> virtual host will be written by the US-Web server in a corresponding <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt> file.</p>
<p>At server start-up, the US-Web meta module (<tt class="docutils literal">us_web_meta</tt>) will have generated a suitable Awstats configuration file (namely <tt class="docutils literal">awstats.baz.foobar.org.conf</tt>) that will trigger the generation of the corresponding static web pages (<tt class="docutils literal">awstats.baz.foobar.org.*</tt>, notably <tt class="docutils literal">awstats.baz.foobar.org.html</tt>) in the web root of the meta website.</p>
<p>These configuration files are now placed in <tt class="docutils literal">/usr/local/etc/awstats</tt> (they were previously in the <tt class="docutils literal">conf</tt> subdirectory of the root specified in <tt class="docutils literal">us_web_app_base_dir</tt>).</p>
<p>Indeed, if starting from version 7.8, Awstats allows these configuration files to be specified as absolute paths, its previous versions:</p>
<ul class="simple">
<li>either required such configuration files to be in <tt class="docutils literal">/etc/awstats</tt>, <tt class="docutils literal">/usr/local/etc/awstats</tt>, <tt class="docutils literal">/etc</tt> or in the same directory as the <tt class="docutils literal">awstats.pl</tt> script file</li>
<li>or, if the configuration files could be specified as absolute paths, the generated pages would then include some faulty links because of that</li>
</ul>
<p>US-Web retained the most controllable, less &quot;system&quot; directory, <tt class="docutils literal">/usr/local/etc/awstats</tt>. All these locations are mostly root-only, whereas the US-Web server is designed to run as a normal, non-privileged user and is to generate there these Awstats configuration files.</p>
<p>Such a target directory shall thus be created beforehand, and made writable by the user specified in <tt class="docutils literal">us_web_username</tt>.</p>
<p>Each virtual host (say: <tt class="docutils literal">baz.foobar.org</tt>) will have its configuration file deriving from <tt class="docutils literal">priv/conf/awstats.template.conf</tt>, where the following patterns will be replaced by relevant ones (through keyword-based replacements):</p>
<ul class="simple">
<li><tt class="docutils literal">US_WEB_VHOST_LOG_FILE</tt> to become the full path to the corresponding access log (ex: <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt>, in <tt class="docutils literal">us_web_log_dir</tt>)</li>
<li><tt class="docutils literal">US_WEB_VHOST_DOMAIN</tt> to become the virtual host domain (ex: <tt class="docutils literal">baz.foobar.org</tt>)</li>
<li><tt class="docutils literal">US_WEB_LOG_ANALYSIS_DATA_DIR</tt> to become the directory in which the working data (ex: state files) of the web analyzer (here Awstats) shall be written</li>
</ul>
<p>Awstats icons are copied to the <tt class="docutils literal">icon</tt> directory at the root of the meta website.</p>
<p>The Awstats database, typically located in <tt class="docutils literal"><span class="pre">/var/local/us-web/data</span></tt>, will be updated once an access log file will be rotated; just after, this log file will be compressed and archived under a relevant filename, such as <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log.2020-2-1-at-19h-48m-12s.xz</span></tt>.</p>
</div>
<div class="section" id="awstats-troubleshooting">
<h4>Awstats Troubleshooting</h4>
<p>Various issues may prevent log reports to be available.</p>
<p>Let's try with a real US-Web uncompressed log file first (ex: <tt class="docutils literal">xz <span class="pre">-d</span> <span class="pre">access-vhost-catchall.log.test.xz</span></tt>), supposing that it corresponds to a <tt class="docutils literal"><span class="pre">my-test</span></tt> virtual host).</p>
<p>Then configure Awstats (ex: through a <tt class="docutils literal"><span class="pre">/usr/local/etc/awstats/awstats.my-test.conf</span></tt> file) to process that log file; for that, run on that host:</p>
<pre class="literal-block">
$ perl /usr/share/awstats/tools/awstats_configure.pl
</pre>
<p>Then, to debug the whole process, use, as root:</p>
<pre class="literal-block">
$ rm -f /usr/share/webapps/awstats/cgi-bin/awstats*.txt ; echo ;
   LANG=C /usr/share/webapps/awstats/cgi-bin/awstats.pl
     -config=my-test -showdropped
</pre>
<p>Most problems should become visible then.</p>
<p>To do the same for a series of web logs in the context of US-Web, one can have them analysed first thanks to:</p>
<pre class="literal-block">
$ for f in /usr/local/etc/awstats/awstats-*conf; do echo ;
   LANG=C /usr/share/webapps/awstats/cgi-bin/awstats.pl
     -config=$f -update ; done
</pre>
<p>Then all web reports can be generated manually with:</p>
<pre class="literal-block">
$ for f in /usr/local/etc/awstats/awstats-*conf; do echo ;
   LANG=C /usr/share/webapps/awstats/cgi-bin/awstats.pl
     -config=$f -output ; done
</pre>
</div>
</div>
<div class="section" id="geolocation-with-awstats">
<h3><a class="toc-backref" href="#id91">Geolocation with Awstats</a></h3>
<p><a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_contrib.html">Multiple plugins</a> exist for that.</p>
<p><a class="reference external" href="https://github.com/eldy/awstats/issues/86">Apparently</a>, none is able to load the new GeoIP2 format (see also <a class="reference external" href="https://github.com/eldy/awstats/issues/114">this</a>).</p>
<p>As a consequence: topic dropped for the moment.</p>
</div>
</div>
<div class="section" id="managing-public-key-certificates">
<h2><a class="toc-backref" href="#id92">Managing Public-Key Certificates</a></h2>
<p>The goal here is to benefit from suitable certificates, notably for https (typically running on TCP port 443, multiplexed thanks to SNI, i.e. <a class="reference external" href="ServerNameIndication">Server Name Indication</a> <a class="footnote-reference" href="#id47" id="id46">[5]</a>), by automatically (and freely) generating, using and renewing them appropriately, for each of the virtual hosts managed by the US-Web server.</p>
<table class="docutils footnote" frame="void" id="id47" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id46">[5]</a></td><td>As a consequence, the specific visited virtual hostname (ex: <tt class="docutils literal">baz</tt>, in  <tt class="docutils literal">baz.foobar.org</tt>) is <em>not</em> encrypted, and thus might be known of an eavesdropper.</td></tr>
</tbody>
</table>
<div class="section" id="x-509-certificates">
<h3><a class="toc-backref" href="#id93">X.509 Certificates</a></h3>
<p>The certificates managed here are <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> TLS certificates, which can be seen as standard containers of a public key together with an identity and a hierarchical, potentially trusted <em>Certificate Authority</em> (CA) that signed them <a class="footnote-reference" href="#id49" id="id48">[6]</a>.</p>
<table class="docutils footnote" frame="void" id="id49" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id48">[6]</a></td><td>The X.509 standard also includes certificate revocation lists and the algorithm to sign recursively certificates from a trust anchor.</td></tr>
</tbody>
</table>
<p>Such certificates can be used for any protocol or standard, and <a class="reference external" href="https://en.wikipedia.org/wiki/X.509#Major_protocols_and_standards_using_X.509_certificates">many</a> do so - including of course TLS and, to some extent, SSH. Being necessary to the https scheme, they are used here.</p>
</div>
<div class="section" id="let-s-encrypt">
<h3><a class="toc-backref" href="#id94">Let's Encrypt</a></h3>
<p>US-Web relies on <a class="reference external" href="https://letsencrypt.org">Let's Encrypt</a>, a non-profit certificate authority from which one can obtain mono-domain X.509 certificates <a class="footnote-reference" href="#id52" id="id51">[7]</a> for free, valid for 90 days and that can be renewed as long as needed.</p>
<table class="docutils footnote" frame="void" id="id52" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id51">[7]</a></td><td><tt class="docutils literal">Let's Encrypt</tt> provides <em>Domain Validation</em> (DV) certificates, but neither more general <em>Organization Validation</em> (OV) nor <em>Extended Validation</em> (EV).</td></tr>
</tbody>
</table>
<p>Let's Encrypt follows the ACME (<em>Automatic Certificate Management Environment</em>) protocol. It relies on an agent running on the server bound to the domain for which a certificate is requested.</p>
<p>This agent generates first a RSA key pair in order to interact with the Lets Encrypt certificate authority, so that it can prove through received challenge(s) that it is bound to the claimed domain / virtual host (ex: <tt class="docutils literal">baz.foobar.org</tt>) and has the control to the private key corresponding to the public one that it transmitted to the CA.</p>
<p>Generally this involves for that agent to receive a &quot;random&quot; piece of data from the CA (the nonce), to sign it with said private key, and to make the resulting file available through the webserver at a relevant URL that corresponds to the target virtual host and to a well-known path (ex: <tt class="docutils literal"><span class="pre">http://baz.foobar.org/.well-known/acme-challenge/xxx</span></tt>). Refer to <a class="reference external" href="https://letsencrypt.org/how-it-works/">this page</a> for more information.</p>
</div>
<div class="section" id="us-web-mode-of-operation">
<h3><a class="toc-backref" href="#id95">US-Web Mode of Operation</a></h3>
<p>Rather than using a standalone ACME agent such as the standard one, <tt class="docutils literal">certbot</tt>, we prefer driving everything from Erlang, for a better control and periodical renewal (see the scheduler provided by <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USScheduler.erl">US-Common</a>).</p>
<p>Various libraries exist for that in Erlang, the most popular one being probably <a class="reference external" href="https://github.com/gbour/letsencrypt-erlang">letsencrypt-erlang</a>; we <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang">forked</a> it (and named it LEEC, for <em>Let's Encrypt Erlang with Ceylan</em>, to tell them apart), in order notably to support newer Erlang versions and to allow for <em>concurrent</em> certificate renewals (knowing that one certificate per virtual host will be needed).</p>
<p>Three <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang#action-modes">action modes</a> can be considered to interact with the Let's Encrypt infrastructure and to solve its challenges. As the US-Web server is itself a webserver, the <tt class="docutils literal">slave</tt> mode is the most relevant here.</p>
<p>For that, the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_letsencrypt_handler.erl">us_web_letsencrypt_handler</a> has been introduced.</p>
<p>By default, thanks to the US-Web scheduler, certificates (which last for up to 90 days and cannot be renewed before 60 days are elapsed) will be renewed every 75 days, with some random jitter added to avoid synchronising too many certificate requests when having multiple virtual hosts - as they are done concurrently.</p>
</div>
<div class="section" id="settings">
<h3><a class="toc-backref" href="#id96">Settings</a></h3>
<p>Various <a class="reference external" href="https://crypto.stackexchange.com/questions/43697/what-is-the-difference-between-pem-csr-key-and-crt-and-other-such-file-ext">types of files</a> are involved in the process:</p>
<ul class="simple">
<li>a <tt class="docutils literal">.key</tt> file contains any type of key, here this is a RSA private key; typically <tt class="docutils literal"><span class="pre">letsencrypt-agent.key-I</span></tt>, where <tt class="docutils literal">I</tt> is an increasing integer, will contain the PEM RSA private key generated by the certificate agent <tt class="docutils literal">I</tt> on behalf of the US-Webserver (so that it can sign the nonces provided by Let's Encrypt, and thus prove that it controls the corresponding key pair); for a <tt class="docutils literal">baz.foobar.org</tt> virtual host, the <tt class="docutils literal">baz.foobar.org.key</tt> file will be generated and used (another PEM RSA private key)</li>
<li>a <tt class="docutils literal">.pem</tt> (<em>Privacy-enhanced Electronic Mail</em>) file just designates a Base64-encoded content with header and footer lines; here it stores an ASN.1 (precisely a Base64-encoded DER) certificate</li>
<li><tt class="docutils literal">.csr</tt> corresponds to a PKCS#10 <em>Certificate Signing Request</em>; it contains information (encoded as PEM or DER) such as the public key and common name required by a Certificate Authority to create and sign a certificate for the requester (ex: <tt class="docutils literal">baz.foobar.org.csr</tt> will be a PEM certificate request)</li>
<li><tt class="docutils literal">.crt</tt> is the actual certificate (encoded as PEM or DER as well), usually a X509v3 one (ex: <tt class="docutils literal">baz.foobar.org.crt</tt>); it contains the public key and also much more information (most importantly the signature by the Certificate Authority over the data and public key, of course)</li>
</ul>
<p>We must determine:</p>
<ul class="simple">
<li>the size of the RSA key of the agent; the higher the better, hence: 4096</li>
<li>where the certificate-related files will be stored: in the <tt class="docutils literal">certificates</tt> subdirectory of the US-Web data directory, i.e. the one designated by the <tt class="docutils literal">us_web_data_dir</tt> key in US-Web's configuration file (hence it is generally the <tt class="docutils literal"><span class="pre">/var/local/us-web/us-web-data</span></tt> or <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z/us-web-data</span></tt> directory)</li>
</ul>
<p>The precise support for X.509 certificates (use, and possibly generation and renewal) is determined by the <tt class="docutils literal">certificate_support</tt> key of the US-Web configuration file:</p>
<ul class="simple">
<li>if not specified, or set to <tt class="docutils literal">no_certificates</tt>, then no certificate will be used, and thus no https support will be available</li>
<li>if set to <tt class="docutils literal">use_existing_certificates</tt>, then relevant certificates are supposed to pre-exist, and will be used as are (with no automatic renewal thereof done by US-Web)</li>
<li>if set to <tt class="docutils literal">renew_certificates</tt>, then relevant certificates will be generated at start-up (none re-used), used since then, and will be automatically renewed whenever appropriate</li>
</ul>
<p>When a proper certificate is available and enabled, the US webserver promotes automatically any HTTP request into a HTTPS one, see the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_port_forwarder.erl">us_web_port_forwarder</a> module for that (based on relevant routing rules).</p>
<p>Standard, basic firewall settings are sufficient to enable interactions of US-Web (through LEEC) with Let's Encrypt, as it is the US-Web agent that initiates the TCP connection to Let's Encrypt, which is to check the challenge(s) through regular http accesses done to the webserver expected to be available at the domain of interest.</p>
<p>The US-Web server must be able to write in the web content tree, precisely to write files in the <tt class="docutils literal"><span class="pre">well-known/acme-challenge/</span></tt> subdirectory of the web root.</p>
</div>
</div>
<div class="section" id="planned-enhancements">
<h2><a class="toc-backref" href="#id97">Planned Enhancements</a></h2>
<ul class="simple">
<li>bullet-proof <strong>https support</strong>: certificate management (based on LetsEncrypt in Erlang, and regularly renewed thanks to our embedded scheduler)</li>
<li><strong>Nitrogen</strong> and/or <strong>Zotonic</strong> support, in addition to static websites</li>
</ul>
</div>
<div class="section" id="about-nitrogen-future-support">
<h2><a class="toc-backref" href="#id98">About Nitrogen (future) Support</a></h2>
<ul class="simple">
<li>&quot;<em>It is strongly recommended to catch static files with the static_paths setting. simple_bridge does not serve large static files in an optimal way (it loads the files into memory completely before sending)</em>&quot;</li>
<li><a class="reference external" href="https://rshestakov.wordpress.com/2013/02/17/how-nitrogen-processes-requests/">How Nitrogen processes requests</a></li>
<li><a class="reference external" href="https://rshestakov.wordpress.com/2013/03/03/how-to-add-nitrogen-and-cowboy-as-dependecy-libs-to-your-erlang-application/">How to add Nitrogen and Cowboy as dependency libs to your erlang application</a></li>
</ul>
</div>
<div class="section" id="support">
<h2><a class="toc-backref" href="#id99">Support</a></h2>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be reported to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/issues">issues</a>) or directly at the email address mentioned at the beginning of this document.</p>
</div>
<div class="section" id="please-react">
<h2><a class="toc-backref" href="#id100">Please React!</a></h2>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h2><a class="toc-backref" href="#id101">Ending Word</a></h2>
<p>Have fun with the Universal Webserver!</p>
<div class="figure align-center">
<img alt="Universal Webserver logo" src="us-web-title.png" style="width: 50%;" />
</div>
<p><span class="raw-html"><a name="us-web_bottom"></a></span></p>
</div>
</div>
</div>
</body>
</html>
