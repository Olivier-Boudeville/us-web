<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.20.1: https://docutils.sourceforge.io/" />
<meta content="Universal Webserver" name="keywords" />
<title>Welcome to the Universal Webserver documentation</title>
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="us-web.css" type="text/css" />
<link href="us-web-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="technical-manual-of-the-universal-webserver">
<h1 class="title">Technical Manual of the <tt class="docutils literal">Universal Webserver</tt></h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="universal-webserver_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Universal Webserver documentation</em> <a href="http://us-web.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/us-web/index.html">browse mirror</a> <a href="universal-webserver-technical-manual-english.pdf">get PDF</a> <a href="#universal-webserver_top">go to top</a> <a href="#universal-webserver_toc">go to toc</a> <a href="#universal-webserver_bottom">go to bottom</a> <a href="api-doc/index.html">browse API</a> <a href="https://github.com/Olivier-Boudeville/us-web">go to project</a> <a href="mailto:about(dash)universal-webserver(at)esperide(dot)com?subject=[Universal%20Webserver]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="us-web-title.png" id="responsive-image-medium"></img></span>
</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body"><p class="first">Copyright (C) 2019-2023 Olivier Boudeville</p>
</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><p class="first">about (dash) universal-webserver (at) esperide (dot) com</p>
</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body"><p class="first">Saturday, May 2, 2020</p>
</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body"><p class="first">Thursday, May 18, 2023</p>
</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body"><p class="first">1.1.0</p>
</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body"><p class="first">Stable</p>
</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body"><p class="first">Users and maintainers of the <tt class="docutils literal">Universal Webserver</tt>.</p>
</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body"><p class="first">The <a class="reference external" href="http://us-web.esperide.org/">Universal Webserver</a>, part of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">Universal Server</a> umbrella project, provides a multi-domain, multi-virtualhost webserver integrating various web-related services.</p>
<p>We present here a short overview of these services, to introduce them to newcomers.</p>
<p class="last">The next level of information is either to browse the <a class="reference external" href="api-doc/index.html">US-Web API documentation</a> or simply to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">source files</a>, which are intensely commented and generally straightforward.</p>
</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"></center></span></p>
<p></p>
<p><span class="raw-html"><a name="universal-webserver_toc"></a></span></p>
<div class="contents topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="toc-entry-1">Overview</a></li>
<li><a class="reference internal" href="#easy-testing-of-us-web" id="toc-entry-2">Easy Testing of US-Web</a></li>
<li><a class="reference internal" href="#layer-stack" id="toc-entry-3">Layer Stack</a></li>
<li><a class="reference internal" href="#server-deployment" id="toc-entry-4">Server Deployment</a><ul>
<li><a class="reference internal" href="#native-deployment-recommended" id="toc-entry-5">Native Deployment (recommended)</a><ul>
<li><a class="reference internal" href="#direct-ad-hoc-deployment" id="toc-entry-6">Direct, Ad Hoc Deployment</a></li>
<li><a class="reference internal" href="#deployment-for-systemd-integration-recommended" id="toc-entry-7">Deployment for Systemd Integration (recommended)</a></li>
<li><a class="reference internal" href="#checking-launch-outcome" id="toc-entry-8">Checking Launch Outcome</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deployment-based-on-rebar3" id="toc-entry-9">Deployment based on rebar3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuring-the-universal-webserver" id="toc-entry-10">Configuring the Universal-Webserver</a><ul>
<li><a class="reference internal" href="#in-a-development-setting" id="toc-entry-11">In a Development Setting</a></li>
<li><a class="reference internal" href="#in-a-production-setting" id="toc-entry-12">In a Production Setting</a></li>
<li><a class="reference internal" href="#configuration-files" id="toc-entry-13">Configuration Files</a><ul>
<li><a class="reference internal" href="#us-web-application-base-directory" id="toc-entry-14">US-Web Application Base Directory</a></li>
<li><a class="reference internal" href="#separating-the-us-web-software-from-its-data" id="toc-entry-15">Separating the US-Web Software from its data</a></li>
<li><a class="reference internal" href="#catch-alls-https-challenge-types-and-wildcard-certificates" id="toc-entry-16">Catch-alls, HTTPS, Challenge Types and Wildcard Certificates</a></li>
<li><a class="reference internal" href="#other-configuration-files" id="toc-entry-17">Other Configuration Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#operating-system-settings" id="toc-entry-18">Operating System Settings</a><ul>
<li><a class="reference internal" href="#regarding-authbind" id="toc-entry-19">Regarding <tt class="docutils literal">authbind</tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#running-the-universal-webserver" id="toc-entry-20">Running the Universal-Webserver</a><ul>
<li><a class="reference internal" href="#stopping-any-prior-instance-first" id="toc-entry-21">Stopping any prior instance first</a></li>
<li><a class="reference internal" href="#launching-the-us-web-server" id="toc-entry-22">Launching the US-Web Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-the-us-web-server" id="toc-entry-23">Monitoring the US-Web Server</a><ul>
<li><a class="reference internal" href="#local-monitoring" id="toc-entry-24">Local Monitoring</a><ul>
<li><a class="reference internal" href="#checking-epmd" id="toc-entry-25">Checking EPMD</a></li>
<li><a class="reference internal" href="#overall-local-inquiry" id="toc-entry-26">Overall Local Inquiry</a></li>
<li><a class="reference internal" href="#general-logs" id="toc-entry-27">General Logs</a></li>
<li><a class="reference internal" href="#webserver-logs" id="toc-entry-28">Webserver Logs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remote-monitoring" id="toc-entry-29">Remote Monitoring</a><ul>
<li><a class="reference internal" href="#http-client-check" id="toc-entry-30">HTTP Client Check</a></li>
<li><a class="reference internal" href="#trace-listener-check" id="toc-entry-31">Trace Listener Check</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remote-action" id="toc-entry-32">Remote Action</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nitrogen-support" id="toc-entry-33">Nitrogen Support</a><ul>
<li><a class="reference internal" href="#deployment" id="toc-entry-34">Deployment</a><ul>
<li><a class="reference internal" href="#deployment-of-a-nitrogen-enabled-us-web" id="toc-entry-35">Deployment of a Nitrogen-enabled US-Web</a></li>
<li><a class="reference internal" href="#deployment-of-the-nitrogen-based-website-application" id="toc-entry-36">Deployment of the Nitrogen-based website / application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration" id="toc-entry-37">Configuration</a></li>
<li><a class="reference internal" href="#nitrogen-related-information" id="toc-entry-38">Nitrogen-related Information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extra-features" id="toc-entry-39">Extra Features</a><ul>
<li><a class="reference internal" href="#auto-generated-meta-website" id="toc-entry-40">Auto-generated Meta Website</a></li>
<li><a class="reference internal" href="#icon-favicon-management" id="toc-entry-41">Icon (favicon) Management</a></li>
<li><a class="reference internal" href="#css-management" id="toc-entry-42">CSS Management</a></li>
<li><a class="reference internal" href="#error-404-management" id="toc-entry-43">Error 404 Management</a></li>
<li><a class="reference internal" href="#site-customisation" id="toc-entry-44">Site Customisation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-recommendations" id="toc-entry-45">Usage Recommendations</a></li>
<li><a class="reference internal" href="#licence" id="toc-entry-46">Licence</a></li>
<li><a class="reference internal" href="#current-stable-version-download" id="toc-entry-47">Current Stable Version &amp; Download</a><ul>
<li><a class="reference internal" href="#using-cutting-edge-git" id="toc-entry-48">Using Cutting-Edge GIT</a></li>
<li><a class="reference internal" href="#otp-considerations" id="toc-entry-49">OTP Considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting" id="toc-entry-50">Troubleshooting</a><ul>
<li><a class="reference internal" href="#start-up-failure" id="toc-entry-51">Start-up Failure</a></li>
<li><a class="reference internal" href="#certification-generation-issues" id="toc-entry-52">Certification Generation Issues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hints" id="toc-entry-53">Hints</a><ul>
<li><a class="reference internal" href="#development-vs-production-mode" id="toc-entry-54">Development vs Production Mode</a></li>
<li><a class="reference internal" href="#development-hints" id="toc-entry-55">Development Hints</a><ul>
<li><a class="reference internal" href="#operating-directly-from-within-the-rebar-build-tree" id="toc-entry-56">Operating directly from within the rebar build tree</a></li>
<li><a class="reference internal" href="#operating-from-checkouts-build-trees" id="toc-entry-57">Operating from <tt class="docutils literal">_checkouts</tt> build trees</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-hints" id="toc-entry-58">Configuration Hints</a><ul>
<li><a class="reference internal" href="#batch-mode" id="toc-entry-59">Batch Mode</a></li>
<li><a class="reference internal" href="#location-of-applications" id="toc-entry-60">Location of Applications</a></li>
<li><a class="reference internal" href="#system-related-hints" id="toc-entry-61">System-related Hints</a></li>
<li><a class="reference internal" href="#web-related-hints" id="toc-entry-62">Web-related hints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#execution-hints" id="toc-entry-63">Execution Hints</a></li>
<li><a class="reference internal" href="#monitoring-hints" id="toc-entry-64">Monitoring Hints</a><ul>
<li><a class="reference internal" href="#in-terms-of-unix-processes" id="toc-entry-65">In terms of (UNIX) Processes</a></li>
<li><a class="reference internal" href="#trace-monitoring" id="toc-entry-66">Trace Monitoring</a></li>
<li><a class="reference internal" href="#node-test-connection" id="toc-entry-67">Node Test &amp; Connection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#forcing-certificate-renewal-without-restarting-the-server" id="toc-entry-68">Forcing Certificate Renewal Without Restarting the Server</a></li>
<li><a class="reference internal" href="#safer-us-web-updates-testing-a-new-instance-first-out-of-the-loop" id="toc-entry-69">Safer US-Web Updates: Testing a New Instance First Out of the Loop</a><ul>
<li><a class="reference internal" href="#objective" id="toc-entry-70">Objective</a></li>
<li><a class="reference internal" href="#test-installation" id="toc-entry-71">Test Installation</a></li>
<li><a class="reference internal" href="#test-configuration" id="toc-entry-72">Test Configuration</a></li>
<li><a class="reference internal" href="#firewall-configuration" id="toc-entry-73">Firewall Configuration</a></li>
<li><a class="reference internal" href="#test-code-updates" id="toc-entry-74">Test Code Updates</a></li>
<li><a class="reference internal" href="#launching-the-test-server" id="toc-entry-75">Launching the Test Server</a></li>
<li><a class="reference internal" href="#testing-it" id="toc-entry-76">Testing it</a></li>
<li><a class="reference internal" href="#test-teardown" id="toc-entry-77">Test Teardown</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#standard-log-generation-analysis" id="toc-entry-78">Standard Log Generation &amp; Analysis</a><ul>
<li><a class="reference internal" href="#web-analytics-software-choice-of-tool" id="toc-entry-79">Web Analytics Software: Choice of Tool</a></li>
<li><a class="reference internal" href="#log-format" id="toc-entry-80">Log Format</a></li>
<li><a class="reference internal" href="#awstats-management" id="toc-entry-81">Awstats Management</a><ul>
<li><a class="reference internal" href="#awstats-installation" id="toc-entry-82">Awstats Installation</a></li>
<li><a class="reference internal" href="#awstats-configuration" id="toc-entry-83">Awstats Configuration</a></li>
<li><a class="reference internal" href="#awstats-troubleshooting" id="toc-entry-84">Awstats Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#geolocation-with-awstats" id="toc-entry-85">Geolocation with Awstats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#managing-public-key-certificates" id="toc-entry-86">Managing Public-Key Certificates</a><ul>
<li><a class="reference internal" href="#x-509-certificates" id="toc-entry-87">X.509 Certificates</a></li>
<li><a class="reference internal" href="#let-s-encrypt" id="toc-entry-88">Let's Encrypt</a></li>
<li><a class="reference internal" href="#us-web-mode-of-operation" id="toc-entry-89">US-Web Mode of Operation</a><ul>
<li><a class="reference internal" href="#for-mono-domain-certificates" id="toc-entry-90">For mono-domain certificates</a></li>
<li><a class="reference internal" href="#for-wildcard-certificates" id="toc-entry-91">For wildcard certificates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settings" id="toc-entry-92">Settings</a></li>
<li><a class="reference internal" href="#https-troubleshooting" id="toc-entry-93">HTTPS Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#planned-enhancements" id="toc-entry-94">Planned Enhancements</a><ul>
<li><a class="reference internal" href="#reverse-proxy" id="toc-entry-95">Reverse Proxy</a><ul>
<li><a class="reference internal" href="#purpose" id="toc-entry-96">Purpose</a></li>
<li><a class="reference internal" href="#challenges" id="toc-entry-97">Challenges</a></li>
<li><a class="reference internal" href="#implementations" id="toc-entry-98">Implementations</a></li>
<li><a class="reference internal" href="#us-web-reverse-proxy" id="toc-entry-99">US-Web Reverse Proxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#support" id="toc-entry-100">Support</a></li>
<li><a class="reference internal" href="#please-react" id="toc-entry-101">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="toc-entry-102">Ending Word</a></li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#toc-entry-1">Overview</a></h1>
<p>We present here a short overview of the services offered by the <em>Universal Webserver</em>, to introduce them to newcomers.</p>
<p>The goal of <strong>US-Web</strong> is to provide an integrated, extensible web framework in order:</p>
<ul class="simple">
<li>to better operate websites based on <a class="reference external" href="https://en.wikipedia.org/wiki/Virtual_hosting">virtual hosting</a>, so that a networked computer can serve as many websites corresponding to as many domains as wanted; this involves reading and interpreting vhost and other configuration information, handling properly 404 errors, producing access logs that are adequate for web analytics, rotating all logs, using/generating/renewing automatically SSL certificates, etc.</li>
<li>to link to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">Universal Server</a> optionally (i.e. if available, knowing both should be able to run in the absence of the other), in order to offer a web front-end for it</li>
</ul>
<p>Beyond this document, the next level of information about US-Web is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/src">source files</a>, which are intensely commented and generally straightforward.</p>
<p>The project repository is located <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">here</a>.</p>
</div>
<div class="section" id="easy-testing-of-us-web">
<h1><a class="toc-backref" href="#toc-entry-2">Easy Testing of US-Web</a></h1>
<p>Provided that no server already runs at TCP port #8080, just downloading the <a class="reference external" href="https://raw.githubusercontent.com/Olivier-Boudeville/us-web/master/priv/bin/get-us-web-from-sources.sh">get-us-web-from-sources.sh</a> script and running it with no specific parameter (e.g. <tt class="docutils literal">sh <span class="pre">get-us-web-from-sources.sh</span></tt>, as a normal user) should suffice.</p>
<p>This should result in US-Web being cloned and built, and a test server (if requested, see the <tt class="docutils literal"><span class="pre">--help</span></tt> script option for usage) should be configured and run. It should be then available at <a class="reference external" href="http://localhost:8080">http://localhost:8080</a>.</p>
<p>Another way of testing, this time from a US-Web Git compiled with its prerequisites, is simply to execute <tt class="docutils literal">make debug</tt> from its root.</p>
<p>See also the <a class="reference internal" href="#server-deployment">Server Deployment</a> section for, beyond a mere testing of US-Web, a setting up of it in a production context.</p>
</div>
<div class="section" id="layer-stack">
<h1><a class="toc-backref" href="#toc-entry-3">Layer Stack</a></h1>
<p>From the highest level to the lowest, as summarised <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">here</a>, a (free software) stack involving the Universal Webserver usually comprises:</p>
<ul class="simple">
<li>the <em>Universal Webserver</em> services themselves (i.e. this <a class="reference external" href="http://us-web.esperide.org/">US-Web</a> layer)</li>
<li><a class="reference external" href="https://github.com/ninenines/cowboy">Cowboy</a> (for a small, fast and modern web framework)</li>
<li>[optional] <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/">LEEC</a> (for the management of Let's Encrypt certificates)</li>
<li>[optional] <a class="reference external" href="http://www.awstats.org/">Awstats</a> (for the analysis of access log files)</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a> (for US base facilities)</li>
<li><a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> (for advanced runtime traces)</li>
<li><a class="reference external" href="http://wooper.esperide.org">Ceylan-WOOPER</a> (for OOP)</li>
<li><a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> (as a general-purpose Erlang toolbox)</li>
<li><a class="reference external" href="http://erlang.org">Erlang/OTP</a> (for the compiler and runtime)</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Linux">GNU/Linux</a> (for a suitable, reliable operating system of course)</li>
</ul>
<p>The shorthand for the <tt class="docutils literal">Universal Webserver</tt> (a.k.a. <tt class="docutils literal"><span class="pre">US-Web</span></tt>) is <tt class="docutils literal">uw</tt>.</p>
<p></p>
</div>
<div class="section" id="server-deployment">
<h1><a class="toc-backref" href="#toc-entry-4">Server Deployment</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please ensure that no prior instance of US-Web is already running, otherwise the new one will not be able to auto-launch, with an error message like: <tt class="docutils literal">Protocol 'inet_tcp': the name us_web&#64;YOUR_SERVER seems to be in use by another Erlang node</tt>. Refer to the <a class="reference internal" href="#troubleshooting">Troubleshooting</a> section for further guidance.</p>
</div>
<p>In all cases, if opting for the generation of certificates, in order to avoid hitting, in case of problem, any rate limit enforced by the ACME servers, we recommend to perform first a &quot;dry run&quot; by setting in your US-Web configuration file <tt class="docutils literal">{certificate_mode, development}</tt> so that the staging ACME infrastructure is targeted first, leading only to temporary certificates.</p>
<p>If the whole deployment procedure went smoothly, then only switch back to <tt class="docutils literal">{certificate_mode, production}</tt> and restart US-Web, in order to rely on the actual ACME servers and thus obtain the intended final certificates.</p>
<div class="section" id="native-deployment-recommended">
<h2><a class="toc-backref" href="#toc-entry-5">Native Deployment (recommended)</a></h2>
<p>This procedure relies on our <em>native</em> build/run system, which is the only one that is officially supported in the context of US-Web, and involves only two steps.</p>
<p><strong>First step</strong> is to:</p>
<ul class="simple">
<li>create a <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt> directory in which a relevant US configuration file (<tt class="docutils literal">us.config</tt>) is added, referencing a suitable US-Web configuration file (e.g. <tt class="docutils literal"><span class="pre">foobar-us-web.config</span></tt>) located in the same directory; refer to the <a class="reference internal" href="#configuring-the-universal-webserver">Configuring the Universal-Webserver</a> section</li>
<li>transfer to the target server our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-native-build.sh">deploy-us-web-native-build.sh</a> script (in a US-Web clone, it is located in <tt class="docutils literal">priv/bin</tt>), possibly simply at the root of one's normal user</li>
<li>ensure that no prior webserver is running at the target port(s) (otherwise specify the <tt class="docutils literal"><span class="pre">--no-launch</span></tt> option below)</li>
</ul>
<p>After deployment the installation itself will be located by default in the <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-native</span></tt> directory.</p>
<p>Step #2 exists in two versions, either based on a direct launching or, preferably, on one managed by Systemd.</p>
<div class="section" id="direct-ad-hoc-deployment">
<h3><a class="toc-backref" href="#toc-entry-6">Direct, Ad Hoc Deployment</a></h3>
<p>This <strong>second step</strong> boils down to executing (as a normal user - the sudo permissions will be requested only whenever necessary) our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-native-build.sh">deploy-us-web-native-build.sh</a> script, with no specific argument.</p>
</div>
<div class="section" id="deployment-for-systemd-integration-recommended">
<h3><a class="toc-backref" href="#toc-entry-7">Deployment for Systemd Integration (recommended)</a></h3>
<p>If relying on <tt class="docutils literal">systemctl</tt> (hence on our <tt class="docutils literal"><span class="pre">us-web-as-native-build.service</span></tt> file), the following procedure shall be preferred for this <strong>second step</strong>:</p>
<pre class="code bash literal-block">
<span class="c1"># Get ready first (as a regular user; sudo permissions to be
# requested only whenever necessary):
#
</span>$<span class="w"> </span>./deploy-us-web-native-build.sh<span class="w"> </span>--no-launch<span class="w">

</span><span class="c1"># Useful, as Systemd shall detect the update of the US-Web service file:
</span>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload<span class="w">

</span><span class="c1"># Then stop properly any prior US-Web instance:
</span>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>us-web-as-native-build.service<span class="w">

</span><span class="c1"># If EPMD still thinks a previous US-Web instance is running:
# (unlikely to be needed, and could impact any other running
# Erlang program, so be cautious...)
#
#$ sudo killall epmd
</span><span class="w">
</span><span class="c1"># Relaunch US-Web, and initiate the certificate renewal process:
</span>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>us-web-as-native-build.service
</pre>
<p>Then, as a first check of that launch, one may execute:</p>
<pre class="literal-block">
$ sudo systemctl status us-web-as-native-build.service
</pre>
<p>See the next section for more in-depth checking and monitoring.</p>
</div>
<div class="section" id="checking-launch-outcome">
<h3><a class="toc-backref" href="#toc-entry-8">Checking Launch Outcome</a></h3>
<p>If having requested the renewal of SSL certificates (the <tt class="docutils literal">certificate_support</tt> entry of the US-Web configuration file being set to <tt class="docutils literal">renew_certificates</tt>), incoming HTTP requests will be directly served yet will be redirected to HTTPS ones that will complete successfully <em>only</em> once proper certificates will have been obtained (hence after a few dozens of seconds after server startup).</p>
<p>These certificates can be checked (e.g. in terms of timestamps) in the <tt class="docutils literal">certificates</tt> subdirectory of the one designated by the <tt class="docutils literal">us_web_data_dir</tt> entry (typically in <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-data/certificates</span></tt>).</p>
<p>Finally, from a client host, one may also check the availability of the target webserver(s); refer to the <a class="reference internal" href="#remote-monitoring">Remote Monitoring</a> section for that.</p>
</div>
</div>
<div class="section" id="deployment-based-on-rebar3">
<h2><a class="toc-backref" href="#toc-entry-9">Deployment based on rebar3</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We currently do <em>not</em> recommend using rebar3 for US-Web, as we encountered a lot of difficulties regarding build and release. So, at least for the moment, we dropped the use of rebar3 and focused only on our native build/run system.</p>
</div>
<p>If wanting nevertheless to rely on rebar3, the <tt class="docutils literal">prod</tt> profile defined in the context of <tt class="docutils literal">rebar3</tt> shall be used.</p>
<p>Currently we prefer re-using the (supposedly already installed) local Erlang environment on the server (to be shared across multiple services), so by default ERTS is <em>not</em> included in a US-Web release.</p>
<p>Sources are not included either, as we prefer re-rolling a release to editing and compiling code directly on a server.</p>
<p>To generate from scratch such a (mostly) standalone release, one may use:</p>
<pre class="literal-block">
$ make release-prod
</pre>
<p>It should generate a tarball such as <tt class="docutils literal"><span class="pre">us_web-x.y.z.tar.gz</span></tt></p>
<p>The <tt class="docutils literal"><span class="pre">export-release</span></tt> make target allows in the same movement to lightly update a pre-existing release and also to transfer it to any target server, designated by setting the <tt class="docutils literal">WEB_SRV</tt> (make or environment) variable to the FQDN of this server.</p>
<p>So we recommend running:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>make<span class="w"> </span>export-release<span class="w">
 </span>Generating<span class="w"> </span>rebar3<span class="w"> </span>us_web.app<span class="w"> </span>file<span class="w">
 </span>Compiling<span class="w"> </span>us_web<span class="w"> </span>from<span class="w"> </span>XXX/us_web<span class="w">
 </span><span class="o">===</span>&gt;<span class="w"> </span>Verifying<span class="w"> </span>dependencies...<span class="w">
 </span><span class="o">===</span>&gt;<span class="w"> </span>Compiling<span class="w"> </span>myriad<span class="w">
 </span>Hiding<span class="w"> </span>unsupported<span class="w"> </span>sources<span class="w">
 </span>Populating<span class="w"> </span>the<span class="w"> </span>include<span class="w"> </span>symlinks<span class="w">
 </span><span class="o">[</span>...<span class="o">]</span>
</pre>
<p>We recommend installing a release in <tt class="docutils literal"><span class="pre">REL_BASE_ROOT=/opt/universal-server</span></tt>:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>mv<span class="w"> </span>/tmp/us_web-x.y.z.tar.gz<span class="w"> </span><span class="si">${</span><span class="nv">REL_BASE_ROOT</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">REL_BASE_ROOT</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span>tar<span class="w"> </span>xvf<span class="w"> </span>us_web-x.y.z.tar.gz
</pre>
<p>Then various steps are necessary in order to have a functional release running satisfactorily.</p>
<p>We automated the full deployment process of US-Web on a server for that: once the release has been transferred to that server (possibly thanks to the aforementioned <tt class="docutils literal"><span class="pre">export-release</span></tt> target, possibly to the <tt class="docutils literal">/tmp</tt> directory of that server), one may rely on our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-release.sh">deploy-us-web-release.sh</a> script. One may also just take inspiration from it in order to devise one's deployment scheme.</p>
<p>Let's say from now on that the UNIX name chosen for the US user is <tt class="docutils literal"><span class="pre">us-user</span></tt>, the one of the US-web user is <tt class="docutils literal"><span class="pre">us-web-user</span></tt> and the US group (containing both users, and possibly only them) is <tt class="docutils literal"><span class="pre">us-group</span></tt> (one should keep in mind that <tt class="docutils literal"><span class="pre">US-Web</span></tt> is a specialization of the <tt class="docutils literal">US</tt> framework).</p>
<p>Using that script boils down to running, as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>/tmp/deploy-us-web-release.sh<span class="w">
</span>Detected<span class="w"> </span>US-Web<span class="w"> </span>version:<span class="w"> </span><span class="s1">'x.y.z'</span>.<span class="w">
</span>Trying<span class="w"> </span>to<span class="w"> </span>stop<span class="w"> </span>gracefully<span class="w"> </span>any<span class="w"> </span>prior<span class="w"> </span>release<span class="w"> </span><span class="k">in</span><span class="w"> </span>us_web-x.y.z.<span class="w">
</span>Removing<span class="w"> </span>already-existing<span class="w"> </span>us_web-x.y.z.<span class="w">
</span>US-Web<span class="w"> </span>release<span class="w"> </span>ready<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">'/opt/universal-server/us_web-x.y.z/bin/us_web'</span>.<span class="w">
</span>Changing,<span class="w"> </span>from<span class="w"> </span><span class="s1">'/opt/universal-server/us_web-x.y.z'</span>,<span class="w"> </span>the<span class="w"> </span>owner<span class="w"> </span>of<span class="w"> </span>release<span class="w">
</span>files<span class="w"> </span>to<span class="w"> </span><span class="s1">'us-web-user'</span><span class="w"> </span>and<span class="w"> </span>their<span class="w"> </span>group<span class="w"> </span>to<span class="w"> </span><span class="s1">'us-group'</span>.<span class="w">
</span><span class="o">(</span>no<span class="w"> </span>auto-launch<span class="w"> </span>enabled<span class="o">)</span>
</pre>
<p>Note that the goal of that deployment phase is to start from a clean state, and as such it will try to stop any already running US-Web instance (for all possible versions thereof).</p>
<p>Then US-Web is fully <em>deployed</em>. Once properly <em>configured</em>, it will be able to be <em>launched</em> for good.</p>
<p>Some related information are specified below.</p>
</div>
</div>
<div class="section" id="configuring-the-universal-webserver">
<h1><a class="toc-backref" href="#toc-entry-10">Configuring the Universal-Webserver</a></h1>
<p>As explained in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/start-us-web.sh">start-us-web.sh</a> and in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USWebConfigServer.erl">class_USWebConfigServer.erl</a>, the US configuration files will be searched through various locations.</p>
<p>The main, overall US configuration file, <tt class="docutils literal">us.config</tt>, is found based on a series of directories that are gone through in an orderly manner; the first directory to host such a file becomes <em>the</em> (single) US configuration directory.</p>
<p>The other US-related configuration files (e.g. any <tt class="docutils literal"><span class="pre">us-web.config</span></tt>) are referenced directly from the main one (<tt class="docutils literal">us.config</tt>), designated there through specific keys (e.g. <tt class="docutils literal">us_web_config_filename</tt>); they may be either absolutely defined, or relatively to the aforementioned US configuration directory.</p>
<p>Let's name <tt class="docutils literal">US_CFG_ROOT</tt> the actual directory in which they all lie; it is typically either <tt class="docutils literal"><span class="pre">~/.config/universal-server/</span></tt> (in development mode), or <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server/</span></tt> (in production mode).</p>
<p>Note that, as these files might contain sensitive information (e.g. Erlang cookies), they shall be duly protected. Indeed, in terms of permissions, we should have <tt class="docutils literal">640</tt>, supposing that the <tt class="docutils literal">us.config</tt> designates, in its <tt class="docutils literal">us_web_config_filename</tt> entry, <tt class="docutils literal"><span class="pre">foobar-us-web-for-production.config</span></tt> as the name of the US-Web configuration file <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>:</p>
<pre class="code bash literal-block">
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>us-user<span class="w">     </span>us-group<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>us.config<span class="w">
</span>-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>us-web-user<span class="w"> </span>us-group<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>foobar-us-web-for-production.config
</pre>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>They shall be in the same <tt class="docutils literal">US_CFG_ROOT</tt> directory (discussed below), and may be symbolic links.</td></tr>
</tbody>
</table>
<p>Finally, if being able to rely on multiple, different US configuration directories is necessary in order to be able to launch multiple US-Web instances (these configurations can then register the managers involved - typically the US-Web Configuration server - under different names), only a single node can be used per EPMD instance as, by default, such a node is named <tt class="docutils literal">us_web</tt> (two US-Web instances would then clash at this level).</p>
<p>So, in order to run multiple US-Web instances (e.g. one in production, one for testing) on a given host, they shall be multiplexed on different EPMD ports (see the <tt class="docutils literal">epmd_port</tt> key of the US and US-Web configuration files; as a result, different <tt class="docutils literal"><span class="pre">universal-server</span></tt> configuration directories shall then be defined and used).</p>
<div class="section" id="in-a-development-setting">
<h2><a class="toc-backref" href="#toc-entry-11">In a Development Setting</a></h2>
<p>The US main configuration file, <tt class="docutils literal">us.config</tt>, is in a directory (<tt class="docutils literal">US_CFG_ROOT</tt>) that is <tt class="docutils literal"><span class="pre">~/.config/universal-server/</span></tt> here. This US-level configuration file will reference (through its <tt class="docutils literal">us_web_config_filename</tt> entry) a US-Web counterpart configuration file, probably in the same directory.</p>
<p>The US-Web configuration file may define a <tt class="docutils literal">us_web_app_base_dir</tt> entry. If not, this application directory will then be found thanks to the <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> environment variable (if defined, typically through one's <tt class="docutils literal"><span class="pre">~/.bashrc</span></tt>); otherwise, as a last resort, an attempt to guess it will be done.</p>
<p>The US webserver may be then run thanks to <tt class="docutils literal">make debug</tt>, from the relevant <tt class="docutils literal">us_web</tt> directory (typically the root of a GIT clone located in the user's directory).</p>
<p>In such a development context, in <tt class="docutils literal">us_web/conf/sys.config</tt>, we recommend to leave the batch mode disabled (just let the default <tt class="docutils literal">{is_batch,false}</tt>), so that a direct, graphical trace supervision is enabled (provided that a relevant trace supervisor is available, see <a class="reference external" href="http://traces.esperide.org/#trace-supervision-browsing">Ceylan-Traces</a> for that).</p>
</div>
<div class="section" id="in-a-production-setting">
<h2><a class="toc-backref" href="#toc-entry-12">In a Production Setting</a></h2>
<p>The start/stop management scripts will be run initially as root (possibly through <tt class="docutils literal">systemd</tt>) and must access the <tt class="docutils literal">us.config</tt> file. Then, once run, <tt class="docutils literal">us_web</tt> will most probably switch to a dedicated user (see the <tt class="docutils literal">us_web_username</tt> entry in the US-Web configuration file), who will need in turn to be able to read the <tt class="docutils literal">us.config</tt> file and any related one (e.g. for US-Web, here supposed to be named <tt class="docutils literal"><span class="pre">foobar-us-web-for-production.config</span></tt>).</p>
<p>As a result, a relevant configuration directory (denoted <tt class="docutils literal">US_CFG_ROOT</tt> in this document), in that shared setting, is the standard <tt class="docutils literal">/etc/xdg</tt> one, resulting in the <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt> directory to be used.</p>
<p>As mentioned, care must be taken so that <tt class="docutils literal">root</tt> and also the US and US-Web users can read the content of that directory - at least the US and US-Web configuration files in it - and that the other users cannot.</p>
<p>For that, a dedicated <tt class="docutils literal"><span class="pre">us-group</span></tt> group can be created, and any web user (e.g. <tt class="docutils literal"><span class="pre">us-web-user</span></tt>) shall belong to that group. For example:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>id<span class="w"> </span>us-web-user<span class="w">
</span><span class="nv">uid</span><span class="o">=</span><span class="m">1002</span><span class="o">(</span>us-web-user<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">1002</span><span class="o">(</span>us-web-user<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">1002</span><span class="o">(</span>us-web-user<span class="o">)</span>,<span class="w">
 </span><span class="m">1007</span><span class="o">(</span>us-group<span class="o">)</span>
</pre>
<p>Then, in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>, for the US and US-Web configuration files:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>chown<span class="w"> </span>us-user<span class="w"> </span>us.config<span class="w">
</span>$<span class="w"> </span>chown<span class="w"> </span>us-web-user<span class="w"> </span>foobar-us-web-for-production.config<span class="w">

</span>$<span class="w"> </span><span class="nv">us_files</span><span class="o">=</span><span class="s2">&quot;us.config foobar-us-web-for-production.config&quot;</span><span class="w">
</span>$<span class="w"> </span>chgrp<span class="w"> </span>us-group<span class="w"> </span><span class="si">${</span><span class="nv">us_files</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span>chmod<span class="w"> </span><span class="m">640</span><span class="w"> </span><span class="si">${</span><span class="nv">us_files</span><span class="si">}</span><span class="w">

</span>$<span class="w"> </span>chgrp<span class="w"> </span>us-group<span class="w"> </span>/etc/xdg/universal-server<span class="w">
</span>$<span class="w"> </span>chmod<span class="w"> </span><span class="m">700</span><span class="w"> </span>/etc/xdg/universal-server
</pre>
<p>We recommend directly setting the <tt class="docutils literal">us_web_app_base_dir</tt> configuration entry to the relevant, absolute path.</p>
<p>Let's name here <tt class="docutils literal">US_WEB_REL_ROOT</tt> the root of the US-Web release of interest (e.g. corresponding to <tt class="docutils literal"><span class="pre">${REL_BASE_ROOT}/us_web-latest/</span></tt>) and <tt class="docutils literal">US_WEB_APP_ROOT</tt> the root of the corresponding US-Web application (e.g. corresponding to <tt class="docutils literal"><span class="pre">${US_WEB_REL_ROOT}/lib/us_web-latest/</span></tt>).</p>
<p>A <tt class="docutils literal">systemd</tt> service shall be declared for US-Web, in <tt class="docutils literal">/etc/systemd/system</tt>; creating there, as root, a symbolic link to <tt class="docutils literal"><span class="pre">${US_WEB_APP_ROOT}/priv/conf/us-web.service</span></tt> will suffice.</p>
<p>This service requires <tt class="docutils literal"><span class="pre">start-us-web.sh</span></tt> and <tt class="docutils literal"><span class="pre">stop-us-web.sh</span></tt>. Adding for user convenience <tt class="docutils literal"><span class="pre">get-us-web-status.sh</span></tt>, they should all be symlinked that way, still as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/usr/local/bin<span class="w">
</span>$<span class="w"> </span><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span>start-us-web.sh<span class="w"> </span>stop-us-web.sh<span class="w"> </span>get-us-web-status.sh<span class="p">;</span><span class="w"> </span><span class="se">\
</span><span class="w">  </span><span class="k">do</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">US_WEB_APP_ROOT</span><span class="si">}</span>/priv/bin/<span class="nv">$f</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre>
<p>The log base directory (see the <tt class="docutils literal">log_base_directory</tt> entry) shall be created and writable; for example:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nv">LOG_DIR</span><span class="o">=</span>/var/log/universal-server<span class="w">
</span>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">LOG_DIR</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span>chown<span class="w"> </span>us-user<span class="w"> </span><span class="si">${</span><span class="nv">LOG_DIR</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span>chgrp<span class="w"> </span>us-group<span class="w"> </span><span class="si">${</span><span class="nv">LOG_DIR</span><span class="si">}</span><span class="w">
</span>$<span class="w"> </span>chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span><span class="si">${</span><span class="nv">LOG_DIR</span><span class="si">}</span>
</pre>
<p>In such a production context, in <tt class="docutils literal">sys.config</tt> (typically located in <tt class="docutils literal"><span class="pre">${US_WEB_REL_ROOT}/releases/latest-release</span></tt>), we recommend to enable batch mode (just set <tt class="docutils literal">{is_batch,true}</tt>), so that by default no direct, graphical trace supervision is triggered (a server usually does not have a X server anyway).</p>
<p>Instead the traces may then be supervised and browsed remotely (at any time, and any number of times), from a graphical client (provided that a relevant trace supervisor is available locally, see <a class="reference external" href="http://traces.esperide.org/#trace-supervision-browsing">Ceylan-Traces</a> for that), by running the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/monitor-us-web.sh">monitor-us-web.sh</a> script.</p>
<p>For that the relevant settings (notably which server host shall be targeted, with what cookie) shall be stored in that client, in a <tt class="docutils literal"><span class="pre">us-monitor.config</span></tt> file that is typically located in the <tt class="docutils literal"><span class="pre">~/.config/universal-server</span></tt> directory.</p>
</div>
<div class="section" id="configuration-files">
<span id="configuration-file"></span><h2><a class="toc-backref" href="#toc-entry-13">Configuration Files</a></h2>
<p>A <tt class="docutils literal">us.config</tt> file <em>referencing</em> a suitable US-Web configuration file will be needed; most of the behaviour of the US-Web server is determined by this last configuration file.</p>
<p>As the US-related configuration files are heavily commented, proceeding based on examples in the simplest approach <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[2]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[2]</a></td><td>The second best approach being to have directly a look at the code reading them, see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USConfigServer.erl">class_USConfigServer.erl</a> for us.config and <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USWebConfigServer.erl">class_USWebConfigServer.erl</a> for its US-Web counterpart.</td></tr>
</tbody>
</table>
<p>Refer for that at this (US) <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">us.config example</a> and at this <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">US-Web counterpart example</a>.</p>
<p>In a nutshell, this US-Web configuration files allows unsurprisingly to specify all web-related settings, regarding users, directory locations, options such as ports, log analysis or certificate management and, most importantly, the routes.</p>
<p>Defining routes allows to tell what it the web root directory <a class="footnote-reference" href="#footnote-3" id="footnote-reference-3">[3]</a> to serve for each given client-specified URL (in general, only the hostname part is of interest here), based on pattern-matching.</p>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[3]</a></td><td>A web root directory is either specified as an absolute path, otherwise it is relative to a <tt class="docutils literal">default_web_root</tt> entry to be specified in the US-Web configuration file.</td></tr>
</tbody>
</table>
<p>Such a route definition consists mostly on enumerating each hostname that is to manage (e.g. <tt class="docutils literal">&quot;foobar.org&quot;</tt> - knowing that the <tt class="docutils literal">default_domain_catch_all</tt> atom designates all hostnames that could not be matched specifically otherwise) and enumerating then all the virtual hosts to manage for this domain (e.g. the <tt class="docutils literal">&quot;hurricane&quot;</tt> host, whose FQDN is thus <tt class="docutils literal">hurricane.foobar.org</tt> - knowing that the <tt class="docutils literal">default_vhost_catch_all</tt> atom designates all hostnames that could not be matched specifically otherwise, in the form <tt class="docutils literal">*.foobar.org</tt>, and that the <tt class="docutils literal">without_vhost</tt> atom designates the hostname itself, i.e. <tt class="docutils literal">foobar.org</tt> ).</p>
<p>For example:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="w"> </span><span class="n">default_web_root</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/web-storage/www&quot;</span><span class="w"> </span><span class="p">}.</span><span class="w">

</span><span class="c">%{ log_analysis, awstats }.</span><span class="w">

</span><span class="p">{</span><span class="w"> </span><span class="n">certificate_support</span><span class="p">,</span><span class="w"> </span><span class="n">use_existing_certificates</span><span class="w"> </span><span class="p">}.</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="n">certificate_mode</span><span class="p">,</span><span class="w"> </span><span class="n">production</span><span class="w"> </span><span class="p">}.</span><span class="w">

</span><span class="c">% Use 'dns-01' if wanting wildcard certificates:</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="n">challenge_type</span><span class="p">,</span><span class="w"> </span><span class="n">'http-01'</span><span class="w"> </span><span class="p">}.</span><span class="w">

</span><span class="c">% With 'dns-01', the DNS provider must be specified:</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="n">dns_provider</span><span class="p">,</span><span class="w"> </span><span class="n">ovh</span><span class="w"> </span><span class="p">}.</span><span class="w">

</span><span class="p">{</span><span class="w"> </span><span class="n">routes</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">

  </span><span class="c">% Note that the first hostname listed will be, regarding</span><span class="w">
  </span><span class="c">% https (SNI), the main, default one:</span><span class="w">

  </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;foobar.org&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">

      </span><span class="c">% So any content requested regarding the www.foobar.org</span><span class="w">
      </span><span class="c">% FQDN (e.g. http://www.foobar.org/index.html) will be</span><span class="w">
      </span><span class="c">% looked-up relatively to the</span><span class="w">
      </span><span class="c">% /var/web-storage/www/Foobar-main directory:</span><span class="w">
      </span><span class="c">%</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;www&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Foobar-main&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;club&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Foobar-club&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;archives&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/web-storage/Archives-for-Foobar&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">

      </span><span class="c">% If just the domain is specified:</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="n">without_vhost</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Foobar&quot;</span><span class="w"> </span><span class="p">}</span><span class="w">

      </span><span class="c">% With https, catch-all shall be best avoided:</span><span class="w">
      </span><span class="c">%{ default_vhost_catch_all, &quot;Foobar&quot; }</span><span class="w">

                  </span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">

  </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;foobar.net&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="c">% (similar rules may be defined)</span><span class="w">
                  </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w">

  </span><span class="c">% Best avoided as well with https:</span><span class="w">
  </span><span class="c">%{ default_domain_catch_all, [</span><span class="w">
  </span><span class="c">%</span><span class="w">
  </span><span class="c">%           { default_vhost_catch_all, &quot;Foobar&quot; }</span><span class="w">
  </span><span class="c">%</span><span class="w">
  </span><span class="c">%                ] }</span><span class="w">

        </span><span class="p">]</span><span class="w">

</span><span class="p">}.</span>
</pre>
<div class="section" id="us-web-application-base-directory">
<h3><a class="toc-backref" href="#toc-entry-14">US-Web Application Base Directory</a></h3>
<p>This directory allows US-Web to select the various runtime elements it is to use.</p>
<p>This <strong>US-Web Application Base Directory</strong> may be set in the US-Web configuration file thanks to its (optional) <tt class="docutils literal">us_web_app_base_dir</tt> entry.</p>
<p>If not set there, US-Web will try to use the  <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> environment variable instead.</p>
<p>If not usable either, US-Web will try to determine this directory automatically, based on how the server is launched (with our native deployment approach or as an OTP release).</p>
<p>Of course failing to resolve a proper application base directory will result in a fatal launch error to be reported at start-up.</p>
<p>Let's designate this directory from now on with the <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> pseudo-variable.</p>
</div>
<div class="section" id="separating-the-us-web-software-from-its-data">
<h3><a class="toc-backref" href="#toc-entry-15">Separating the US-Web Software from its data</a></h3>
<p>It is useful to regularly upgrade the US-Web code while maintaining the data it uses as it is (not losing it because of a mere software update).</p>
<p>This notably includes the information such as the state of the log analysis tool (i.e. the synthesis aggregated after having processed a potentially longer history of access logs when rotating them) or the currently generated certificates (which are not always easy to renew frequently, if having to respect rate limits) <a class="footnote-reference" href="#footnote-4" id="footnote-reference-4">[4]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-4">[4]</a></td><td>Access/error logs and the own US-Web traces are not considered belonging to the application data; their storage location is discussed in the <a class="reference internal" href="#webserver-logs">Webserver Logs</a> section.</td></tr>
</tbody>
</table>
<p>These various states are stored in the <strong>US-Web data directory</strong>, which can be set, by decreasing order of priority:</p>
<ul class="simple">
<li>in the <tt class="docutils literal">us_web_data_dir</tt> entry of the US-Web configuration file, as an absolute directory, or as one that is relative to the US-Web application base directory (see <a class="reference internal" href="#us-web-application-base-directory">US-Web Application Base Directory</a>), then as <tt class="docutils literal">US_WEB_APP_BASE_DIR/data</tt></li>
<li>otherwise in the <tt class="docutils literal">US_WEB_DATA_DIR</tt> environment variable</li>
</ul>
<p>If the default path for this location is <tt class="docutils literal"><span class="pre">us-web-data</span></tt> (relatively to the US-Web instance base directory, typically deployed in <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-native</span></tt>), a recommended practice is nevertheless to set this location explicitly <em>outside</em> of that instance so that the instance can be upgraded/replaced without any loss of state.</p>
<p>So the <tt class="docutils literal">us_web_data_dir</tt> entry might be set in the US-Web configuration file for example to <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-data</span></tt>. Of course, as always, proper permissions shall be set in this data tree as well.</p>
<p>Let's designate this directory from now on with the <tt class="docutils literal">US_WEB_DATA_DIR</tt> pseudo-variable.</p>
<p>This directory may notably gather following elements:</p>
<ul class="simple">
<li>the <tt class="docutils literal"><span class="pre">log-analysis-state</span></tt> subdirectory (if log analysis is enabled), containing the working state of the tool for web access analysis, typically Awstat, thus containing <tt class="docutils literal"><span class="pre">awstats*.baz.foobar.org.txt</span></tt> files for the preprocessing of its reports</li>
<li>the <tt class="docutils literal">certificates</tt> subdirectory (if certificate support is enabled), containing the related keys and certificates for the domains of interest:<ul>
<li>if managing domains D in <tt class="docutils literal">[&quot;foobar.org&quot;, &quot;example.com&quot;]</tt>, then <tt class="docutils literal">D.csr</tt>, <tt class="docutils literal">D.key</tt> and <tt class="docutils literal">D.crt</tt> will be stored or produced there (refer to <a class="reference external" href="https://leec.esperide.org/#getting-information-about-the-generated-certificates">this section</a> of the documentation of LEEC for further explanations)</li>
<li>LEEC-related transverse security elements may be found there (if using it to renew certificates) as well, notably (see <a class="reference external" href="https://leec.esperide.org/#other-files-of-interest">this LEEC documentation section</a>):<ul>
<li><tt class="docutils literal"><span class="pre">us-web-leec-agent-private.key</span></tt>, the RSA private key of the US-Web LEEC agent so that it can safely authenticate to the ACME servers it is interacting with and afterwards validate https handshakes with clients</li>
<li><tt class="docutils literal"><span class="pre">lets-encrypt-r3-cross-signed.pem</span></tt>, the certificate associated to the <em>Certificate Authority</em> (Let's Encrypt here) that is relied upon</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">dh-params.pem</span></tt>, a key generated by LEEC to allow for safer <em>Ephemeral Diffie-Helman key exchanges</em></li>
</ul>
</li>
</ul>
<p>One may create from this <tt class="docutils literal">certificates</tt> subdirectory a <tt class="docutils literal">GNUmakefile</tt> symlink pointing to <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/conf/GNUmakefile-for-certificates">GNUmakefile-for-certificates</a> to easy any checking or backup of these certificates.</p>
</div>
<div class="section" id="catch-alls-https-challenge-types-and-wildcard-certificates">
<h3><a class="toc-backref" href="#toc-entry-16">Catch-alls, HTTPS, Challenge Types and Wildcard Certificates</a></h3>
<p>Having wildcard certificates (which is the default now) - thus relying on the <tt class="docutils literal"><span class="pre">dns-01</span></tt> challenge - allows in turn to define catch-alls (host-level and/or domain-level) routes and wildcard DNS entries (such as <tt class="docutils literal">* IN CNAME foobar.org.</tt>).</p>
<p>Conversely, if setting another challenge type (refer to the <tt class="docutils literal">challenge_type</tt> configuration entry, typically then set to the <tt class="docutils literal"><span class="pre">http-01</span></tt> challenge), defining catch-all routes is not recommended if using https, as these unanticipated hostnames are by design absent from the corresponding certificates, and thus any user requesting them (possibly due to a typo) will have their browser report a security risk (such as <tt class="docutils literal">SSL_ERROR_BAD_CERT_DOMAIN</tt>).</p>
<p>Similarly, wildcard DNS entries should be then avoided (on the other hand, they allow not to advertise what are the precise virtual hostnames supported; note though that with https, these virtual hostnames will be visible in the SANs).</p>
</div>
<div class="section" id="other-configuration-files">
<h3><a class="toc-backref" href="#toc-entry-17">Other Configuration Files</a></h3>
<div class="section" id="credentials-for-one-s-dns-provider">
<h4>Credentials for One's DNS Provider</h4>
<p>If wanting wildcard certificates, the <tt class="docutils literal"><span class="pre">dns-01</span></tt> challenge will be used, and this will require credentials to be specified in order to update DNS entries from one's DNS provider.</p>
<p>US-Web expect credential files to be available in the base directory where all US configuration is to be found (typically <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>). Note that such credentials files (e.g. <tt class="docutils literal"><span class="pre">leec-ovh-credentials-for-foobar.org.txt</span></tt>) must be well-protected; refer to <a class="reference external" href="https://leec.esperide.org/#credentials-file">this LEEC section</a> for more information.</p>
</div>
</div>
</div>
<div class="section" id="operating-system-settings">
<h2><a class="toc-backref" href="#toc-entry-18">Operating System Settings</a></h2>
<div class="section" id="regarding-authbind">
<span id="authbind"></span><h3><a class="toc-backref" href="#toc-entry-19">Regarding <tt class="docutils literal">authbind</tt></a></h3>
<p>Many distributions will parameter <tt class="docutils literal">authbind</tt> so that only the TCP port 80 will be available to &quot;authbound&quot; programs.</p>
<p>If wanting to run an HTTPS server, the TCP port 443 will be most probably needed and thus must be specifically enabled.</p>
<p>For that, relying on the same user/group conventions as before, one may enter, as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/etc/authbind/byport<span class="w">
</span>$<span class="w"> </span>cp<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">443</span><span class="w">
</span>$<span class="w"> </span>chown<span class="w"> </span>us-web-user:us-group<span class="w"> </span><span class="m">443</span>
</pre>
<p>Otherwise an exception will be raised (about <tt class="docutils literal">eperm</tt> / <tt class="docutils literal">not owner</tt>) when US-Web will try to create its HTTPS listening socket.</p>
</div>
</div>
</div>
<div class="section" id="running-the-universal-webserver">
<h1><a class="toc-backref" href="#toc-entry-20">Running the Universal-Webserver</a></h1>
<p>In this section we suppose that a native deployment is being used, with uniform conventions between the development and server settings; if using a release-based deployment, note that the Erlang versions used to produce the release (typically in a development computer) and run it (typically in a production server) must match (we prefer using <em>exactly</em> the same version).</p>
<p>Supposing a vhost to be served by US-Web is <tt class="docutils literal">baz.foobar.org</tt>, to avoid being confused by your browser, a better way is to test whether a US-Web instance is already running thanks to <tt class="docutils literal">wget</tt> or <tt class="docutils literal">links</tt>:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>wget<span class="w"> </span>http://baz.foobar.org<span class="w"> </span>-O<span class="w"> </span>-
</pre>
<p>This will display the fetched content directly on the console (not creating a file).</p>
<p>Indeed, when testing a website, fully-fledged browsers such as Firefox may be quite misleading as they may attempt to hide issues, and tend to cache a lot of information (not actually reloading the current page), even if the user held Shift and clicked on &quot;Reload&quot;. Do not trust browsers!</p>
<p>One may disable temporarily the cache by opening the developer toolbox (<tt class="docutils literal">Ctrl+Shift+I</tt> or <tt class="docutils literal">Cmd+Opt+I</tt> on Mac), clicking on the settings button (near the top right), scrolling down to the <tt class="docutils literal">Advanced settings</tt> (on the bottom right), checking the option <tt class="docutils literal">Disable Cache (when toolbox is open)</tt> and refreshing the page. <tt class="docutils literal">wget</tt> may still be a better, simpler, more reliable solution.</p>
<div class="section" id="stopping-any-prior-instance-first">
<h2><a class="toc-backref" href="#toc-entry-21">Stopping any prior instance first</a></h2>
<p>From now on, we will suppose the current directory is <tt class="docutils literal">US_WEB_APP_ROOT</tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">stop-us-web-native-build.sh</span></tt> script can be used for stopping a US-Web instance, typically simply as:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>priv/bin/stop-us-web-native-build.sh
</pre>
<p>In development mode, still from the root of US-Web, one might use <tt class="docutils literal">make <span class="pre">stop-brutal</span></tt> to operate regardless of dynamically-changed cookies, while in a production setting one would go preferably for:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>us-web-as-native-build.service
</pre>
</div>
<div class="section" id="launching-the-us-web-server">
<h2><a class="toc-backref" href="#toc-entry-22">Launching the US-Web Server</a></h2>
<p>In development mode, from the root of US-Web, one may use <tt class="docutils literal">make debug</tt>, while, in production mode, the US-Web server can be launched either with its dedicated script <tt class="docutils literal"><span class="pre">start-us-web-native-build.sh</span></tt> or, even better, directly through:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>us-web-as-native-build.service
</pre>
</div>
</div>
<div class="section" id="monitoring-the-us-web-server">
<h1><a class="toc-backref" href="#toc-entry-23">Monitoring the US-Web Server</a></h1>
<div class="section" id="local-monitoring">
<h2><a class="toc-backref" href="#toc-entry-24">Local Monitoring</a></h2>
<p>Here operations will be done directly on the server, and supposing a native build.</p>
<div class="section" id="checking-epmd">
<h3><a class="toc-backref" href="#toc-entry-25">Checking EPMD</a></h3>
<p>If using the default US-Web EPMD port, checking whether an instance is running is as simple as:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ERL_EPMD_PORT</span><span class="o">=</span><span class="m">4508</span><span class="p">;</span><span class="w"> </span>epmd<span class="w"> </span>-names<span class="w">
</span>epmd:<span class="w"> </span>up<span class="w"> </span>and<span class="w"> </span>running<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4508</span><span class="w"> </span>with<span class="w"> </span>data:<span class="w">
</span>name<span class="w"> </span>us_web<span class="w"> </span>at<span class="w"> </span>port<span class="w"> </span><span class="m">50002</span>
</pre>
<p>Then executing <tt class="docutils literal"><span class="pre">kill-us-web.sh</span></tt> will kill any live US-Web instance and unregister it from its EPMD (without killing any EPMD daemon).</p>
</div>
<div class="section" id="overall-local-inquiry">
<h3><a class="toc-backref" href="#toc-entry-26">Overall Local Inquiry</a></h3>
<p>The <tt class="docutils literal"><span class="pre">get-us-web-native-build-status.sh</span></tt> script (still in <tt class="docutils literal">priv/bin</tt>, as all US-Web shell scripts) may then be used to investigate any problem in a streamlined, integrated way.</p>
<p>Alternate (yet often less convenient) solutions are to run <tt class="docutils literal">systemctl status <span class="pre">us-web-as-native-build.service</span></tt> or, often with better results, <tt class="docutils literal">journalctl <span class="pre">-xe</span> <span class="pre">--unit</span> <span class="pre">us-web-as-native-build.service</span> <span class="pre">--no-pager</span></tt> to get some insights.</p>
</div>
<div class="section" id="general-logs">
<h3><a class="toc-backref" href="#toc-entry-27">General Logs</a></h3>
<p>A deeper level of detail can be obtained by inspecting the <em>general</em> logs (as opposed to the <em>webserver</em> ones, discussed in next section), which regroup the VM-level, technical ones and/or the applicative ones.</p>
<p><strong>VM logs</strong> are written in the <tt class="docutils literal"><span class="pre">${REL_BASE_ROOT}/log</span></tt> directory (e.g. <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-latest/us_web/log</span></tt>), which is created when the release is started first. Generally, <tt class="docutils literal">run_erl.log</tt> (if launched as a daemon) will not help much, whereas the latest Erlang log file (<tt class="docutils literal">ls <span class="pre">-lrt</span> erlang.log.*</tt>) is likely to contain relevant information.</p>
<p>So one may consult them for example with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">50</span><span class="w"> </span>-f<span class="w"> </span>/opt/universal-server/us_web-latest/us_web/log/erlang.log.1
</pre>
<p>As for our higher-level, <strong>applicative traces</strong>, they are stored in the the <tt class="docutils literal">us_web.traces</tt> file, in the directory defined in the <tt class="docutils literal">us_web_log_dir</tt> entry of the US-Web configuration file. This last file is specified in turn in the relevant <tt class="docutils literal">us.config</tt> configuration file (see the <tt class="docutils literal">us_web_config_filename</tt> key for that), which, in development mode, is itself typically found in <tt class="docutils literal"><span class="pre">~/.config/universal-server</span></tt> while, in production mode, is likely located in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>.</p>
<p>In practice, this trace file is generally found:</p>
<ul class="simple">
<li>in development mode, if testing, in <tt class="docutils literal"><span class="pre">priv/for-testing/log</span></tt>, relatively to the base directory specified in <tt class="docutils literal">us_app_base_dir</tt></li>
<li>in production mode, generally in <tt class="docutils literal"><span class="pre">/var/log/universal-server</span></tt> of <tt class="docutils literal"><span class="pre">/opt/universal-server</span></tt></li>
</ul>
<p>This path is updated at runtime once the US-Web configuration file is read; so typically it is renamed from <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z/traces_via_otp.traces</span></tt> to <tt class="docutils literal"><span class="pre">/var/log/universal-server/us-web/us_web.traces</span></tt>. If available, it is surely the most complete source of information.</p>
</div>
<div class="section" id="webserver-logs">
<h3><a class="toc-backref" href="#toc-entry-28">Webserver Logs</a></h3>
<p>These logs, which are maybe less useful for troubleshooting, designate access and error logs, per virtual host (e.g. for a virtual host <tt class="docutils literal">VH</tt>, <tt class="docutils literal"><span class="pre">access-for-VH.log</span></tt> and <tt class="docutils literal"><span class="pre">error-for-VH.log</span></tt>). Their previous versions are archived in timestamped, compressed files (e.g. <tt class="docutils literal"><span class="pre">error-for-VH.Y-M-D-at-H-M-S.xz</span></tt>).</p>
<p>These files will be written in the directory designated by the <tt class="docutils literal">us_web_log_dir</tt> entry of the US-Web configuration file. Refer to the previous section to locate this directory (for example it may be <tt class="docutils literal"><span class="pre">/var/log/universal-server/us-web</span></tt>).</p>
</div>
</div>
<div class="section" id="remote-monitoring">
<h2><a class="toc-backref" href="#toc-entry-29">Remote Monitoring</a></h2>
<p>Here the state of a US-Web instance will be inspected remotely, with no need for a shell connection to its server.</p>
<div class="section" id="http-client-check">
<h3><a class="toc-backref" href="#toc-entry-30">HTTP Client Check</a></h3>
<p>First of all, is this US-Web instance available at all? Check with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>wget<span class="w"> </span>http://baz.foobar.org<span class="w"> </span>-O<span class="w"> </span>-
</pre>
<p>One may define one's dedicated convenience script for that, like a <tt class="docutils literal"><span class="pre">check-baz-website-availability.sh</span></tt> script whose content would be:</p>
<pre class="code bash literal-block">
<span class="ch">#!/bin/sh
</span><span class="nv">target_url</span><span class="o">=</span><span class="s2">&quot;http://baz.foobar.org&quot;</span><span class="w">
</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Checking whether '</span><span class="si">${</span><span class="nv">target_url</span><span class="si">}</span><span class="s2">' is available:&quot;</span><span class="w">
</span>wget<span class="w"> </span><span class="si">${</span><span class="nv">target_url</span><span class="si">}</span><span class="w"> </span>-O<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</pre>
<p>More elaborate scripts may be devised, testing various virtual hosts with various protocols (http/https), looping continously should a failure be detected, like in:</p>
<pre class="code bash literal-block">
<span class="ch">#!/bin/sh
</span>test_url<span class="o">()</span><span class="w">
</span><span class="o">{</span><span class="w">
   </span><span class="nv">target_url</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w">
   </span><span class="c1">#echo &quot;  Checking whether '${target_url}' is available:&quot;
</span><span class="w">   </span><span class="k">if</span><span class="w"> </span>wget<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">target_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-O<span class="w"> </span>-<span class="w"> </span><span class="m">1</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; ('</span><span class="si">${</span><span class="nv">target_url</span><span class="si">}</span><span class="s2">' is available)&quot;</span><span class="w">
       </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="w">
   </span><span class="k">else</span><span class="w">
       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;######### Problem: '</span><span class="si">${</span><span class="nv">target_url</span><span class="si">}</span><span class="s2">' is NOT available! #########&quot;</span><span class="w"> </span><span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w">
       </span><span class="k">return</span><span class="w"> </span><span class="m">1</span><span class="w">
   </span><span class="k">fi</span><span class="w">
</span><span class="o">}</span><span class="w">

</span><span class="c1"># Testing base domains, some virtual hosts, and HTTP/HTTPS availability as
# well:
</span><span class="nv">com_test_url</span><span class="o">=</span><span class="s2">&quot;http://foobar.com&quot;</span><span class="w">
</span><span class="c1"># Testing also a virtual host:
</span><span class="nv">com_vh_test_url</span><span class="o">=</span><span class="s2">&quot;http://hello.foobar.com&quot;</span><span class="w">
</span><span class="c1"># As HTTPS:
</span><span class="nv">com_vh_https_url</span><span class="o">=</span><span class="s2">&quot;https://other.foobar.com&quot;</span><span class="w">
</span><span class="nv">com_urls</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">com_test_url</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">com_vh_test_url</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">com_vh_https_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">
</span><span class="c1"># Testing also the other domains:
</span><span class="nv">net_test_url</span><span class="o">=[</span>...<span class="o">]</span><span class="w">
</span><span class="nv">all_urls</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">com_urls</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">net_urls</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">org_urls</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">info_urls</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">biz_urls</span><span class="si">}</span><span class="s2"> [...]&quot;</span><span class="w">
</span><span class="nv">all_good</span><span class="o">=</span><span class="m">1</span><span class="w">
</span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$all_good</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w">
   </span><span class="nv">all_good</span><span class="o">=</span><span class="m">0</span><span class="w">
   </span><span class="k">for</span><span class="w"> </span>u<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">all_urls</span><span class="si">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w">
       </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>test_url<span class="w"> </span><span class="nv">$u</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w">
           </span><span class="nv">all_good</span><span class="o">=</span><span class="m">1</span><span class="w">
       </span><span class="k">fi</span><span class="w">
   </span><span class="k">done</span><span class="w">
   </span><span class="nb">echo</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$all_good</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;At least an URL could not be reached, testing again...&quot;</span><span class="w">
   </span><span class="k">fi</span><span class="w">
   </span>sleep<span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="k">done</span><span class="w">
</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Good news, all tested domains are available from this local host!&quot;</span><span class="w">
</span><span class="nb">echo</span>
</pre>
</div>
<div class="section" id="trace-listener-check">
<h3><a class="toc-backref" href="#toc-entry-31">Trace Listener Check</a></h3>
<p>As for the applicative traces, they may be monitored remotely as well, thanks to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/monitor-us-web.sh">monitor-us-web.sh</a> script.</p>
<p>This script operates based on a configuration file, <tt class="docutils literal"><span class="pre">us-web-for-remote-access.config</span></tt> (typically located in <tt class="docutils literal"><span class="pre">~/.config/universal-server</span></tt>), that allows to designate the US-Web instance to access for the client host, and the various settings for that.</p>
<p>For example:</p>
<pre class="code erlang literal-block">
<span class="c">% This file is used by the US-Web framework.</span><span class="w">
</span><span class="c">%</span><span class="w">
</span><span class="c">% This is a configuration file to enable the interaction with a remote US-Web</span><span class="w">
</span><span class="c">% instance (e.g. a production server to be reached from a client host), typically</span><span class="w">
</span><span class="c">% to monitor traces, to trigger the generation of log access reports, etc.</span><span class="w">

</span><span class="c">% The hostname where the US-Web instance of interest runs:</span><span class="w">
</span><span class="p">{</span><span class="n">us_web_hostname</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;baz.foobar.org&quot;</span><span class="p">}.</span><span class="w">

</span><span class="c">% Its cookie, as set in its configuration file:</span><span class="w">
</span><span class="p">{</span><span class="n">remote_vm_cookie</span><span class="p">,</span><span class="w"> </span><span class="n">'foobar-8800a3f8-7545-4a83-c925-ca115a7b014b'</span><span class="p">}.</span><span class="w">

</span><span class="c">% If specifically overridden for thay server:</span><span class="w">
</span><span class="p">{</span><span class="n">us_web_config_server_registration_name</span><span class="p">,</span><span class="w"> </span><span class="n">foobar_prod_us_web_cfg_srv</span><span class="p">}.</span><span class="w">

</span><span class="c">% A range of TCP ports that may be used for out-of-band inter-VM communication</span><span class="w">
</span><span class="c">% (not using the Erlang carrier; e.g. for send_file):</span><span class="w">
</span><span class="c">%</span><span class="w">
</span><span class="c">% (this range must be typically in-line with any one set at the level of</span><span class="w">
</span><span class="c">% firewalls)</span><span class="w">
</span><span class="c">%</span><span class="w">
</span><span class="p">{</span><span class="n">tcp_port_range</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">50000</span><span class="p">,</span><span class="w"> </span><span class="mi">55000</span><span class="p">}}.</span>
</pre>
<p>Then running the aforementioned <tt class="docutils literal"><span class="pre">monitor-us-web.sh</span></tt> script should launch a trace browser synchronised to the trace aggregator of the targeted US-Web instance, displaying all traces (i.e. both all that have been emitted since the start of that instance and all newer ones, being then displayed in direct).</p>
<p>Here is a user-submitted screenshot (edited for confidentiality) of the LogMX-based trace browser corresponding to the native US-Web trace interface (refer to <a class="reference external" href="https://traces.esperide.com">Ceylan-Traces</a> for further details):</p>
<p><span class="raw-html"><center><img src="us-web-trace-monitoring-contributed-example.png" id="responsive-image-full"></img></center></span>
</p>
</div>
</div>
<div class="section" id="remote-action">
<h2><a class="toc-backref" href="#toc-entry-32">Remote Action</a></h2>
<p>It is possible to trigger the generation of web access reports (refer to the <a class="reference internal" href="#auto-generated-meta-website">Auto-generated Meta Website</a> section for details) remotely, either for a single virtual host of a given domain, or for all virtual hosts of all the hosted domains.</p>
<p>For that one should execute the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/generate-us-web-log-report.sh">generate-us-web-log-report.sh</a> script, which relies on the same <tt class="docutils literal"><span class="pre">us-web-for-remote-access.config</span></tt> configuration file already discussed in the <a class="reference internal" href="#remote-monitoring">Remote Monitoring</a> section.</p>
</div>
</div>
<div class="section" id="nitrogen-support">
<span id="nitrogen-based"></span><h1><a class="toc-backref" href="#toc-entry-33">Nitrogen Support</a></h1>
<p>A US-Web instance may host one <a class="footnote-reference" href="#footnote-5" id="footnote-reference-5">[5]</a> Nitrogen-based website.</p>
<table class="docutils footnote" frame="void" id="footnote-5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-5">[5]</a></td><td><p class="first">Only a single instance of Nitrogen is supported per US-Web instance, as otherwise the various pages of the Nitrogen websites would clash through the code path (e.g. there would be multiple <tt class="docutils literal">index.beam</tt> files there; there would also be problems with the relative paths currently expected by <tt class="docutils literal">nitro_cache</tt>, etc.).</p>
<p class="last">So, if wanting to have multiple Nitrogen websites available from a common domain name, one shall rely on a <a class="reference external" href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a>. It is hardly a limitation, as web applications are better managed independently anyway, in order to be able to freely start / stop / update them, to isolate them with different users, to separate their resource uses, etc.</p>
</td></tr>
</tbody>
</table>
<div class="section" id="deployment">
<h2><a class="toc-backref" href="#toc-entry-34">Deployment</a></h2>
<div class="section" id="deployment-of-a-nitrogen-enabled-us-web">
<h3><a class="toc-backref" href="#toc-entry-35">Deployment of a Nitrogen-enabled US-Web</a></h3>
<p>US-Web must be deployed accordingly, typically with the <tt class="docutils literal"><span class="pre">--support-nitrogen</span></tt> option of the <tt class="docutils literal"><span class="pre">deploy-us-web-native-build.sh</span></tt> script <a class="footnote-reference" href="#footnote-6" id="footnote-reference-6">[6]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-6">[6]</a></td><td>This script relies on a few forks that we made for better control, namely of <a class="reference external" href="https://github.com/Olivier-Boudeville/nitrogen_core">nitrogen_core</a> and <a class="reference external" href="https://github.com/Olivier-Boudeville/simple_bridge">simple_bridge</a> (the latter being installed by the former).</td></tr>
</tbody>
</table>
</div>
<div class="section" id="deployment-of-the-nitrogen-based-website-application">
<h3><a class="toc-backref" href="#toc-entry-36">Deployment of the Nitrogen-based website / application</a></h3>
<p>Then of course a Nitrogen-based website must have already been developed, an example of which being, in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">US-Main</a>, the <tt class="docutils literal">us_main_nitrogen_app</tt> web application.</p>
<p>Such a website is typically obtained by cloning the <a class="reference external" href="https://github.com/nitrogen/nitrogen">official Nitrogen repository</a> (or possibly <a class="reference external" href="https://github.com/Olivier-Boudeville/nitrogen">our fork thereof</a>) and running:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>make<span class="w"> </span>slim_cowboy<span class="w"> </span><span class="nv">PREFIX</span><span class="o">=</span><span class="nv">$MY_NITROGEN_APP_ROOT</span><span class="w"> </span><span class="nv">PROJECT</span><span class="o">=</span>my_nitrogen_app
</pre>
<p>(we prefer relying on a separate system-wide Erlang installation rather than on an full OTP release)</p>
<p>The root tree of interest then lies in <tt class="docutils literal">$MY_NITROGEN_APP_ROOT/my_nitrogen_app/site</tt>.</p>
<p>The whole of it may be put in <a class="reference external" href="https://howtos.esperide.org/VCS.html">VCS</a>, or at the very least its <tt class="docutils literal">include</tt>, <tt class="docutils literal">src</tt>, <tt class="docutils literal"><span class="pre">static/{css,images}</span></tt>, <tt class="docutils literal">templates</tt> subtrees.</p>
</div>
</div>
<div class="section" id="configuration">
<h2><a class="toc-backref" href="#toc-entry-37">Configuration</a></h2>
<p>Here we must declare to US-Web, through its <a class="reference internal" href="#configuration-file">configuration file</a> (say, <tt class="docutils literal"><span class="pre">my-us-web.config</span></tt>, as listed under the <tt class="docutils literal">us_web_config_filename</tt> key of one's <tt class="docutils literal">us.config</tt> file), that, for a given domain name (say, <tt class="docutils literal">foo.org</tt>), a given virtual host (say, <tt class="docutils literal">bar</tt>, thus designated as <tt class="docutils literal">bar.foo.org</tt>) is to be served by a Nitrogen instance whose content root is, relatively to the US-Web default web root, <tt class="docutils literal"><span class="pre">./my-nitrogen-website</span></tt>.</p>
<p>This is done simply thanks to a user-defined route, like in:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="w"> </span><span class="n">routes</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">

 </span><span class="c">% These are implicitly static and relative to default_web_root:</span><span class="w">
 </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;foo.org&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;project-a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test-static-website-A&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;project-b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test-static-website-B&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;project-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test-static-website-C&quot;</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="p">,</span><span class="w">       </span><span class="s">&quot;my-nitrogen-website&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nitrogen</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="n">default_vhost_catch_all</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test-static-website-D&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">

 </span><span class="p">[...]</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
</pre>
</div>
<div class="section" id="nitrogen-related-information">
<h2><a class="toc-backref" href="#toc-entry-38">Nitrogen-related Information</a></h2>
<p>Official Nitrogen sources:</p>
<ul class="simple">
<li><a class="reference external" href="http://nitrogenproject.com/">website</a></li>
<li><a class="reference external" href="http://nitrogenproject.com/doc/tutorial.html">insightful tutorial</a></li>
<li><a class="reference external" href="https://github.com/nitrogen/nitrogen/wiki">wiki</a></li>
<li><a class="reference external" href="https://github.com/nitrogen/nitrogen">Git repository</a></li>
<li>the associated <a class="reference external" href="https://groups.google.com/g/nitrogenweb">Google group</a></li>
<li>the <a class="reference external" href="https://leanpub.com/builditwithnitrogen">Build It With Nitrogen</a> book / ebook</li>
</ul>
<p>Extra information:</p>
<ul class="simple">
<li>&quot;<em>It is strongly recommended to catch static files with the static_paths setting. simple_bridge does not serve large static files in an optimal way (it loads the files into memory completely before sending)</em>&quot;</li>
<li><a class="reference external" href="http://zotonic.com/features">Zotonic</a> relied on Nitrogen</li>
<li><a class="reference external" href="https://rshestakov.wordpress.com/2013/02/17/how-nitrogen-processes-requests/">How Nitrogen processes requests</a></li>
<li><a class="reference external" href="https://rshestakov.wordpress.com/2013/03/03/how-to-add-nitrogen-and-cowboy-as-dependecy-libs-to-your-erlang-application/">How to add Nitrogen and Cowboy as dependency libs to your erlang application</a></li>
</ul>
</div>
</div>
<div class="section" id="extra-features">
<h1><a class="toc-backref" href="#toc-entry-39">Extra Features</a></h1>
<div class="section" id="auto-generated-meta-website">
<h2><a class="toc-backref" href="#toc-entry-40">Auto-generated Meta Website</a></h2>
<p>If requested, at server start-up, a &quot;meta&quot; website - i.e. a website sharing information about all other websites being hosted by that server - can be generated and made available through a dedicated virtual host and web root.</p>
<p>For that, in the US-Web configuration file, among the user-specified <tt class="docutils literal">routes</tt>, one may add the following element in the list of virtual host entries associated to a given domain (e.g. <tt class="docutils literal">foobar.org</tt>):</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="s">&quot;mymeta&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;My-meta-generated&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">}</span>
</pre>
<p>This will generate a suitable website in the <tt class="docutils literal"><span class="pre">My-meta-generated</span></tt> subdirectory of the default web root (as, here, the specified directory is not an absolute one), and this website will be available as <tt class="docutils literal">mymeta.foobar.org</tt> (of course both <tt class="docutils literal">mymeta</tt> and <tt class="docutils literal"><span class="pre">My-meta-generated</span></tt> are examples; these names can be freely chosen).</p>
<p>Currently no specific access control to this website is enforced (thus by default anyone knowing or able to guess its virtual hostname can access it).</p>
<p>Note that apparently, at least under some circumstances, some versions of Firefox may incorrectly render a Meta web page: despite its HTML source being correct, for some reason the entry page of websites may correspond to another virtual host (whereas other browsers display correctly the same Meta page).</p>
</div>
<div class="section" id="icon-favicon-management">
<h2><a class="toc-backref" href="#toc-entry-41">Icon (favicon) Management</a></h2>
<p>This designates the little image that is displayed by browsers on the top of the tab of the website being visited.</p>
<p>A default icon file can be defined, it is notably used in order to generate better-looking 404 pages.</p>
<p>To do so, the <tt class="docutils literal">icon_path</tt> key in the US-Web handler state shall be set to the path of such file (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal"><span class="pre">common/default-icon.png</span></tt> exists (e.g. obtained thanks to this kind of <a class="reference external" href="https://favicon.io/favicon-generator/">generator</a>), it is automatically registered in <tt class="docutils literal">icon_path</tt>.</p>
</div>
<div class="section" id="css-management">
<h2><a class="toc-backref" href="#toc-entry-42">CSS Management</a></h2>
<p>A default CSS file can be defined, notably in order to generate better-looking 404 pages.</p>
<p>To do so, the <tt class="docutils literal">css_path</tt> key in the US-Web handler state shall be set to the path of such file (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal">common/default.css</tt> exists, it is automatically registered in <tt class="docutils literal">css_path</tt>.</p>
</div>
<div class="section" id="error-404-management">
<h2><a class="toc-backref" href="#toc-entry-43">Error 404 Management</a></h2>
<p>Should some requested web page not be found:</p>
<ul class="simple">
<li>a suitable 404 page is automatically generated by the US-Web server, and returned to the caller</li>
<li>the error is appropriately logged</li>
</ul>
<p>A 404 image can be optionally displayed instead of the &quot;0&quot; of &quot;404&quot;. To do so, the <tt class="docutils literal">image_404</tt> key in the US-Web handler state shall be set to the path of such image (possibly a symbolic link), relatively to the content root of the corresponding virtual host.</p>
<p>In the context of the (default) US-Web static web handler, if such a <tt class="docutils literal">images/404.png</tt> file exists, it is automatically registered in <tt class="docutils literal">image_404</tt>.</p>
</div>
<div class="section" id="site-customisation">
<h2><a class="toc-backref" href="#toc-entry-44">Site Customisation</a></h2>
<p>As a summary of the sections above, if there is a file (regular or symbolic link), from the content root of a hosted static website, in:</p>
<ul class="simple">
<li><tt class="docutils literal">common/default.css</tt>, then this CSS will be used for all generated pages for that website (e.g. the one for errors such as 404 ones)</li>
<li><tt class="docutils literal"><span class="pre">images/default-icon.png</span></tt>, then this image will be used as an icon (the small image put on browser tabs next to their labels) for all generated pages</li>
<li><tt class="docutils literal">images/404.png</tt>, then this image will be used for the &quot;0&quot; in the main &quot;404&quot; label of the page denoting a content not found</li>
</ul>
<p>Each content root is expected to contain at least a (proper) <tt class="docutils literal">index.html</tt> file (possibly as a symbolic link).</p>
</div>
</div>
<div class="section" id="usage-recommendations">
<h1><a class="toc-backref" href="#toc-entry-45">Usage Recommendations</a></h1>
<p>In terms of security, we would advise:</p>
<ul class="simple">
<li>to stick to the <strong>latest stable version</strong> of all software involved (including US-Web and all its stack including Cowboy and LEEC, Erlang, and the operating system itself)</li>
<li>depending on the preferred trade-off between accessibility and security, to build US-Web either with the <tt class="docutils literal">us_web_security</tt> flag set to <tt class="docutils literal">strict</tt> (more security; the default) or to <tt class="docutils literal">relaxed</tt> (more compatibility with various clients); typically they aim respectively a grade of A and at least B at the <a class="reference external" href="https://www.ssllabs.com/ssltest/index.html">SSL Labs server test</a>; this build flag determines the versions of TLS supported (e.g. only 1.3 and 1.2; or 1.1 and 1.0 as well), the accepted list of ciphers (including or not some that are becoming weak), possibly the RSA key length, Diffie-Hellman parameters, how Forward Secrecy is managed, etc.; as it is a bit fun, the US-Web server tries (yet with no luck) to spoof its server signature in the headers, pretending it is an Apache instance; <a class="reference external" href="https://letsencrypt.org/docs/caa/">DNS CAA</a> (<em>Certificate Authority Authorization</em>) is not specifically supported (as LEEC uses <a class="reference external" href="https://leec.esperide.org/#caa">throwaway accounts</a>)</li>
<li>to apply a streamlined, reproducible <strong>deployment process</strong>, preferably based on our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-release.sh">deploy-us-web-release.sh</a> script</li>
<li>to rely on dedicated, <strong>different, low-privileged users and groups</strong> for US and US-Web, which both rely on <tt class="docutils literal">authbind</tt>; refer to our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/start-us-web.sh">start-us-web.sh</a> script for that; see also the <tt class="docutils literal">us_username</tt> key of US-Common's <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">us.config</a>, and the <tt class="docutils literal">us_web_username</tt> key of the US-Web configuration file that it refers to</li>
<li>still in <tt class="docutils literal">us.config</tt>, to set:<ul>
<li>a strong-enough Erlang <strong>cookie</strong>: set the <tt class="docutils literal">vm_cookie</tt> key to a well-chosen value, possibly a random one deriving from an output of <tt class="docutils literal">uuidgen</tt></li>
<li>possibly a <strong>limited TCP port range</strong> (see the <tt class="docutils literal">tcp_port_range</tt> key)</li>
<li>the <strong>execution context</strong> to <tt class="docutils literal">production</tt> (see the <tt class="docutils literal">execution_context</tt> key)</li>
</ul>
</li>
<li>to use also the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/stop-us-web.sh">stop-us-web.sh</a> counterpart script, and to have them triggered through <tt class="docutils literal">systemd</tt>; we provide a corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/conf/us-web.service">us-web.service</a> <strong>unit file</strong> for that, typically to be placed in <tt class="docutils literal">/etc/systemd/system</tt> and whose <tt class="docutils literal">ExecStart/ExecStop</tt> paths shall preferably be symlinks pointing to the latest deployed US-Web release (e.g. <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-latest</span></tt>)</li>
<li>to ensure that a <strong>firewall</strong> blocks everything from the Internet by default, including the EPMD port(s) (i.e. both the default Erlang one and any non-standard one specified through the <tt class="docutils literal">epmd_port</tt> key defined in <tt class="docutils literal">us.config</tt>); one may get inspiration from our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script for that</li>
<li>no need to advertise specifically a virtual host in your DNS; for example, so that a <tt class="docutils literal">baz.foobar.org</tt> is available, only <tt class="docutils literal">foobar.org</tt> has to be declared in the DNS records (even a <tt class="docutils literal">*.foobar.org</tt> wildcard is not necessary) for the corresponding website to be available; as a result, unless the full name of that virtual host is disclosed or a (typically brute-force) guessing succeeds, that virtual host will remain private by default (useful as a first level of protection, notably for any meta website)</li>
<li>to <strong>monitor regularly</strong> both:<ul>
<li>the US-Web server itself (see our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/monitor-us-web.sh">monitor-us-web.sh</a> script for that, relying on the trace supervisor provided by the <a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> layer)</li>
<li>the remote, browser-based, accesses made to the hosted websites, typically by enabling the US-Web &quot;meta&quot; feature, generating and updating automatically a dedicated website displaying in one page all hosted websites and linking to their web analysis report; refer to the <tt class="docutils literal">log_analysis</tt> key of the US-Web configuration file (e.g. see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">us-web-for-tests.config</a> as an example thereof)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="licence">
<span id="free-software"></span><h1><a class="toc-backref" href="#toc-entry-46">Licence</a></h1>
<p>The <tt class="docutils literal">Universal Webserver</tt> is licensed by its author (Olivier Boudeville) under the <a class="reference external" href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU Affero General Public License</a> as published by the Free Software Foundation, either version 3 of this license, or (at your option) any later version.</p>
<p>This allows the use of the Universal Webserver code in a wide a variety of software projects, while still maintaining copyleft on this code, ensuring improvements are shared.</p>
<p>We hope indeed that enhancements will be back-contributed (e.g. thanks to merge requests), so that everyone will be able to benefit from them.</p>
</div>
<div class="section" id="current-stable-version-download">
<h1><a class="toc-backref" href="#toc-entry-47">Current Stable Version &amp; Download</a></h1>
<p>As mentioned, the single, direct prerequisites of the <a class="reference external" href="https://github.com/Olivier-Boudeville/UniversalWebserver">Universal Webserver</a> are:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ninenines/cowboy">Cowboy</a> (version 2.8 or above)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/">LEEC</a> as an optional, runtime-only dependency</li>
<li><a class="reference external" href="http://www.awstats.org/">Awstats</a> as an optional, runtime-only dependency (version 7.8 or above)</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a></li>
</ul>
<p>The latter relies on <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces">Ceylan-Traces</a>, which implies in turn <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-WOOPER">Ceylan-WOOPER</a>, then <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceylan-Myriad</a> and <a class="reference external" href="http://erlang.org">Erlang</a>.</p>
<p>We prefer using GNU/Linux, sticking to the latest stable release of Erlang, and building it from sources, thanks to GNU <tt class="docutils literal">make</tt>. We recommend indeed obtaining Erlang thanks to a manual installation; refer to the corresponding <a class="reference external" href="http://myriad.esperide.org#prerequisites">Myriad prerequisite section</a>  for more precise guidelines.</p>
<p>The build of the US-Web server is driven by <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, which can be obtained by following our <a class="reference external" href="http://myriad.esperide.org/#getting-rebar3">guidelines</a>.</p>
<p id="getting-awstats">If a tool for web analysis is needed (typically if enabling a meta website), this tool must be installed beforehand. Currently US-Web supports Awstats, which can be obtained thanks to your distribution of choice (ex for Arch Linux: <tt class="docutils literal">pacman <span class="pre">-S</span> awstats</tt> <a class="footnote-reference" href="#footnote-7" id="footnote-reference-7">[7]</a>) .</p>
<table class="docutils footnote" frame="void" id="footnote-7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-7">[7]</a></td><td>To avoid a future reading access error, execute after installation: <tt class="docutils literal">chmod <span class="pre">-R</span> +r /usr/share/webapps/awstats/icon</tt>.</td></tr>
</tbody>
</table>
<p>If wanting to be able to operate on the source code of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan">Ceylan</a> and/or <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">US</a> dependencies, you may define appropriate symbolic links in a <tt class="docutils literal">_checkouts</tt> directory created at the root one's <tt class="docutils literal"><span class="pre">US-Web</span></tt> clone, these links pointing to relevant GIT repositories (see the <tt class="docutils literal"><span class="pre">create-us-web-checkout</span></tt> make target for that).</p>
<div class="section" id="using-cutting-edge-git">
<h2><a class="toc-backref" href="#toc-entry-48">Using Cutting-Edge GIT</a></h2>
<p>This is the installation method that we use and recommend; the Universal Webserver <tt class="docutils literal">master</tt> branch is meant to stick to the latest stable version: we try to ensure that this main line always stays functional (sorry for the pun). Evolutions are to take place in feature branches and to be merged only when ready.</p>
<p>Once Erlang (see <a class="reference external" href="http://myriad.esperide.org/index.html#getting-erlang">here</a>), rebar3 (see <a class="reference external" href="http://myriad.esperide.org/index.html#getting-rebar3">here</a>) and possibly LEEC (see <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC#building">here</a>) or Awstats (see <a class="reference external" href="#getting-awstats">here</a>) are available, it should be just a matter of executing our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/tree/master/priv/bin/get-us-web-from-sources.sh">get-us-web-from-sources.sh</a> script for downloading and building all dependencies at once, and run a test server (use its <tt class="docutils literal"><span class="pre">--help</span></tt> option for more information).</p>
<p>For example:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/tmp<span class="w">
</span>$<span class="w"> </span>wget<span class="w"> </span>https://raw.githubusercontent.com/Olivier-Boudeville/us-web/master/priv/bin/get-us-web-from-sources.sh<span class="w">
</span>$<span class="w"> </span>sh<span class="w"> </span>./get-us-web-from-sources.sh<span class="w"> </span>--checkout<span class="w">
</span>Switching<span class="w"> </span>to<span class="w"> </span>checkout<span class="w"> </span>mode.<span class="w">

 </span>Installing<span class="w"> </span>US-Web<span class="w"> </span><span class="k">in</span><span class="w"> </span>/tmp...<span class="w">

 </span>Cloning<span class="w"> </span>into<span class="w"> </span><span class="s1">'us_web'</span>...<span class="w">
 </span><span class="o">[</span>...<span class="o">]</span><span class="w">
 </span><span class="o">===</span>&gt;<span class="w"> </span>Compiling<span class="w"> </span>us_web<span class="w">
 </span>Starting<span class="w"> </span>the<span class="w"> </span>us_web<span class="w"> </span>release<span class="w"> </span><span class="o">(</span>EPMD<span class="w"> </span>port:<span class="w"> </span><span class="m">4526</span><span class="o">)</span>:<span class="w">
 </span><span class="o">[</span>...<span class="o">]</span><span class="w">
 </span>US-Web<span class="w"> </span>launched,<span class="w"> </span>please<span class="w"> </span>point<span class="w"> </span>a<span class="w"> </span>browser<span class="w"> </span>to<span class="w"> </span>http://localhost:8080<span class="w"> </span>to<span class="w">
  </span>check<span class="w"> </span><span class="nb">test</span><span class="w"> </span>sites.<span class="w">

</span>$<span class="w"> </span>firefox<span class="w"> </span>http://localhost:8080<span class="w"> </span><span class="p">&amp;</span>
</pre>
<p>One shall then see a text-only page such as:</p>
<pre class="literal-block">
This is static website D. This is the one you should see if pointing
to the default virtual host corresponding to the local host. This
shows that the US-Web server is up and running.
</pre>
<p>Understanding the role of the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">main US configuration file</a> and of the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/for-testing/us-web-for-tests.config">US-Web configuration file</a> for this test should be fairly straightforward.</p>
<p>Based on that, devising one's version of them should allow to have one's US-Web server running at the cost of very little efforts.</p>
<p><span class="raw-html"><a name="otp"></a></span></p>
</div>
<div class="section" id="otp-considerations">
<span id="otp-build"></span><h2><a class="toc-backref" href="#toc-entry-49">OTP Considerations</a></h2>
<p>The default build system of US-Web is the native Ceylan one (triggered by <tt class="docutils literal">make all</tt>), yet a rebar3-based one is also available (triggered by <tt class="docutils literal">make <span class="pre">all-rebar3</span></tt>).</p>
<p>In this last context, as discussed in these sections of <a class="reference external" href="http://myriad.esperide.org/myriad.html#otp">Myriad</a>, <a class="reference external" href="http://wooper.esperide.org/index.html#otp">WOOPER</a>, <a class="reference external" href="http://traces.esperide.org/index.html#otp">Traces</a> and <a class="reference external" href="http://us-common.esperide.org/index.html#otp">US-Common</a>, the Universal Webserver <em>OTP application</em> is generated out of the build tree, ready to result directly in an <em>(OTP) release</em>. For that we rely on <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, <a class="reference external" href="https://github.com/erlware/relx">relx</a> and (possibly) <a class="reference external" href="https://hex.pm/">hex</a>.</p>
<p>Then we benefit from a standalone, complete Universal Webserver able to host as many virtual hosts on as many number of domains as needed.</p>
<p>As for Myriad, WOOPER, Traces, LEEC and US-Common, most versions of the Universal Webserver will be also published as <a class="reference external" href="https://hex.pm/packages/us_web">Hex packages</a>.</p>
<p>For more details, one may have a look at <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/conf/rebar.config.template">rebar.config.template</a>, the general rebar configuration file used when generating the Universal Webserver OTP application and release (implying the automatic management of all its dependencies).</p>
</div>
</div>
<div class="section" id="troubleshooting">
<h1><a class="toc-backref" href="#toc-entry-50">Troubleshooting</a></h1>
<div class="section" id="start-up-failure">
<h2><a class="toc-backref" href="#toc-entry-51">Start-up Failure</a></h2>
<p>Many operations take place when launching a US-Web instance - especially when requesting the generation of certificates; so most of the issues are expected to happen then.</p>
<p>If having deployed a (here, native) release (typically by running <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-native-build.sh">deploy-us-web-native-build.sh</a>) and if <tt class="docutils literal">systemctl restart <span class="pre">us-web-as-native-build.service</span></tt> failed, start by executing:</p>
<pre class="literal-block">
$ systemctl status us-web-as-native-build.service
</pre>
<p>It should return some appropriate information.</p>
<p>Most common sources of failures are:</p>
<ul class="simple">
<li>there is <strong>already a program listening at the target TCP port</strong> (typically port 80) designated for US-Web; one may check for example with <tt class="docutils literal">lsof <span class="pre">-i:80</span></tt>, otherwise with <tt class="docutils literal">netstat <span class="pre">-ltpn</span> | grep ':80'</tt>; of course use the same procedures for TCP port <tt class="docutils literal">443</tt> if having enabled <tt class="docutils literal">https</tt> on its standard port</li>
<li>check that no firewall is in the way (e.g. thanks to <tt class="docutils literal">iptables <span class="pre">-nL</span> | grep ':80'</tt>)</li>
<li>there may be a <strong>prior, lingering US-Web</strong> installation that is still running in the background; one may check for example with <tt class="docutils literal">ps <span class="pre">-edf</span> | grep us_web</tt>; in incrementally brutal ways, one may rely on:<ul>
<li><tt class="docutils literal">systemctl stop <span class="pre">us-web-as-native-build.service</span></tt>; note that, if any prior US-Web instance will be shutdown indeed, at least one some cases EPMD will still believe it is running and will thus block any next launch; so EPMD should be taken care of as well (at least by forcibly unregistering a vanished US-Web node), which is done automatically by the our stop/kill scripts discussed just next</li>
<li>or on <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/stop-us-web-native-build.sh">stop-us-web-native-build.sh</a></li>
<li>or even on <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/kill-us-web.sh">kill-us-web.sh</a></li>
</ul>
</li>
<li>as mentioned above, the <strong>EPMD daemon</strong> of interest (possibly running on a non-standard TCP port) may wrongly believe that a prior US-Web is running, and thus prevent a new one to be launched; a simple solution could be to run <tt class="docutils literal">killall epmd</tt>, yet unfortunately this solution is absolutely not selective enough: any other running Erlang application could be impacted as well; so now our EPMD daemons are <em>explicitly</em> launched, on different ports (default one for US-Web being 4508), with appropriate settings (<tt class="docutils literal"><span class="pre">-relaxed_command_check</span></tt>) that allow acting on these daemons independently</li>
<li>check your <tt class="docutils literal">authbind</tt> local configuration (refer to <a class="reference external" href="#authbind">this section</a>)</li>
</ul>
<p>If the problem remains, time to perform some investigation, refer to our <a class="reference internal" href="#local-monitoring">Local Monitoring</a> section.</p>
</div>
<div class="section" id="certification-generation-issues">
<h2><a class="toc-backref" href="#toc-entry-52">Certification Generation Issues</a></h2>
<p>One may check first that a webserver can indeed be reached for the target domain or subdomain (e.g. do not forget to define a wildcard CNAME like <tt class="docutils literal">*.foobar.org</tt> to point on <tt class="docutils literal">foobar.org</tt>, so that virtual hosts can be reached by the ACME servers).</p>
<p>Beware also not to trigger too many / too frequent certificate requests, as this could lead to reaching the rate limits implemented by the ACME servers: then even perfectly legit, correct operations would fail.</p>
</div>
</div>
<div class="section" id="hints">
<h1><a class="toc-backref" href="#toc-entry-53">Hints</a></h1>
<p>Various keys (e.g. <tt class="docutils literal">us_app_base_dir</tt>) may be defined in the US configuration files (e.g. in a <tt class="docutils literal">{us_app_base_dir, &quot;/opt/some_dir&quot;}</tt> entry), from which other elements may derive (e.g. paths). To denote the value associated to a key, we surround in this documentation the key with <tt class="docutils literal">&#64;</tt> characters (this is just a reading convention).</p>
<p>For example <tt class="docutils literal"><span class="pre">&#64;us_app_base_dir&#64;/hello.txt</span></tt> would correspond here to <tt class="docutils literal">/opt/some_dir/hello.txt</tt>.</p>
<div class="section" id="development-vs-production-mode">
<h2><a class="toc-backref" href="#toc-entry-54">Development vs Production Mode</a></h2>
<p>Should a mismatch be detected between the compile-time execution target and the runtime, user-configured, execution context, a warning will be issued in the traces.</p>
<p>When building a fresh release thanks to <tt class="docutils literal">make <span class="pre">release-dev</span></tt>, the corresponding action (<tt class="docutils literal">rebar3 release</tt>) will build that release with the base settings, hence in development mode (so not &quot;as prod&quot; - i.e. not with the <tt class="docutils literal">prod</tt> profile, hence not selecting our <tt class="docutils literal">production</tt> execution target).</p>
<p>Note that all dependencies (thus of course including Myriad, WOOPER, Traces and LEEC) are built by rebar3 with their <tt class="docutils literal">prod</tt> settings. As a result, relying on <tt class="docutils literal">basic_utils:get_execution_target/0</tt> will only tell us about <tt class="docutils literal">Myriad</tt> settings (thus always built in production mode), not about any other layer (including <tt class="docutils literal"><span class="pre">US-Web</span></tt>). A US-Web trace allows to check all relevant modes, notably that, in production, the production settings apply indeed.</p>
</div>
<div class="section" id="development-hints">
<h2><a class="toc-backref" href="#toc-entry-55">Development Hints</a></h2>
<div class="section" id="operating-directly-from-within-the-rebar-build-tree">
<h3><a class="toc-backref" href="#toc-entry-56">Operating directly from within the rebar build tree</a></h3>
<p>(not recommended in a development phase)</p>
<p>If having modified and recompiled a Ceylan prerequisite (e.g. WOOPER), then, before generating the release, run from its root (e.g. <tt class="docutils literal">us_web/_build/default/lib/wooper</tt>):</p>
<pre class="code bash literal-block">
$<span class="w"> </span>make<span class="w"> </span>rebar3-copy-beams<span class="w"> </span><span class="nv">REBAR_BUILD_DIR</span><span class="o">=</span>../../
</pre>
<p>Or, simply run <tt class="docutils literal">make <span class="pre">rebar3-compile</span> <span class="pre">REBAR_BUILD_DIR=../../</span></tt> (and no need to run <tt class="docutils literal">make release</tt> afterwards).</p>
</div>
<div class="section" id="operating-from-checkouts-build-trees">
<h3><a class="toc-backref" href="#toc-entry-57">Operating from <tt class="docutils literal">_checkouts</tt> build trees</a></h3>
<p>(recommended in a development phase, as a lot more flexible/unified than the previous method)</p>
<p>Create a <tt class="docutils literal">us_web/_ckeckouts</tt> directory containing symbolic links to repositories of dependencies (e.g. <tt class="docutils literal">myriad</tt>) that may be updated locally; or, preferably, execute the <tt class="docutils literal"><span class="pre">create-us-web-checkout</span></tt> make target to automate and streamline this step.</p>
</div>
</div>
<div class="section" id="configuration-hints">
<h2><a class="toc-backref" href="#toc-entry-58">Configuration Hints</a></h2>
<div class="section" id="batch-mode">
<h3><a class="toc-backref" href="#toc-entry-59">Batch Mode</a></h3>
<p>One can update <tt class="docutils literal">us_web/conf/sys.config</tt> in order to toggle batch mode (e.g. to enable/disable a graphical trace supervision) after build time.</p>
<p>It deals with the configuration of the <tt class="docutils literal">Traces</tt> application, so it comes very early at start-up (at application boot, hence before US-Web specific settings can be read, so this option would be difficult to put in the US configuration files).</p>
</div>
<div class="section" id="location-of-applications">
<h3><a class="toc-backref" href="#toc-entry-60">Location of Applications</a></h3>
<p>The location of the US-Web application is bound to differ depending on the context of use (development/production deployments, host-wise, etc.), whereas it is needed to be known at the very least by its start/stop scripts.</p>
<p>So its path must be specified (most preferably as an absolute directory) in the US-Web configuration file. However, at least for test configuration files, relying on an absolute directory would not be satisfactory, as the user may install the US-Web framework at any place and testing should not require a manual configuration update.</p>
<p>As a result, should an application location (e.g. US-Web) not be specified in the configuration, it will be looked-up in the shell environment (using the <tt class="docutils literal">US_WEB_APP_BASE_DIR</tt> variable) for that and, should this variable not be set, as a last-resort an attempt to guess that location will be done.</p>
</div>
<div class="section" id="system-related-hints">
<h3><a class="toc-backref" href="#toc-entry-61">System-related Hints</a></h3>
<p>Besides the use of specific, unprivileged user/group thanks to the use of authbind (set with a minimal depth level), the system resources (notably the maximum number of file descriptors) are reported (among the traces; search for <tt class="docutils literal">System description</tt>) at the startup of the US-Web server.</p>
<p>Moreover the launch scripts (namely <tt class="docutils literal"><span class="pre">start-us-web-native-build.sh</span></tt> and <tt class="docutils literal"><span class="pre">start-us-web-release.sh</span></tt>) raise the limit in terms of maximum number of file descriptors opened by the US-Web process, so that the connection acceptor does not have to reduce its accept rate (typically because of rogue bots performing pseudo-denials of service).</p>
<p>Finally, any webserver shall rely preferably on:
- a sufficiently paranoid firewall (see section in <a class="reference internal" href="#execution-hints">Execution Hints</a>)
- an uninterruptible power supply (UPS), protecting the server and the telecom appliances involved</p>
</div>
<div class="section" id="web-related-hints">
<h3><a class="toc-backref" href="#toc-entry-62">Web-related hints</a></h3>
<ul class="simple">
<li>most paths (e.g. <tt class="docutils literal">default_web_root</tt>, in the US-Web configuration) can be defined as <strong>relative</strong> ones (mostly useful for embedded tests; otherwise absolute paths shall be preferred); in this case they will be relative to the runtime current directory, typically <tt class="docutils literal"><span class="pre">[...]/us_web/_build/default/rel/us_web/</span></tt> in development mode</li>
<li>the <tt class="docutils literal">default_domain_catch_all</tt> atom allows to designate any <strong>domain-level host</strong> (e.g. <tt class="docutils literal">foobar.org</tt>) that did not match previous host rules</li>
<li>in the context of a given host (e.g. <tt class="docutils literal">foobar.org</tt>), the <tt class="docutils literal">default_vhost_catch_all</tt> atom allows to designate any of its <strong>virtual hosts</strong> (e.g. <tt class="docutils literal">bar</tt>, to be understood as <tt class="docutils literal">bar.foobar.org</tt>) that did not match previous path rules <a class="footnote-reference" href="#footnote-8" id="footnote-reference-8">[8]</a></li>
<li>refer to <tt class="docutils literal"><span class="pre">us_web/priv/for-testing</span></tt> for an example setup and configuration files</li>
<li>the web roots shall be owned by the user running US-Web (e.g. <tt class="docutils literal">chown <span class="pre">-R</span> <span class="pre">us-web-user:us-group</span> /opt/www</tt>)</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-8">[8]</a></td><td>When using https, configuring a catch-all might be ill-advised, as whenever an unanticipated virtual host is requested, a certificate warning (e.g. <tt class="docutils literal">SSL_ERROR_BAD_CERT_DOMAIN</tt>) is triggered - as by design no certificate (direct or through SANs) will exist for this host (a &quot;connection failed&quot; error is then more desirable).</td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="execution-hints">
<h2><a class="toc-backref" href="#toc-entry-63">Execution Hints</a></h2>
<ul>
<li><p class="first">the current working directory of a US-Web instance deployed thanks to <tt class="docutils literal"><span class="pre">deploy-us-web-release.sh</span></tt> is <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z</span></tt></p>
</li>
<li><p class="first">if unable to connect, the firewall (e.g. <tt class="docutils literal">iptables <span class="pre">-L</span></tt>) might be the culprit! Note that the whole US framework tends to rely on a specific TCP range (e.g. <tt class="docutils literal"><span class="pre">50000-55000</span></tt>) for inter-VM communications; for HTTP, TCP port 80 is expected to be opened, and this is TCP port 443 for HTTPS (see also our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script)</p>
</li>
<li><p class="first">to debug (once batch mode has been enabled/disabled), one may use the <tt class="docutils literal">debug</tt> make target, from the tree root</p>
</li>
<li><p class="first">to test server-side errors, one may create, in a web root, a directory that cannot be traversed (e.g. <tt class="docutils literal">chmod 000 <span class="pre">my-dir</span></tt>) and direct one's browser to a content supposedly located in this directory <a class="footnote-reference" href="#footnote-9" id="footnote-reference-9">[9]</a>; note that, if requesting instead that faulty directory itself (not an element within), then (whether or not a trailing <tt class="docutils literal">/</tt> is specified), an error 403 (<tt class="docutils literal">ERROR 403: Forbidden</tt>) is returned instead (corresponds to the <tt class="docutils literal">case A</tt> in the corresponding sources)</p>
</li>
<li><p class="first">to test host matching (e.g. for a <tt class="docutils literal">baz</tt> virtual host), including the default catch-all even on a computer having no specific public DNS entries, one may simply add in <tt class="docutils literal">/etc/hosts</tt> entries like:</p>
<pre class="literal-block">
127.0.0.1 foobar-test.net baz.foobar-test.net other.foobar-test.net
</pre>
</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-9">[9]</a></td><td>See <tt class="docutils literal"><span class="pre">priv/for-testing/test-static-website-A/to-test-for-errors</span></tt>, which was created precisely for that. Note that its permissions have been restored to sensible values, as otherwise that directory was blocking the OTP release generation.</td></tr>
</tbody>
</table>
<ul class="simple">
<li>log rotation results in timestamped, compressed files such as <tt class="docutils literal"><span class="pre">access-for-bar.localhost.log.2019-12-31-at-22h-03m-35s.xz</span></tt>; note that the timestamp corresponds to the moment at which the rotation took place (hence not the time range of these logs; more an upper bound thereof)</li>
<li>to test whether a combination of EPMD port and cookie is legit, one may use for example:</li>
</ul>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nv">ERL_EPMD_PORT</span><span class="o">=</span><span class="m">44000</span><span class="w"> </span>/usr/local/lib/erlang/erts-x.y/bin/erl_call<span class="w">
   </span>-name<span class="w"> </span>us_web&#64;baz.foobar.org<span class="w"> </span>-R<span class="w"> </span>-c<span class="w"> </span><span class="s1">'MyCookie'</span><span class="w"> </span>-timeout<span class="w"> </span><span class="m">60</span><span class="w">
   </span>-a<span class="w"> </span><span class="s1">'erlang is_alive'</span>
</pre>
<p>You then expect <tt class="docutils literal">true</tt> to be returned - not:</p>
<pre class="code bash literal-block">
erl_call:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span>node<span class="w"> </span>us_web&#64;baz.foobar.org
</pre>
</div>
<div class="section" id="monitoring-hints">
<h2><a class="toc-backref" href="#toc-entry-64">Monitoring Hints</a></h2>
<div class="section" id="in-terms-of-unix-processes">
<h3><a class="toc-backref" href="#toc-entry-65">In terms of (UNIX) Processes</a></h3>
<p>A running US-Web server will not be found by looking up <tt class="docutils literal">beam</tt> or <tt class="docutils literal">beam.smp</tt> through <tt class="docutils literal">ps</tt>; as an OTP release, it relies first on the <tt class="docutils literal">run_erl</tt> launcher, like shown, based on <tt class="docutils literal">ps <span class="pre">-edf</span></tt>, in:</p>
<pre class="code bash literal-block">
UID<span class="w">         </span>PID<span class="w">    </span>PPID<span class="w">  </span>C<span class="w"> </span>STIME<span class="w"> </span>TTY<span class="w"> </span>TIME<span class="w">     </span>CMD<span class="w">
</span>us-web-user<span class="w"> </span><span class="m">767067</span><span class="w">    </span><span class="m">1</span><span class="w">  </span><span class="m">0</span><span class="w"> </span>Feb15<span class="w"> </span>?<span class="w">   </span><span class="m">00</span>:00:00<span class="w"> </span>/usr/local/lib/erlang/erts-x.y/bin/run_erl<span class="w">
  </span>-daemon<span class="w"> </span>/tmp/erl_pipes/us_web&#64;MY_FQDN/<span class="w"> </span>/opt/universal-server/us_web-US_WEB_VERSION/log<span class="w">
  </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;/opt/universal-server/us_web-US_WEB_VERSION/bin/us_web&quot;</span><span class="w"> </span><span class="s2">&quot;console&quot;</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span>--relx-disable-hooks
</pre>
<p>This can be interpreted as:</p>
<ul class="simple">
<li>not running as root, but as a dedicated, weakly privileged user</li>
<li>its parent process (PPID) is the first overall process (as a daemon)</li>
<li>STIME is the time when the process started</li>
<li>no associated TTY (runs detached in the background)</li>
</ul>
<p>This launcher created the main, central, <tt class="docutils literal">us_web</tt> (UNIX) process, parent of all the VM worker (system) threads.</p>
<p><tt class="docutils literal">pstree <span class="pre">-u</span></tt> (or <tt class="docutils literal">ps <span class="pre">-e</span> <span class="pre">--forest</span></tt>) tells us about the underlying process hierarchy:</p>
<pre class="code bash literal-block">
<span class="o">[</span>...<span class="o">]</span><span class="w">
  </span><span class="p">|</span>-run_erl<span class="o">(</span>us-web-user<span class="o">)</span>---beam.smp---erl_child_setup---inet_gethost---inet_gethost<span class="w">
  </span><span class="p">|</span><span class="w">                             </span><span class="p">|</span>-158*<span class="o">[{</span>beam.smp<span class="o">}]</span><span class="w">
</span><span class="o">[</span>...<span class="o">]</span>
</pre>
<p>The 158 threads must correspond to:</p>
<ul class="simple">
<li>128 async ones (<tt class="docutils literal"><span class="pre">-A</span> 128</tt>)</li>
<li>30 &quot;normal&quot; threads (on a computer having a single CPU with 8 cores with Hyperthreading, hence 16 logical cores)</li>
</ul>
<p>Using <tt class="docutils literal">htop</tt>, one can see that the <tt class="docutils literal">run_erl</tt> process spawned a <tt class="docutils literal">us_web</tt> one (namely <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-US_WEB_VERSION/bin/us_web</span></tt>) that is far larger in (VIRT) memory (e.g. 5214MB, instead of 5832KB for the former).</p>
<p><tt class="docutils literal">us_web</tt> in turn created the numerous threads.</p>
<p><tt class="docutils literal">RSS/RSZ</tt> (<em>Resident Set Size</em>) is a far better metric than <tt class="docutils literal">VIRT/VSZ</tt> (<em>Virtual Memory Size</em>); indeed <tt class="docutils literal">VIRT = RSS + SWP</tt> and:</p>
<ul class="simple">
<li><tt class="docutils literal">RSS</tt> shows how much memory is allocated to that process and is in RAM; it does not include memory that is swapped out; it includes memory from shared libraries (as long as the pages from those libraries are actually in memory), and all stack and heap memory used</li>
<li><tt class="docutils literal">VIRT</tt> includes all memory that the process can access, including memory that is swapped out, memory that is allocated but not used, and memory that is from shared libraries</li>
</ul>
<p>Knowing that, with <tt class="docutils literal">ps</tt>, one may add <tt class="docutils literal"><span class="pre">-L</span></tt> to display thread information and <tt class="docutils literal"><span class="pre">-f</span></tt> to have full-format listing, a base command to monitor the US-Web processes is: <tt class="docutils literal">ps <span class="pre">-eww</span> <span class="pre">-o</span> rss,pid,args | grep us_web</tt>, with:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">-e</span></tt>: select all processes</li>
<li><tt class="docutils literal"><span class="pre">-w</span></tt> (once or twice): request wide output</li>
<li><tt class="docutils literal"><span class="pre">-o</span> rss,pid,args</tt>: display RSS memory used (in kilobytes), PID and full command line</li>
</ul>
<p>(apparently there is no direct way of displaying human-readable sizes)</p>
<p>See also our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/list-processes-by-size.sh">list-processes-by-size.sh</a> script; typical use:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>list-processes-by-size.sh<span class="w">
   </span>Listing<span class="w"> </span>running<span class="w"> </span>processes<span class="w"> </span>by<span class="w"> </span>decreasing<span class="w"> </span>resident<span class="w"> </span>size<span class="w"> </span><span class="k">in</span><span class="w"> </span>RAM<span class="w"> </span><span class="o">(</span>total<span class="w"> </span>size<span class="w"> </span><span class="k">in</span><span class="w"> </span>KiB<span class="o">)</span>:<span class="w">
 </span>RSS<span class="w">  </span>PID<span class="w">      </span>COMMAND<span class="w">
</span><span class="o">[</span>...<span class="o">]</span><span class="w">
</span><span class="m">1204</span><span class="w">  </span><span class="m">1695242</span><span class="w">  </span>/usr/local/lib/erlang/erts-11/bin/run_erl<span class="w"> </span>-daemon<span class="w"> </span>/tmp/erl_pipes/us_web&#64;somehost.foobar.org/<span class="w"> </span>/opt/universal-server/us_web-x.y.z/log<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;/opt/universal-server/us_web-x.y.z/bin/us_web&quot;</span><span class="w"> </span><span class="s2">&quot;console&quot;</span><span class="w"> </span><span class="s1">''</span><span class="w">  </span>--relx-disable-hooks<span class="w">
</span><span class="m">67776</span><span class="w"> </span><span class="m">1695243</span><span class="w"> </span>/opt/universal-server/us_web-x.y.z/bin/us_web<span class="w"> </span>-A<span class="w"> </span><span class="m">128</span><span class="w"> </span>--<span class="w"> </span>-root<span class="w"> </span>/opt/universal-server/us_web-x.y.z<span class="w"> </span>-progname<span class="w"> </span>opt/universal-server/us_web-x.y.z/bin/us_web<span class="w"> </span>--<span class="w"> </span>-home<span class="w"> </span>/home/us-web-user<span class="w"> </span>-epmd_port<span class="w"> </span><span class="m">4526</span><span class="w"> </span>--<span class="w"> </span>-boot<span class="w"> </span>/opt/universal-server/us_web-x.y.z/releases/x.y.z/start<span class="w"> </span>-mode<span class="w"> </span>embedded<span class="w"> </span>-boot_var<span class="w"> </span>ERTS_LIB_DIR<span class="w"> </span>/usr/local/lib/erlang/lib<span class="w"> </span>-config<span class="w"> </span>/opt/universal-server/us_web-x.y.z/releases/x.y.z/sys.config<span class="w"> </span>-name<span class="w"> </span>us_web<span class="w"> </span>-setcookie<span class="w"> </span>us_web_initial_cookie<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>console<span class="w"> </span>--relx-disable-hooks<span class="w"> </span>--<span class="w">
</span><span class="o">[</span>...<span class="o">]</span>
</pre>
<p>This confirms that, even if higher VIRT sizes can be reported (e.g. 5214M, hence roughly 5GB), the RSS size may be 67776 (KB, hence 66 MB), i.e. very little, and does not vary much.</p>
<p>Indeed, in terms of RSS use (for a few domains, each with a few low-traffic websites, if that matters), we found:</p>
<ul class="simple">
<li>at start-up: only about 67MB</li>
<li>after 5 days: just 68 MB</li>
<li>after 24 days: 76 MB</li>
<li>after 55 days: 80-88 MB</li>
</ul>
<p>A more recent server instance is using, after more than 70 days, 60 MB of RSS memory, whereas after 30 days another ones was 108 MB. Anyway quite low.</p>
</div>
<div class="section" id="trace-monitoring">
<h3><a class="toc-backref" href="#toc-entry-66">Trace Monitoring</a></h3>
<p>Use the <tt class="docutils literal"><span class="pre">us_web/priv/bin/monitor-us-web.sh</span></tt> script in order to monitor the traces of an already running, possibly remote, US-Web instance.</p>
<p>Note that the monitored US-Web instance will be by default the one specified in any <tt class="docutils literal"><span class="pre">us-monitor.config</span></tt> file located in the US configuration directory.</p>
<p>One may specify on the command-line another configuration file if needed, such as <tt class="docutils literal"><span class="pre">us-monitor-for-development.config</span></tt>.</p>
</div>
<div class="section" id="node-test-connection">
<h3><a class="toc-backref" href="#toc-entry-67">Node Test &amp; Connection</a></h3>
<p>If desperate enough, one may also run, possibly from another host, and based on the settings to be found in the configuration files:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nv">ERL_EPMD_PORT</span><span class="o">=</span>XXXX<span class="w"> </span>erl<span class="w"> </span>-name<span class="w"> </span>tester<span class="w"> </span>-setcookie<span class="w"> </span>CCCC<span class="w"> </span>-kernel<span class="w"> </span>inet_dist_listen_min<span class="w"> </span>MIN<span class="w"> </span>inet_dist_listen_max<span class="w"> </span>MAX<span class="w">

</span><span class="m">1</span>&gt;<span class="w"> </span>net_adm:ping<span class="o">(</span><span class="s1">'us_web&#64;foobar.org'</span><span class="o">)</span>.<span class="w">
</span>pong
</pre>
<p>Then one may switch to the <em>Job control mode</em> (JCL) by pressing <tt class="docutils literal"><span class="pre">Ctrl-G</span></tt> then <tt class="docutils literal">r</tt> to start a remote job on the US-Web node.</p>
</div>
</div>
<div class="section" id="forcing-certificate-renewal-without-restarting-the-server">
<h2><a class="toc-backref" href="#toc-entry-68">Forcing Certificate Renewal Without Restarting the Server</a></h2>
<p>The renewal of certificates is a rather error-prone operation, as it involves third-party (ACME) servers, which additionally enforce various rate limits.</p>
<p>Moreover this operation will be triggered automatically a long time <a class="footnote-reference" href="#footnote-10" id="footnote-reference-10">[10]</a> after the server has been launched, in the background, so its silent failure shall be considered (even though the traces should duly keep track of it).</p>
<table class="docutils footnote" frame="void" id="footnote-10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-10">[10]</a></td><td>Refer to the <tt class="docutils literal">dhms_cert_renewal_period_{development,production}</tt> defines in <tt class="docutils literal">class_USCertificateManager</tt>; typically, in production mode, 70 days are to elapse between two renewals.</td></tr>
</tbody>
</table>
<p>So the goal is to trigger the <tt class="docutils literal">renewCertificate/1</tt> oneway of the certificate manager of each website. This can be done simply by triggering the <tt class="docutils literal">renewCertificates/1</tt> request of the US-Web configuration server - which happens to be a registered process.</p>
<p>To determine the name and scope of this server and the various Erlang settings (EPMD port and Erlang cookie) that will be needed in order to connect to the US node, one may read one's US configuration, typically in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server/us.config</span></tt>, for: <tt class="docutils literal">vm_cookie</tt>, <tt class="docutils literal">epmd_port</tt> and <tt class="docutils literal">us_web_config_filename</tt>, the configuration file from which <tt class="docutils literal">us_web_config_server_registration_name</tt> can be obtained.</p>
<p>It may be safer to monitor remotely from then on the traces of that server, using for that the <tt class="docutils literal"><span class="pre">priv/bin/monitor-us-web.sh</span></tt> script.</p>
<p>Then, when logged on the server, or from any client able to connect to it:</p>
<pre class="code bash literal-block">
<span class="c1"># We are using short names here:
</span>$<span class="w"> </span><span class="nv">ERL_EPMD_PORT</span><span class="o">=</span><span class="m">4506</span><span class="w"> </span>erl<span class="w"> </span>-sname<span class="w"> </span>renewer<span class="w"> </span>-setcookie<span class="w"> </span><span class="s1">'MY_VM_COOKIE'</span><span class="w">
</span><span class="o">(</span>renewer&#64;tempest<span class="o">)</span><span class="m">1</span>&gt;<span class="w"> </span>net_adm:ping<span class="o">(</span><span class="s1">'us_web&#64;hurricane'</span><span class="o">)</span>.<span class="w">
</span>pong<span class="w">
</span><span class="o">(</span>renewer&#64;tempest<span class="o">)</span><span class="m">2</span>&gt;<span class="w"> </span><span class="nv">CfgSrvPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>global:whereis_name<span class="o">(</span><span class="s1">'my_name_for_the_us_web_config_server'</span><span class="o">)</span>.<span class="w">
</span>&lt;<span class="m">9385</span>.172.0&gt;<span class="w">
</span><span class="o">(</span>renewer&#64;tempest<span class="o">)</span><span class="m">3</span>&gt;<span class="w"> </span>CfgSrvPid<span class="w"> </span>!<span class="w"> </span><span class="o">{</span>renewCertificates,<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>self<span class="o">()}</span>.<span class="w">
</span><span class="o">{</span>renewCertificates,<span class="o">[]</span>,&lt;<span class="m">0</span>.94.0&gt;<span class="o">}</span><span class="w">
</span>%<span class="w"> </span>Expecting<span class="w"> </span>certificate_renewals_over:<span class="w">
</span><span class="o">(</span>renewer&#64;tempest<span class="o">)</span><span class="m">4</span>&gt;<span class="w"> </span>receive<span class="w"> </span><span class="o">{</span>wooper_result,R<span class="o">}</span><span class="w"> </span>-&gt;<span class="w"> </span>io:format<span class="o">(</span><span class="s2">&quot;Received: ~p~n&quot;</span>,<span class="w"> </span><span class="o">[</span>R<span class="o">])</span><span class="w"> </span>end.
</pre>
</div>
<div class="section" id="safer-us-web-updates-testing-a-new-instance-first-out-of-the-loop">
<h2><a class="toc-backref" href="#toc-entry-69">Safer US-Web Updates: Testing a New Instance First Out of the Loop</a></h2>
<div class="section" id="objective">
<h3><a class="toc-backref" href="#toc-entry-70">Objective</a></h3>
<p>When running a reference server for a set of given domains, one should avoid stopping US-Web, updating its code and attempting to relaunch it: not only because this may imply a non-negligible downtime, but also, more importantly, because, should a failure happen, it would have to be fixed live, in the hurry, whereas no one can access anymore any of the hosted sites. Not a convenient situation.</p>
<p>A better, safer (but not simpler) approach is instead to install one's newer server instance as a test one on the target host, build it and test it on a temporary setting (on an auxiliary TCP port) and, if and only if the operation is fully satisfactory, to switch the same setting on the actual port (once the prior reference instance has been shut down); if on the contrary something goes wrong with the test, it can be safely fixed out of the critical path, not implying a specific downtime.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note though that running US-Web on non-standard ports will not permit the http-01 challenges to succeed (as the ACME servers will expect to find the answers to their challenges by accessing standard ports).</p>
</div>
</div>
<div class="section" id="test-installation">
<h3><a class="toc-backref" href="#toc-entry-71">Test Installation</a></h3>
<p>For such a test bed to exist, the usual <a class="reference external" href="#server-deployment">installation step</a> shall be followed by a specific, separate configuration step.</p>
<p>Installing is merely a matter of transferring the <tt class="docutils literal"><span class="pre">deploy-us-web-native-build.sh</span></tt> script to one's server and to run it (as a normal user), as <tt class="docutils literal"><span class="pre">deploy-us-web-native-build.sh</span> <span class="pre">--no-launch</span></tt> so that it cannot interfere with any reference version running.</p>
<p>A <tt class="docutils literal"><span class="pre">check-foobar-website-availability.sh</span></tt> script may be useful to efficiently check the state of that reference version.</p>
</div>
<div class="section" id="test-configuration">
<h3><a class="toc-backref" href="#toc-entry-72">Test Configuration</a></h3>
<p>A first action is to devise a corresponding configuration file and to launch a corresponding instance on dedicated TCP ports.</p>
<p>It will require a dedicated US-Web configuration file, let's name it <tt class="docutils literal"><span class="pre">foobar-us-web-for-testing.config</span></tt>. It will have to be referenced by a corresponding US configuration file (namely <tt class="docutils literal"><span class="pre">us-config</span></tt>), both of them expected to be in a <tt class="docutils literal"><span class="pre">universal-server</span></tt> directory in a test-specific root directory, e.g. in <tt class="docutils literal"><span class="pre">TEST_DIR=/opt/universal-server/us_web-data/configuration-for-testing/universal-server</span></tt> - thus as <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-data/configuration-for-testing/universal-server/{foobar-us-web-for-testing,us}.config</span></tt> - rather than in a standard root directory such as <tt class="docutils literal">/etc/xdg</tt>.</p>
<p>The most direct/reliable approach is to copy the reference versions of these two files and modify them as little as possible.</p>
<p>The test <tt class="docutils literal"><span class="pre">us-config</span></tt> file should specify:</p>
<ul class="simple">
<li>a cookie of its own (e.g. <tt class="docutils literal"><span class="pre">foobar-testing-be3be613-96d8-4203-a502-73cc42a5e5e2</span></tt>)</li>
<li>(the EPMD port may be set only in its US-Web counterpart configuration file)</li>
<li>possibly different users (preferably not, as wanting to stick as close as possible to the target settings)</li>
<li>updated directories (possibly all - like <tt class="docutils literal">us_log_dir</tt> - pointing to <tt class="docutils literal">TEST_DIR</tt>)</li>
<li>the updated <tt class="docutils literal">us_web_config_filename</tt>, like <tt class="docutils literal"><span class="pre">foobar-us-web-for-testing.config</span></tt></li>
</ul>
<p>This <tt class="docutils literal"><span class="pre">foobar-us-web-for-testing.config</span></tt> associated file could then specify:</p>
<ul class="simple">
<li>an EPMD port of its own (e.g. 4515); if using our <tt class="docutils literal"><span class="pre">iptables.rules-Gateway.sh</span></tt> script (refer to <a class="reference external" href="https://howtos.esperide.org/Networking.html#firewall-management">this section</a> for more details), one may check in <tt class="docutils literal"><span class="pre">/etc/iptables.settings-Gateway.sh</span></tt> the <tt class="docutils literal">us_{low,high}est_epmd_port</tt> variables in order to pick an EPMD port in the LAN-allowed input range, so that hosts from the LAN may connect to the test US-Web instance on the gateway if needed</li>
<li><tt class="docutils literal">us_web_data_dir</tt> and <tt class="docutils literal">us_web_log_dir</tt> entries pointing to the aforementioned TEST_DIR</li>
<li>updated, non-clashing TCP ports, for example <tt class="docutils literal">http_tcp_port</tt> being 8000 and <tt class="docutils literal">https_tcp_port</tt> being 8443</li>
<li>for extra caution, <tt class="docutils literal">certificate_mode</tt> may be set to <tt class="docutils literal">development</tt> (rather than <tt class="docutils literal">production</tt>)</li>
<li><tt class="docutils literal">challenge_type</tt> can be set, knowing its default is <tt class="docutils literal"><span class="pre">dns-01</span></tt></li>
<li>for routes, for the sake of testing, a single domain may be kept</li>
</ul>
<p>Finally, if relying on a <tt class="docutils literal"><span class="pre">dns-01</span></tt> challenge, the credentials for the DNS provider will have to be available. Creating a symlink in the test-specific root directory to, say, <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server/leec-ovh-credentials-for-foobar.org.txt</span></tt> should be sufficient for that.</p>
</div>
<div class="section" id="firewall-configuration">
<h3><a class="toc-backref" href="#toc-entry-73">Firewall Configuration</a></h3>
<p>A second step is, firewall-wise, to enable (temporarily) the access to the test instance.</p>
<p>The target EPMD port must already fall in a LAN-supported range, yet we also want to be able to properly test as if we were a random Internet user, thus connecting from the WAN.</p>
<p>So:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">8000</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT<span class="w">
</span>$<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">8443</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</pre>
</div>
<div class="section" id="test-code-updates">
<h3><a class="toc-backref" href="#toc-entry-74">Test Code Updates</a></h3>
<p>Tests may show that some modules have to be fixed, and thus that the server installation has to be updated accordingly (rather than be deployed again from scratch). The <tt class="docutils literal"><span class="pre">sync-all-to-server</span></tt> make target is useful to synchronise the code base of a given layer on the server from a development computer; for that the <tt class="docutils literal">CEYLAN_SYNC_TARGET_ROOT</tt> must be set to the root path on the server; for example:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>make<span class="w"> </span>sync-all-to-server<span class="w"> </span><span class="nv">CEYLAN_SYNC_TARGET_ROOT</span><span class="o">=</span>/opt/universal-server/us_web-native
</pre>
</div>
<div class="section" id="launching-the-test-server">
<h3><a class="toc-backref" href="#toc-entry-75">Launching the Test Server</a></h3>
<p>For this use, <tt class="docutils literal">systemctl</tt> would not be convenient. A better approach is to start one's test server explicitly, based on the configuration files that were just devised.</p>
<p>First of all, no prior test instance should exist, otherwise they would clash EPMD-wise. <tt class="docutils literal">ps <span class="pre">-edf|grep</span> <span class="pre">-i</span> epmd</tt> may help.</p>
<p>Then the target test instance can be launched, as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/opt/universal-server/us_web-latest/us_web/priv/bin<span class="w">
</span>$<span class="w"> </span>./start-us-web-native-build.sh<span class="w"> </span>/opt/universal-server/us_web-data/configuration-for-testing/universal-server
</pre>
</div>
<div class="section" id="testing-it">
<h3><a class="toc-backref" href="#toc-entry-76">Testing it</a></h3>
<p>Either the launch was reported as succeeded or not.</p>
<p>In the latter case, a launch time-out was reported. The log of the Erlang VM (typically <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-native/us_web/log/erlang.log.1</span></tt>) will probably give relevant information. May a prior test instance is on the way, clashing in the same EPMD instance, or regarding the target TCP ports?</p>
<p>In the former case, a success is assumed. The best way to confirm this is to check the overall result by ourself, with <tt class="docutils literal">wget <span class="pre">http://foobar.org:8000</span> <span class="pre">-O</span> -</tt>.</p>
<p>Further insight to be obtained based on <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-data/configuration-for-testing/us_web.traces</span></tt>.</p>
</div>
<div class="section" id="test-teardown">
<h3><a class="toc-backref" href="#toc-entry-77">Test Teardown</a></h3>
<p>Finally, now that the test is over, we can close up the mountain with:</p>
<pre class="code bash literal-block">
<span class="c1"># The -n option is used to have port numbers rather than aliases:
</span>$<span class="w"> </span>iptables<span class="w"> </span>-L<span class="w"> </span>--line-numbers<span class="w"> </span>-n<span class="w">

</span>$<span class="w"> </span>iptables<span class="w"> </span>-D<span class="w"> </span>INPUT<span class="w"> </span>X<span class="w">

</span><span class="c1"># Again, as the previous deletion decremented the number of the last line:
</span>$<span class="w"> </span>iptables<span class="w"> </span>-D<span class="w"> </span>INPUT<span class="w"> </span>X
</pre>
</div>
</div>
</div>
<div class="section" id="standard-log-generation-analysis">
<h1><a class="toc-backref" href="#toc-entry-78">Standard Log Generation &amp; Analysis</a></h1>
<p>The objective in this section is to have US-Web generate access logs like the standard webservers do, so that standard tools able to produce log analyses can be used afterwards. They may generate HTML pages, which can in turn be appropriately hosted directly by the US-Web framework itself.</p>
<p>US-Web (rather than a <tt class="docutils literal">crontab</tt>) takes control of log writing, for full control onto the start, stop and rotation behaviours.</p>
<p>For write efficiency, It is done by an (Erlang) process specific to a given virtual host (see <tt class="docutils literal">class_USWebLogger</tt>), and a task ring is used for synchronicity and load balancing with regard to log report generation.</p>
<p>For each virtual host (ex: <tt class="docutils literal">baz.foobar.org</tt>), following log files shall be generated:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt></li>
<li><tt class="docutils literal"><span class="pre">error-for-baz.foobar.org.log</span></tt></li>
</ul>
<p>They are to be stored by default in the <tt class="docutils literal">/var/log</tt> directory, which can be overridden in the US-Web configuration file thanks to the <tt class="docutils literal">us_web_log_dir</tt> key.</p>
<p>At the Cowboy level, logging could be done as a <a class="reference external" href="https://ninenines.eu/docs/en/cowboy/2.7/guide/middlewares/">middleware</a>, yet we preferred to perform it directly in the handler (typically the static one, <tt class="docutils literal">us_web_static</tt>), presumably for a better control.</p>
<p>Once access logs are produced, a specific tool is to generate reports out of them, as discussed in the next section.</p>
<div class="section" id="web-analytics-software-choice-of-tool">
<h2><a class="toc-backref" href="#toc-entry-79">Web Analytics Software: Choice of Tool</a></h2>
<p>The desired properties for such a tool are mainly: available as free software, trustable, standard, actively and well-maintained, running locally (as opposed to remote services such as Google Analytics), standalone, not resource-demanding, controllable, generating a local analysis (static) website, based only on basic webserver logs (not on a dedicated database, not on markers to be added to all webpages such as 1-pixel images), virtual-host compliant.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/List_of_web_analytics_software">Various tools</a> can be considered, including (best spotted candidates, by increasing level of interest):</p>
<ul class="simple">
<li><a class="reference external" href="http://www.webalizer.org/">The Webalizer</a>: simple reports only, not maintained since 2013?</li>
<li><a class="reference external" href="http://www.openwebanalytics.com/">OWA</a>: for professional, store-like business</li>
<li><a class="reference external" href="https://matomo.org/log-analytics/">Matomo</a>: <a class="reference external" href="https://en.wikipedia.org/wiki/Matomo_(software)">interesting</a>, yet a bit too complete / integrated; requires a dedicated database</li>
<li><a class="reference external" href="https://goaccess.io/GoAccess">GoAccess</a>: a good candidate, almost no dependency, actively maintained, beautiful reports, supports GeoLite2, but more real-time oriented (more like a web monitor) and with less in-depth metrics</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/AWStats">AWStats</a>: old yet still maintained, real community-based open-source software, very complete, probably the most relevant in the list, whose code is apparently now maintained <a class="reference external" href="https://github.com/eldy/awstats">here</a></li>
</ul>
<p>So we finally retained <a class="reference external" href="https://awstats.sourceforge.io/">AWStats</a>.</p>
</div>
<div class="section" id="log-format">
<h2><a class="toc-backref" href="#toc-entry-80">Log Format</a></h2>
<p>The most suitable log format that we spotted (see <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_faq.html#PERSONALIZEDLOG">[1]</a> and <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_config.html#LogFormat">[2]</a> for more information) is named &quot;<em>NCSA combined with several virtualhostname sharing same log file</em>&quot;.</p>
<p>Its correct definition is exactly:</p>
<pre class="literal-block">
LogFormat=&quot;%virtualname %host %other %logname %time2 %methodurl %code %bytesd %refererquot %uaquot&quot;
</pre>
<p>For example:</p>
<pre class="literal-block">
virtualserver1 62.161.78.73 - - 2020-02-02 01:59:02 &quot;GET /page.html HTTP/1.1&quot; \
200 1234 &quot;http://www.from.com/from.htm&quot; &quot;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&quot;
</pre>
<p>This format is better than the &quot;Apache combined logs&quot; (combined, not common) log format, as containing the virtual host (important); note that for this second format, precisely named &quot;<em>Apache or Lotus Notes/Domino native combined log format (NCSA combined/XLF/ELF log format)</em>&quot; would be defined as:</p>
<pre class="literal-block">
LogFormat=&quot;%host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot
</pre>
<p>For example:</p>
<pre class="literal-block">
62.161.78.73 - - [dd/mmm/yyyy:hh:mm:ss +0x00] &quot;GET /page.html HTTP/1.1&quot; \
200 1234 &quot;http://www.from.com/from.htm&quot; &quot;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&quot;
</pre>
<p>Field descriptions for this last format: <a class="reference external" href="https://en.wikipedia.org/wiki/Common_Log_Format">[1]</a>, <a class="reference external" href="https://httpd.apache.org/docs/current/logs.html#accesslog">[2]</a>, <a class="reference external" href="http://fileformats.archiveteam.org/wiki/Combined_Log_Format">[3]</a>, <a class="reference external" href="https://stackoverflow.com/questions/9234699/understanding-apaches-access-log">[4]</a>.</p>
<p>See also regarding Awstats log formats: <a class="reference external" href="https://www.internetofficer.com/awstats/log-format/">[1]</a>, <a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_faq.html#LOGFORMAT">[2]</a>, <a class="reference external" href="https://wiki.archlinux.org/index.php/AWStats">[3]</a>.</p>
<p>In all these cases, the log separator is a single space (hence <tt class="docutils literal">LogSeparator=&quot; &quot;</tt>).</p>
</div>
<div class="section" id="awstats-management">
<h2><a class="toc-backref" href="#toc-entry-81">Awstats Management</a></h2>
<div class="section" id="awstats-installation">
<h3><a class="toc-backref" href="#toc-entry-82">Awstats Installation</a></h3>
<p>On Arch Linux, one should follow <a class="reference external" href="https://wiki.archlinux.org/index.php/AWStats">these guidelines</a> (example for version 7.8):</p>
<pre class="code bash literal-block">
$<span class="w"> </span>pacman<span class="w"> </span>-Sy<span class="w"> </span>--needed<span class="w"> </span>awstats
</pre>
<p>Awstats will then be installed in <tt class="docutils literal">/usr/share</tt>, including the <tt class="docutils literal"><span class="pre">/usr/share/webapps/awstats/cgi-bin/awstats.pl</span></tt> script and the <tt class="docutils literal">/usr/share/webapps/awstats/icon/</tt> directory.</p>
<p>Some permission fixes (to be done as root) might be needed first:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>chmod<span class="w"> </span>+r<span class="w"> </span>/usr/share/webapps/awstats/icon/os/*
</pre>
</div>
<div class="section" id="awstats-configuration">
<h3><a class="toc-backref" href="#toc-entry-83">Awstats Configuration</a></h3>
<p>Log analysis will be triggered periodically by the US-Web server rather than on-demand via CGI Perl scripts, and its result, i.e. the web pages generated from the access logs, will be available in the meta website (ex: <tt class="docutils literal">mymeta.foobar.org</tt>; refer to <a class="reference internal" href="#auto-generated-meta-website">Auto-generated Meta Website</a> for more information).</p>
<p>More precisely, and as already mentioned, in the US-Web log directory (see <tt class="docutils literal">us_web_log_dir</tt>), dedicated access and error log files will be generated for each known virtual host. For example the accesses to a <tt class="docutils literal">baz.foobar.org</tt> virtual host will be written by the US-Web server in a corresponding <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt> file.</p>
<p>At server start-up, the US-Web meta module (<tt class="docutils literal">us_web_meta</tt>) will have generated a suitable Awstats configuration file (namely <tt class="docutils literal">awstats.baz.foobar.org.conf</tt>) that will trigger the generation of the corresponding static web pages (<tt class="docutils literal">awstats.baz.foobar.org.*</tt>, notably <tt class="docutils literal">awstats.baz.foobar.org.html</tt>) in the web root of the meta website.</p>
<p>These configuration files are now placed in <tt class="docutils literal">/usr/local/etc/awstats</tt> (they were previously in the <tt class="docutils literal">conf</tt> subdirectory of the root specified in <tt class="docutils literal">us_web_app_base_dir</tt>).</p>
<p>Indeed, if starting from version 7.8, Awstats allows these configuration files to be specified as absolute paths, its previous versions:</p>
<ul class="simple">
<li>either required such configuration files to be in <tt class="docutils literal">/etc/awstats</tt>, <tt class="docutils literal">/usr/local/etc/awstats</tt>, <tt class="docutils literal">/etc</tt> or in the same directory as the <tt class="docutils literal">awstats.pl</tt> script file</li>
<li>or, if the configuration files could be specified as absolute paths, the generated pages would then include some faulty links because of that</li>
</ul>
<p>US-Web retained the most controllable, less &quot;system&quot; directory, <tt class="docutils literal">/usr/local/etc/awstats</tt>. All these locations are mostly root-only, whereas the US-Web server is designed to run as a normal, non-privileged user and is to generate there these Awstats configuration files.</p>
<p>Such a target directory shall thus be created beforehand, and made writable by the user specified in <tt class="docutils literal">us_web_username</tt>.</p>
<p>Each virtual host (say: <tt class="docutils literal">baz.foobar.org</tt>) will have its configuration file deriving from <tt class="docutils literal">priv/conf/awstats.template.conf</tt>, where the following patterns will be replaced by relevant ones (through keyword-based replacements):</p>
<ul class="simple">
<li><tt class="docutils literal">US_WEB_VHOST_LOG_FILE</tt> to become the full path to the corresponding access log (ex: <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log</span></tt>, in <tt class="docutils literal">us_web_log_dir</tt>)</li>
<li><tt class="docutils literal">US_WEB_VHOST_DOMAIN</tt> to become the virtual host domain (ex: <tt class="docutils literal">baz.foobar.org</tt>)</li>
<li><tt class="docutils literal">US_WEB_LOG_ANALYSIS_DATA_DIR</tt> to become the directory in which the working data (ex: state files) of the web analyzer (here Awstats) shall be written</li>
</ul>
<p>Awstats icons are copied to the <tt class="docutils literal">icon</tt> directory at the root of the meta website.</p>
<p>The Awstats database, typically located in <tt class="docutils literal"><span class="pre">/var/local/us-web/data</span></tt>, will be updated once an access log file will be rotated; just after, this log file will be compressed and archived under a relevant filename, such as <tt class="docutils literal"><span class="pre">access-for-baz.foobar.org.log.2020-2-1-at-19h-48m-12s.xz</span></tt>.</p>
</div>
<div class="section" id="awstats-troubleshooting">
<h3><a class="toc-backref" href="#toc-entry-84">Awstats Troubleshooting</a></h3>
<p>Various issues may prevent log reports to be available.</p>
<p>Let's try with a real US-Web uncompressed log file first (ex: <tt class="docutils literal">xz <span class="pre">-d</span> <span class="pre">access-vhost-catchall.log.test.xz</span></tt>), supposing that it corresponds to a <tt class="docutils literal"><span class="pre">my-test</span></tt> virtual host).</p>
<p>Then configure Awstats (ex: through a <tt class="docutils literal"><span class="pre">/usr/local/etc/awstats/awstats.my-test.conf</span></tt> file) to process that log file; for that, run on that host:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>perl<span class="w"> </span>/usr/share/awstats/tools/awstats_configure.pl
</pre>
<p>Then, to debug the whole process, use, as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/usr/share/webapps/awstats/cgi-bin/awstats*.txt<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="p">;</span><span class="w">
   </span><span class="nv">LANG</span><span class="o">=</span>C<span class="w"> </span>/usr/share/webapps/awstats/cgi-bin/awstats.pl<span class="w">
     </span>-config<span class="o">=</span>my-test<span class="w"> </span>-showdropped
</pre>
<p>Most problems should become visible then.</p>
<p>To do the same for a series of web logs in the context of US-Web, one can have them analysed first thanks to:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/etc/awstats/awstats-*conf<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="p">;</span><span class="w">
   </span><span class="nv">LANG</span><span class="o">=</span>C<span class="w"> </span>/usr/share/webapps/awstats/cgi-bin/awstats.pl<span class="w">
     </span>-config<span class="o">=</span><span class="nv">$f</span><span class="w"> </span>-update<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre>
<p>Then all web reports can be generated manually with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/etc/awstats/awstats-*conf<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="p">;</span><span class="w">
   </span><span class="nv">LANG</span><span class="o">=</span>C<span class="w"> </span>/usr/share/webapps/awstats/cgi-bin/awstats.pl<span class="w">
     </span>-config<span class="o">=</span><span class="nv">$f</span><span class="w"> </span>-output<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre>
</div>
</div>
<div class="section" id="geolocation-with-awstats">
<h2><a class="toc-backref" href="#toc-entry-85">Geolocation with Awstats</a></h2>
<p><a class="reference external" href="https://awstats.sourceforge.io/docs/awstats_contrib.html">Multiple plugins</a> exist for that.</p>
<p><a class="reference external" href="https://github.com/eldy/awstats/issues/86">Apparently</a>, none is able to load the new GeoIP2 format (see also <a class="reference external" href="https://github.com/eldy/awstats/issues/114">this</a>).</p>
<p>As a consequence: topic dropped for the moment.</p>
</div>
</div>
<div class="section" id="managing-public-key-certificates">
<h1><a class="toc-backref" href="#toc-entry-86">Managing Public-Key Certificates</a></h1>
<p>The goal here is to benefit from suitable certificates, notably (but not only) for https (typically running on TCP port 443, multiplexed thanks to SNI, i.e. <a class="reference external" href="ServerNameIndication">Server Name Indication</a> <a class="footnote-reference" href="#footnote-11" id="footnote-reference-11">[11]</a>), by automatically (and freely) generating, using and renewing them appropriately, for each of the virtual hosts managed by the US-Web server.</p>
<table class="docutils footnote" frame="void" id="footnote-11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-11">[11]</a></td><td>As a consequence, the specific visited virtual hostname (e.g. <tt class="docutils literal">baz</tt>, in  <tt class="docutils literal">baz.foobar.org</tt>) is <em>not</em> encrypted, and thus might be known of an eavesdropper.</td></tr>
</tbody>
</table>
<div class="section" id="x-509-certificates">
<h2><a class="toc-backref" href="#toc-entry-87">X.509 Certificates</a></h2>
<p>The certificates managed here are <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> TLS certificates, which can be seen as standard containers of a public key together with an identity and a hierarchical, potentially trusted <em>Certificate Authority</em> (CA) that signed them <a class="footnote-reference" href="#footnote-12" id="footnote-reference-12">[12]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-12">[12]</a></td><td>The X.509 standard also includes certificate revocation lists and the algorithm to sign recursively certificates from a trust anchor.</td></tr>
</tbody>
</table>
<p>Such certificates can be used for any protocol or standard, and <a class="reference external" href="https://en.wikipedia.org/wiki/X.509#Major_protocols_and_standards_using_X.509_certificates">many</a> do so - including of course TLS and, to some extent, SSH. Being necessary to the https scheme, they are used here.</p>
</div>
<div class="section" id="let-s-encrypt">
<h2><a class="toc-backref" href="#toc-entry-88">Let's Encrypt</a></h2>
<p>US-Web relies on <a class="reference external" href="https://letsencrypt.org">Let's Encrypt</a>, a non-profit certificate authority from which one can obtain mono-domain (possibly with SANs - <em>Subject Alternative Names</em>; and now wildcard domains) X.509 certificates <a class="footnote-reference" href="#footnote-13" id="footnote-reference-13">[13]</a> for free, valid for 90 days and that can be renewed as long as needed.</p>
<table class="docutils footnote" frame="void" id="footnote-13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-13">[13]</a></td><td><tt class="docutils literal">Let's Encrypt</tt> provides <em>Domain Validation</em> (DV) certificates, but neither more general <em>Organization Validation</em> (OV) nor <em>Extended Validation</em> (EV).</td></tr>
</tbody>
</table>
<p>Let's Encrypt follows the ACME (<em>Automatic Certificate Management Environment</em>) protocol. For mono-domain validation, it relies on an <tt class="docutils literal"><span class="pre">http-01</span></tt> challenge, with an agent running on the server bound to the domain for which a certificate is requested.</p>
<p>This agent generates first a RSA key pair in order to interact with the Let’s Encrypt certificate authority, so that it can prove through received challenge(s) that it is bound to the claimed domain / virtual host (e.g. <tt class="docutils literal">baz.foobar.org</tt>) and has the control to the private key corresponding to the public one that it transmitted to the CA.</p>
<p>Generally this involves for that agent to receive a &quot;random&quot; piece of data from the CA (the nonce), to sign it with said private key, and to make the resulting answer to the challenges available (as tokens) through the webserver at a relevant URL that corresponds to the target virtual host and to a well-known path (e.g. <tt class="docutils literal"><span class="pre">http://baz.foobar.org/.well-known/acme-challenge/xxx</span></tt>).</p>
<p>Refer to <a class="reference external" href="https://letsencrypt.org/how-it-works/">this page</a> for more information; the overall process is <a class="reference external" href="https://ietf-wg-acme.github.io/acme/draft-ietf-acme-acme.html#rfc.section.4">explained here</a> and in <a class="reference external" href="https://www.rfc-editor.org/rfc/rfc8555.html">this RFC</a>.</p>
<p>As for wildcard certificates, the ACME protocol relies on <tt class="docutils literal"><span class="pre">dns-01</span></tt> challenges, which require the certificate requester to prove that it controls the DNS of the target domain, by updating its zone entries according to information chosen by the ACME server of the certificate issuer.</p>
</div>
<div class="section" id="us-web-mode-of-operation">
<h2><a class="toc-backref" href="#toc-entry-89">US-Web Mode of Operation</a></h2>
<div class="section" id="for-mono-domain-certificates">
<h3><a class="toc-backref" href="#toc-entry-90">For mono-domain certificates</a></h3>
<p>Rather than using a standalone ACME agent such as the standard one, <tt class="docutils literal">certbot</tt>, we prefer driving everything from Erlang, for a better control and periodical renewal (see the scheduler provided by <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USScheduler.erl">US-Common</a>).</p>
<p>Various libraries exist for that in Erlang, the most popular one being probably <a class="reference external" href="https://github.com/gbour/letsencrypt-erlang">letsencrypt-erlang</a>; we <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang">forked</a> it (and named it LEEC, for <em>Let's Encrypt Erlang with Ceylan</em>, to tell them apart), in order notably to support newer Erlang versions and to allow for <em>concurrent</em> certificate renewals (knowing that one certificate per virtual host will be needed).</p>
<p>Three <a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang#action-modes">action modes</a> can be considered to interact with the Let's Encrypt infrastructure and to solve its challenges. As the US-Web server is itself a webserver, the <tt class="docutils literal">slave</tt> mode is the most relevant here.</p>
<p>For that, the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_letsencrypt_handler.erl">us_web_letsencrypt_handler</a> has been introduced by US-Web.</p>
<p>By default, thanks to the US-Web scheduler, certificates (which last for up to 90 days and cannot be renewed before 60 days are elapsed) will be renewed every 75 days, with some random jitter added to avoid synchronising too many certificate requests when having multiple virtual hosts - as they are done concurrently, if not SANs are used.</p>
</div>
<div class="section" id="for-wildcard-certificates">
<h3><a class="toc-backref" href="#toc-entry-91">For wildcard certificates</a></h3>
<p>US-Web relies here also as much as possible on LEEC (see <a class="reference external" href="https://leec.esperide.org/#wildcard-domain-certificates-with-the-dns-01-challenge">this section</a>), even if, at least currently, the standard <tt class="docutils literal">certbot</tt> is used internally; here US-Web, thanks to its US-Common Scheduler, acts mostly like an integrated crontab on steroids.</p>
</div>
</div>
<div class="section" id="settings">
<h2><a class="toc-backref" href="#toc-entry-92">Settings</a></h2>
<p>Various <a class="reference external" href="https://crypto.stackexchange.com/questions/43697/what-is-the-difference-between-pem-csr-key-and-crt-and-other-such-file-ext">types of files</a> are involved in the process:</p>
<ul class="simple">
<li>a <tt class="docutils literal">.key</tt> file contains any type of key, here this is a RSA private key; typically <tt class="docutils literal"><span class="pre">letsencrypt-agent.key-I</span></tt>, where <tt class="docutils literal">I</tt> is an increasing integer, will contain the PEM RSA private key generated by the certificate agent <tt class="docutils literal">I</tt> on behalf of the US-Webserver (so that it can sign the nonces provided by Let's Encrypt, and thus prove that it controls the corresponding key pair); for a <tt class="docutils literal">baz.foobar.org</tt> virtual host, the <tt class="docutils literal">baz.foobar.org.key</tt> file will be generated and used (another PEM RSA private key)</li>
<li>a <tt class="docutils literal">.pem</tt> (<em>Privacy-enhanced Electronic Mail</em>) file just designates a Base64-encoded content with header and footer lines; here it stores an ASN.1 (precisely a Base64-encoded DER) certificate</li>
<li><tt class="docutils literal">.csr</tt> corresponds to a PKCS#10 <em>Certificate Signing Request</em>; it contains information (encoded as PEM or DER) such as the public key and common name required by a Certificate Authority to create and sign a certificate for the requester (e.g. <tt class="docutils literal">baz.foobar.org.csr</tt> will be a PEM certificate request)</li>
<li><tt class="docutils literal">.crt</tt> is the actual certificate (encoded as PEM or DER as well), usually a X509v3 one (e.g. <tt class="docutils literal">baz.foobar.org.crt</tt>); it contains the public key and also much more information (most importantly the signature by the Certificate Authority over the data and public key, of course)</li>
</ul>
<p>We must determine:</p>
<ul class="simple">
<li>the size of the RSA key of the agent; the higher the better, hence: 4096</li>
<li>where the certificate-related files will be stored: in the <tt class="docutils literal">certificates</tt> subdirectory of the US-Web data directory, i.e. the one designated by the <tt class="docutils literal">us_web_data_dir</tt> key in US-Web's configuration file (hence it is generally the <tt class="docutils literal"><span class="pre">/var/local/us-web/us-web-data</span></tt> or <tt class="docutils literal"><span class="pre">/opt/universal-server/us_web-x.y.z/us-web-data</span></tt> directory)</li>
</ul>
<p>The precise support for X.509 certificates (use, and possibly generation and renewal) is determined by the <tt class="docutils literal">certificate_support</tt> key of the US-Web configuration file:</p>
<ul class="simple">
<li>if not specified, or set to <tt class="docutils literal">no_certificates</tt>, then no certificate will be used, and thus no https support will be available</li>
<li>if set to <tt class="docutils literal">use_existing_certificates</tt>, then relevant certificates are supposed to pre-exist, and will be used as are (with no automatic renewal thereof done by US-Web)</li>
<li>if set to <tt class="docutils literal">renew_certificates</tt>, then relevant certificates will be generated at start-up (none re-used), used since then, and will be automatically renewed whenever appropriate</li>
</ul>
<p>Another setting applies, determined this time by the <tt class="docutils literal">certificate_mode</tt> key, whose associated value (which matters iff <tt class="docutils literal">certificate_support</tt> has been set to <tt class="docutils literal">renew_certificates</tt>) is either <tt class="docutils literal">development</tt> or <tt class="docutils literal">production</tt> (the default). In the former case, the <a class="reference external" href="https://letsencrypt.org/docs/staging-environment/">staging ACME parameters</a> will apply (implying relaxed limits, yet resulting in the obtained certificates to be issued by a fake, test CA), whereas the latter case will imply the use of the <a class="reference external" href="https://letsencrypt.org/docs/rate-limits/">production</a> ones.</p>
<p>When a proper certificate is available and enabled, the US webserver promotes automatically any HTTP request into a HTTPS one, see the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_port_forwarder.erl">us_web_port_forwarder</a> module for that (based on relevant routing rules).</p>
<p>Standard, basic firewall settings are sufficient to enable interactions of US-Web (through LEEC) with Let's Encrypt, as it is the US-Web agent that initiates the TCP connection to Let's Encrypt, which is to check the challenge(s) through regular http accesses done to the webserver expected to be available at the domain of interest.</p>
<p>The US-Web server must be able to write in the web content tree, precisely to write files in the <tt class="docutils literal"><span class="pre">well-known/acme-challenge/</span></tt> subdirectory of the web root.</p>
</div>
<div class="section" id="https-troubleshooting">
<h2><a class="toc-backref" href="#toc-entry-93">HTTPS Troubleshooting</a></h2>
<p>If trying to connect with the https scheme whereas it has not been enabled, <tt class="docutils literal">wget <span class="pre">https://baz.foobar.org/</span> <span class="pre">-O</span> -</tt> is to report <tt class="docutils literal">Connection refused</tt>.</p>
</div>
</div>
<div class="section" id="planned-enhancements">
<h1><a class="toc-backref" href="#toc-entry-94">Planned Enhancements</a></h1>
<div class="section" id="reverse-proxy">
<h2><a class="toc-backref" href="#toc-entry-95">Reverse Proxy</a></h2>
<div class="section" id="purpose">
<h3><a class="toc-backref" href="#toc-entry-96">Purpose</a></h3>
<p>The goal of a <a class="reference external" href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a> is to have a (proxy) server seamlessly (read: without doing a HTTP forward - thus with unchanged URLs from the point of view of the client) redirect incoming traffic to other &quot;proxied&quot; webservers (possibly other US-Web instances) running on other hosts and/or ports.</p>
<p>A typical use case here <a class="footnote-reference" href="#footnote-14" id="footnote-reference-14">[14]</a> is having an US-Web instance serve a domain name of interest (e.g. <tt class="docutils literal">foo.org</tt>) whereas more than one of its virtual hosts are <a class="reference internal" href="#nitrogen-based">Nitrogen-based</a>, knowing that no two of such virtual hosts shall be executed by the same (Erlang) VM (as notably their Nitrogen page modules would clash).</p>
<table class="docutils footnote" frame="void" id="footnote-14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-14">[14]</a></td><td><p class="first">The main other uses cases happen when wanting to:</p>
<ul class="last simple">
<li>run a webserver on a non-privileged port</li>
<li>balance the load between multiple actual servers</li>
</ul>
</td></tr>
</tbody>
</table>
<p>For example a reverse proxy could ensure that connecting to the <tt class="docutils literal"><span class="pre">https://my-server.foo.org</span></tt> (virtual) host is transparently forwarded to <tt class="docutils literal"><span class="pre">http://foo.org:8150</span></tt> (a port which could be filtered by the local firewall - thus with no possible direct access from the outside network).</p>
<p>So this latter, autonomous webserver <tt class="docutils literal"><span class="pre">my-server</span></tt> instance would run thanks to its own VM on TCP port 8150, yet would only by reachable by connecting to the former, centralising webserver, which would act as a reverse proxy. As many other virtual hosts as wanted could be declared (e.g. as <tt class="docutils literal"><span class="pre">https://my-other-server.foo.org</span></tt>) to the reverse proxy, each pointing then to its own actual webserver instance (e.g. <tt class="docutils literal"><span class="pre">http://foo.org:8151</span></tt>).</p>
</div>
<div class="section" id="challenges">
<h3><a class="toc-backref" href="#toc-entry-97">Challenges</a></h3>
<p>The HTTP/HTTPS routing shall be fully transparent, notably not breaking any connectivity (e.g. regarding Comet, AJAX, Websockets) and complying with the proper use of the underlying protocols (e.g. so that browsers do not interpret a proxying as the spoofing of SSL certificates).</p>
</div>
<div class="section" id="implementations">
<h3><a class="toc-backref" href="#toc-entry-98">Implementations</a></h3>
<p>There are many solutions in order to obtain a reverse proxy; it may be done:</p>
<ul class="simple">
<li>directly at the firewall level, typically by <a class="reference external" href="https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/">configuring iptables accordingly</a></li>
<li>thanks to nginx, as a <a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">NGINX Reverse Proxy</a> (probably the most popular option)</li>
<li>at the Erlang-level: see for example <a class="reference external" href="https://github.com/benoitc/cowboy_revproxy">cowboy_revproxy</a>, <a class="reference external" href="https://github.com/skruger/Surrogate">Surrogate</a> or <a class="reference external" href="https://github.com/erlyaws/yaws/blob/master/src/yaws_revproxy.erl">yaws_revproxy</a></li>
</ul>
</div>
<div class="section" id="us-web-reverse-proxy">
<h3><a class="toc-backref" href="#toc-entry-99">US-Web Reverse Proxy</a></h3>
<p>For better control US-Web will implement its own reverse proxy.</p>
<p>For that it will automatically modify header fields (e.g. <tt class="docutils literal">Host</tt>, <tt class="docutils literal">Connection</tt>, <tt class="docutils literal"><span class="pre">X-Real-IP</span></tt>; the source IP could also by set) in the proxied requests.</p>
<p>The responses from proxied servers could be buffered until they are fully received - to better manage slower clients - yet, as here the proxied servers may offer rather interactive uses, buffering may not be desirable.</p>
</div>
</div>
</div>
<div class="section" id="support">
<h1><a class="toc-backref" href="#toc-entry-100">Support</a></h1>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be reported to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/issues">issues</a>) or directly at the email address mentioned at the beginning of this document.</p>
</div>
<div class="section" id="please-react">
<h1><a class="toc-backref" href="#toc-entry-101">Please React!</a></h1>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h1><a class="toc-backref" href="#toc-entry-102">Ending Word</a></h1>
<p>Have fun with the Universal Webserver!</p>
<p><span class="raw-html"><center><img src="us-web-title.png" id="responsive-image-medium"></img></center></span>
</p>
<p><span class="raw-html"><a name="universal-webserver_bottom"></a></span></p>
</div>
</div>
</body>
</html>
